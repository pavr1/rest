<!-- Inventory Variants Page Partial -->
<style>
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .page-title { font-family: Arial, sans-serif; font-size: 1.75rem; margin: 0; }
    .data-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-light); overflow: hidden; }
    .data-card-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; }
    .data-table { width: 100%; margin: 0; }
    .data-table th { background: #f8f9fa; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid #e9ecef; }
    .data-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #e9ecef; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .action-btns { display: flex; gap: 0.5rem; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85rem; }
    .empty-state, .loading-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .filter-section { margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius); }
</style>

<div class="page-header">
    <h1 class="page-title">Inventory Variants</h1>
    <button class="btn btn-primary" id="addBtn"><i class="fas fa-plus me-2"></i>Add Variant</button>
</div>

<div class="filter-section">
    <div class="row">
        <div class="col-md-4">
            <label class="form-label">Filter by Category</label>
            <select class="form-select" id="categoryFilter">
                <option value="">Select a Category</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Filter by Sub-Category</label>
            <select class="form-select" id="subCategoryFilter" disabled>
                <option value="">Select a category first</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Search by Name</label>
            <input type="text" class="form-control" id="nameFilter" placeholder="Type to search...">
        </div>
    </div>
</div>

<div class="data-card">
    <div id="tableContainer">
        <div class="loading-state d-none" id="loadingState">
            <div class="spinner-border text-primary mb-3"></div>
            <p>Loading variants...</p>
        </div>
        <div class="empty-state" id="selectCategoryState">
            <i class="fas fa-filter"></i>
            <h5>Select a category to view variants</h5>
            <p>Use the filters above to browse inventory variants.</p>
        </div>
        <div class="empty-state d-none" id="emptyState">
            <i class="fas fa-boxes"></i>
            <h5>No inventory variants yet</h5>
            <p>Create your first inventory variant.</p>
        </div>
        <table class="data-table d-none" id="dataTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Sub-Category</th>
                    <th>Status</th>
                    <th width="120">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="formModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Inventory Variant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="dataForm">
                <div class="modal-body">
                    <input type="hidden" id="itemId">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="itemCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sub-Category <span class="text-danger">*</span></label>
                        <select class="form-select" id="itemSubCategory" required>
                            <option value="">Select a category first</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="itemDescription" rows="2" placeholder="Optional description..."></textarea>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="itemIsActive" checked>
                        <label class="form-check-label" for="itemIsActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
    let items = [];
    let subCategories = [];
    let modal = null;
    let editingId = null;
    let categories = [];

    // Choices instances for cleanup
    let categoryFilterChoice = null;
    let subCategoryFilterChoice = null;
    let itemCategoryChoice = null;
    let itemSubCategoryChoice = null;

    function init() {
        console.log('Initializing inventory variants page...');
        modal = new bootstrap.Modal(document.getElementById('formModal'));
        setupEventListeners();
        loadCategories();
        // Don't load sub-categories or data at init - wait for category selection
        showSelectCategory();
    }

    function initSearchableSelects() {
        // Initialize filter dropdowns
        categoryFilterChoice = SearchableSelect.init('#categoryFilter', {
            searchPlaceholderValue: 'Search categories...',
            placeholderValue: 'Select a Category'
        });
        subCategoryFilterChoice = SearchableSelect.init('#subCategoryFilter', {
            searchPlaceholderValue: 'Search sub-categories...',
            placeholderValue: 'Select a category first'
        });
        
        // Initialize modal dropdowns  
        itemCategoryChoice = SearchableSelect.init('#itemCategory', {
            searchPlaceholderValue: 'Search categories...',
            placeholderValue: 'Select Category'
        });
        itemSubCategoryChoice = SearchableSelect.init('#itemSubCategory', {
            searchPlaceholderValue: 'Search sub-categories...',
            placeholderValue: 'Select a category first'
        });
    }

    function setupEventListeners() {
        document.getElementById('addBtn')?.addEventListener('click', () => openModal());
        document.getElementById('refreshBtn')?.addEventListener('click', () => {
            const categoryId = document.getElementById('categoryFilter')?.value;
            if (categoryId) {
                loadData();
            }
        });
        document.getElementById('categoryFilter')?.addEventListener('change', () => {
            const categoryId = document.getElementById('categoryFilter')?.value;
            document.getElementById('nameFilter').value = ''; // Clear name filter
            if (categoryId) {
                // When category is selected, load sub-categories and load all variants for that category
                loadSubCategoriesForFilter();
            } else {
                // Category deselected - reset sub-category dropdown and show select message
                subCategories = [];
                SearchableSelect.setChoices('#subCategoryFilter', [{ value: '', label: 'Select a category first', selected: true }]);
                SearchableSelect.setEnabled('#subCategoryFilter', false);
                showSelectCategory();
            }
        });
        document.getElementById('subCategoryFilter')?.addEventListener('change', () => {
            document.getElementById('nameFilter').value = ''; // Clear name filter
            loadData();
        });
        
        // Debounced name filter
        let nameFilterTimeout = null;
        document.getElementById('nameFilter')?.addEventListener('input', () => {
            clearTimeout(nameFilterTimeout);
            nameFilterTimeout = setTimeout(() => renderTable(), 300);
        });
        
        document.getElementById('itemCategory')?.addEventListener('change', () => {
            // Clear any previously selected sub-category when category changes
            document.getElementById('itemSubCategory').value = '';
            loadSubCategoriesForCategory();
        });
        document.getElementById('dataForm')?.addEventListener('submit', (e) => { e.preventDefault(); save(); });
    }

    async function loadCategories() {
        console.log('Loading categories for variants page...');
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.inventoryCategories, { headers: { 'Authorization': `Bearer ${token}` } });
            console.log('Categories response status:', resp.status);

            if (!resp.ok) {
                console.error('Failed to fetch categories');
                return;
            }

            const result = await resp.json();
            categories = result.data?.categories || result.data?.items || result.data || [];
            console.log('Loaded categories:', categories);

            // Populate category filter
            const categoryFilter = document.getElementById('categoryFilter');
            categoryFilter.innerHTML = '<option value="">Select a Category</option>';
            categories.forEach(cat => {
                categoryFilter.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
            });

            // Populate modal category select
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
            });

            console.log('Categories dropdown populated');
            
            // Initialize searchable selects after populating
            initSearchableSelects();
        } catch (e) {
            console.error('Failed to load categories:', e);
        }
    }

    async function loadSubCategoriesForFilter() {
        try {
            const token = window.authService.getToken();
            const categoryId = document.getElementById('categoryFilter')?.value;
            
            if (!categoryId) {
                return;
            }
            
            const url = `${CONFIG.MENU.inventorySubCategories}?category_id=${categoryId}`;
            
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) return;
            const result = await resp.json();
            subCategories = result.data?.sub_categories || result.data?.items || result.data || [];

            // Build choices array for Choices.js
            const choices = [{ value: '', label: 'All Sub-Categories', selected: true }];
            subCategories.forEach(subCat => {
                choices.push({ value: subCat.id, label: subCat.name });
            });
            
            SearchableSelect.setChoices('#subCategoryFilter', choices);
            SearchableSelect.setEnabled('#subCategoryFilter', true);
            
            // Load all variants for this category (no sub-category filter yet)
            loadData();
        } catch (e) {
            console.error('Failed to load sub-categories for filter:', e);
        }
    }

    async function loadSubCategoriesForCategory() {
        const categoryId = document.getElementById('itemCategory').value;

        if (!categoryId) {
            SearchableSelect.setChoices('#itemSubCategory', [{ value: '', label: 'Select a category first', selected: true }]);
            return;
        }

        // Show loading state
        SearchableSelect.setChoices('#itemSubCategory', [{ value: '', label: 'Loading...', selected: true }]);

        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.inventorySubCategories}?category_id=${categoryId}`, { headers: { 'Authorization': `Bearer ${token}` } });

            if (!resp.ok) {
                SearchableSelect.setChoices('#itemSubCategory', [{ value: '', label: 'Failed to load', selected: true }]);
                return;
            }

            const result = await resp.json();
            const categorySubCategories = result.data?.sub_categories || result.data?.items || result.data || [];

            // Build choices array
            const choices = [{ value: '', label: 'Select Sub-Category', selected: true }];
            if (categorySubCategories.length === 0) {
                choices[0].label = 'No sub-categories available';
            } else {
                categorySubCategories.forEach(subCat => {
                    choices.push({ value: subCat.id, label: subCat.name });
                });
            }
            
            SearchableSelect.setChoices('#itemSubCategory', choices);
        } catch (e) {
            console.error('Failed to load sub-categories for category:', e);
            SearchableSelect.setChoices('#itemSubCategory', [{ value: '', label: 'Error loading', selected: true }]);
            itemSubCategoryChoice = SearchableSelect.refresh('#itemSubCategory');
        }
    }

    async function loadData() {
        const categoryId = document.getElementById('categoryFilter').value;
        const subCategoryId = document.getElementById('subCategoryFilter').value;
        
        // Don't load if no category is selected
        if (!categoryId) {
            showSelectCategory();
            return;
        }
        
        showLoading();
        try {
            const token = window.authService.getToken();
            let url = CONFIG.MENU.inventoryVariants;
            
            if (subCategoryId) {
                // Filter by specific sub-category
                url += `?sub_category_id=${subCategoryId}`;
            } else {
                // Filter by category (all sub-categories for this category)
                url += `?category_id=${categoryId}`;
            }

            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            const result = await resp.json();
            items = result.data?.variants || result.data?.items || result.data || [];
            renderTable();
        } catch (e) {
            Swal.fire('Error', 'Failed to load inventory variants', 'error');
            showEmpty();
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const table = document.getElementById('dataTable');
        const empty = document.getElementById('emptyState');
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('selectCategoryState').classList.add('d-none');

        // Filter by name
        const nameFilter = document.getElementById('nameFilter').value.toLowerCase().trim();
        const filteredItems = nameFilter 
            ? items.filter(item => item.name.toLowerCase().includes(nameFilter))
            : items;

        if (!filteredItems.length) { table.classList.add('d-none'); empty.classList.remove('d-none'); return; }

        empty.classList.add('d-none');
        table.classList.remove('d-none');
        tbody.innerHTML = filteredItems.map(item => {
            const subCategory = subCategories.find(sc => sc.id === item.stock_sub_category_id);
            const statusBadge = item.is_active !== false 
                ? '<span class="badge bg-success">Active</span>' 
                : '<span class="badge bg-secondary">Inactive</span>';
            return `
                <tr>
                    <td><strong>${escapeHtml(item.name)}</strong></td>
                    <td>${escapeHtml(item.description || '-')}</td>
                    <td>${subCategory ? escapeHtml(subCategory.name) : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline-info btn-action" onclick="window.inventoryVarPage.stockCount('${item.id}')" title="Stock Count"><i class="fas fa-warehouse"></i></button>
                            <button class="btn btn-outline-primary btn-action" onclick="window.inventoryVarPage.edit('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger btn-action" onclick="window.inventoryVarPage.delete('${item.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function showLoading() { 
        document.getElementById('loadingState').classList.remove('d-none'); 
        document.getElementById('selectCategoryState').classList.add('d-none');
        document.getElementById('emptyState').classList.add('d-none'); 
        document.getElementById('dataTable').classList.add('d-none'); 
    }
    function showEmpty() { 
        document.getElementById('loadingState').classList.add('d-none'); 
        document.getElementById('selectCategoryState').classList.add('d-none');
        document.getElementById('emptyState').classList.remove('d-none'); 
        document.getElementById('dataTable').classList.add('d-none'); 
    }
    function showSelectCategory() {
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('selectCategoryState').classList.remove('d-none');
        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('dataTable').classList.add('d-none');
    }

    function openModal(item = null) {
        editingId = item?.id || null;
        document.getElementById('modalTitle').textContent = item ? 'Edit Inventory Variant' : 'Add Inventory Variant';
        document.getElementById('itemId').value = item?.id || '';
        document.getElementById('itemName').value = item?.name || '';

        // Find the sub-category to get the category
        if (item?.stock_sub_category_id) {
            const subCategory = subCategories.find(sc => sc.id === item.stock_sub_category_id);
            if (subCategory) {
                // Set category value using Choices
                SearchableSelect.setValue('#itemCategory', subCategory.stock_category_id || '');
                // Load sub-categories for this category, then set the selected one
                loadSubCategoriesForCategory().then(() => {
                    SearchableSelect.setValue('#itemSubCategory', item.stock_sub_category_id);
                });
            } else {
                SearchableSelect.setValue('#itemCategory', '');
                document.getElementById('itemSubCategory').innerHTML = '<option value="">Select a category first</option>';
                itemSubCategoryChoice = SearchableSelect.refresh('#itemSubCategory');
            }
        } else {
            SearchableSelect.setValue('#itemCategory', '');
            document.getElementById('itemSubCategory').innerHTML = '<option value="">Select a category first</option>';
            itemSubCategoryChoice = SearchableSelect.refresh('#itemSubCategory');
        }

        document.getElementById('itemDescription').value = item?.description || '';
        document.getElementById('itemIsActive').checked = item?.is_active !== false;
        modal.show();
    }

    async function save() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const token = window.authService.getToken();
            const name = document.getElementById('itemName').value.trim();
            const categoryId = document.getElementById('itemCategory').value;
            const subCategoryId = document.getElementById('itemSubCategory').value;
            const description = document.getElementById('itemDescription').value.trim();
            const isActive = document.getElementById('itemIsActive').checked;

            console.log('Saving variant...');
            console.log('Name:', name);
            console.log('Category ID:', categoryId);
            console.log('Sub-Category ID:', subCategoryId);
            console.log('Description:', description);
            console.log('Is Active:', isActive);

            if (!name) {
                throw new Error('Name is required');
            }

            if (!categoryId) {
                throw new Error('Please select a category');
            }

            if (!subCategoryId) {
                throw new Error('Please select a sub-category');
            }

            const data = {
                name: name,
                stock_sub_category_id: subCategoryId,
                description: description || null,
                is_active: isActive
            };
            const url = editingId ? `${CONFIG.MENU.inventoryVariants}/${editingId}` : CONFIG.MENU.inventoryVariants;
            const resp = await fetch(url, { method: editingId ? 'PUT' : 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            modal.hide();
            Swal.fire({ icon: 'success', title: 'Saved!', timer: 1500, showConfirmButton: false });
            await loadData();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Save'; }
    }

    async function deleteItem(id) {
        const item = items.find(i => i.id === id);
        const result = await Swal.fire({ title: 'Delete?', text: `Delete "${item?.name}"?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'Delete' });
        if (!result.isConfirmed) return;
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.inventoryVariants}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            Swal.fire({ icon: 'success', title: 'Deleted!', timer: 1500, showConfirmButton: false });
            await loadData();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }

    function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

    function goToStockCount(variantId) {
        // Store variant filter and navigate to stock count page
        sessionStorage.setItem('stockCountVariantId', variantId);
        window.router.navigateTo('stock-count');
    }

    window.inventoryVarPage = {
        edit: (id) => { const item = items.find(i => i.id === id); if (item) openModal(item); },
        delete: deleteItem,
        stockCount: goToStockCount
    };

    init();
})();
</script>
