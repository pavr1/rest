<!-- Ingredients Page Partial -->
<style>
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .page-title { font-family: Arial, sans-serif; font-size: 1.75rem; margin: 0; }
    .filters { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .data-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-light); overflow: hidden; }
    .data-table { width: 100%; margin: 0; }
    .data-table th { background: #f8f9fa; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid #e9ecef; }
    .data-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #e9ecef; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .action-btns { display: flex; gap: 0.5rem; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85rem; }
    .empty-state, .loading-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .menu-item-link { color: var(--primary-color); text-decoration: none; font-weight: 500; }
    .menu-item-link:hover { text-decoration: underline; }
    .cost-cell { font-weight: 600; }
</style>

<div class="page-header">
    <h1 class="page-title">Ingredients Overview</h1>
    <button class="btn btn-outline-secondary" id="refreshBtn"><i class="fas fa-sync-alt me-2"></i>Refresh</button>
</div>

<div class="filters">
    <select class="form-select" id="menuItemFilter" style="width: auto;">
        <option value="">All Menu Items</option>
    </select>
</div>

<div class="data-card">
    <div id="tableContainer">
        <div class="loading-state" id="loadingState">
            <div class="spinner-border text-primary mb-3"></div>
            <p>Loading ingredients...</p>
        </div>
        <div class="empty-state d-none" id="emptyState">
            <i class="fas fa-list-ul"></i>
            <h5>No ingredients found</h5>
            <p>Add ingredients to menu items to see them here.</p>
        </div>
        <table class="data-table d-none" id="dataTable">
            <thead>
                <tr>
                    <th>Menu Item</th>
                    <th>Stock Item</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Unit Cost</th>
                    <th>Total Cost</th>
                    <th width="100">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Edit Quantity Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Quantity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm">
                <div class="modal-body">
                    <input type="hidden" id="editMenuItemId">
                    <input type="hidden" id="editStockItemId">
                    <div class="mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="editQuantity" step="0.01" min="0.01" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
    let menuItems = [];
    let stockItems = [];
    let allIngredients = [];
    let modal = null;
    
    function init() {
        modal = new bootstrap.Modal(document.getElementById('editModal'));
        setupEventListeners();
        loadData();
    }
    
    function setupEventListeners() {
        document.getElementById('refreshBtn')?.addEventListener('click', loadData);
        document.getElementById('menuItemFilter')?.addEventListener('change', filterAndRender);
        document.getElementById('editForm')?.addEventListener('submit', (e) => { e.preventDefault(); saveQuantity(); });
    }
    
    async function loadData() {
        showLoading();
        try {
            const token = window.authService.getToken();
            
            // Load menu variants
            const variantsResp = await fetch(CONFIG.MENU.variants, { headers: { 'Authorization': `Bearer ${token}` } });
            if (variantsResp.ok) {
                const result = await variantsResp.json();
                menuItems = result.data?.variants || result.data?.items || result.data || [];
                populateMenuItemFilter();
            }
            
            // Load inventory variants (stock items) for unit cost info
            const stockResp = await fetch(CONFIG.MENU.inventoryVariants, { headers: { 'Authorization': `Bearer ${token}` } });
            if (stockResp.ok) {
                const result = await stockResp.json();
                stockItems = result.data?.variants || result.data?.items || result.data || [];
            }
            
            // Load ingredients for each menu variant
            allIngredients = [];
            for (const item of menuItems) {
                try {
                    const ingResp = await fetch(CONFIG.MENU.ingredientsByVariant(item.id), { headers: { 'Authorization': `Bearer ${token}` } });
                    if (ingResp.ok) {
                        const result = await ingResp.json();
                        const ingredients = result.data?.ingredients || [];
                        ingredients.forEach(ing => {
                            allIngredients.push({
                                ...ing,
                                menu_item_id: item.id,
                                menu_item_name: item.name
                            });
                        });
                    }
                } catch (e) { console.error('Error loading ingredients for', item.id, e); }
            }
            
            filterAndRender();
        } catch (e) {
            console.error('Error:', e);
            Swal.fire('Error', 'Failed to load data', 'error');
            showEmpty();
        }
    }
    
    function populateMenuItemFilter() {
        const options = menuItems.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        document.getElementById('menuItemFilter').innerHTML = '<option value="">All Menu Items</option>' + options;
        
        // Initialize searchable select for menu items (can be a large list)
        SearchableSelect.refresh('#menuItemFilter', {
            searchPlaceholderValue: 'Search menu items...'
        });
    }
    
    function filterAndRender() {
        const filter = document.getElementById('menuItemFilter').value;
        let filtered = allIngredients;
        
        if (filter) {
            filtered = allIngredients.filter(ing => ing.menu_item_id === filter);
        }
        
        renderTable(filtered);
    }
    
    function renderTable(ingredients) {
        const tbody = document.getElementById('tableBody');
        const table = document.getElementById('dataTable');
        const empty = document.getElementById('emptyState');
        document.getElementById('loadingState').classList.add('d-none');
        
        if (!ingredients.length) { 
            table.classList.add('d-none'); 
            empty.classList.remove('d-none'); 
            return; 
        }
        
        empty.classList.add('d-none');
        table.classList.remove('d-none');
        
        tbody.innerHTML = ingredients.map(ing => {
            const stockItem = stockItems.find(s => s.id === ing.stock_item_id);
            const unitCost = stockItem?.cost_per_unit || 0;
            const totalCost = unitCost * ing.quantity;
            
            return `
                <tr>
                    <td>
                        <a href="#menu-variants" class="menu-item-link" onclick="app.navigateTo('menu-variants'); return false;">
                            ${escapeHtml(ing.menu_item_name)}
                        </a>
                    </td>
                    <td><strong>${escapeHtml(ing.stock_item_name || stockItem?.name || '-')}</strong></td>
                    <td>${ing.quantity.toFixed(2)}</td>
                    <td>${ing.stock_item_unit || stockItem?.unit || '-'}</td>
                    <td>$${unitCost.toFixed(2)}</td>
                    <td class="cost-cell">$${totalCost.toFixed(2)}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline-primary btn-action" onclick="window.ingredientsPage.edit('${ing.menu_item_id}', '${ing.stock_item_id}', ${ing.quantity})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-action" onclick="window.ingredientsPage.delete('${ing.menu_item_id}', '${ing.stock_item_id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function showLoading() { 
        document.getElementById('loadingState').classList.remove('d-none'); 
        document.getElementById('emptyState').classList.add('d-none'); 
        document.getElementById('dataTable').classList.add('d-none'); 
    }
    
    function showEmpty() { 
        document.getElementById('loadingState').classList.add('d-none'); 
        document.getElementById('emptyState').classList.remove('d-none'); 
        document.getElementById('dataTable').classList.add('d-none'); 
    }
    
    function openEditModal(menuItemId, stockItemId, quantity) {
        document.getElementById('editMenuItemId').value = menuItemId;
        document.getElementById('editStockItemId').value = stockItemId;
        document.getElementById('editQuantity').value = quantity;
        modal.show();
    }
    
    async function saveQuantity() {
        const menuItemId = document.getElementById('editMenuItemId').value;
        const stockItemId = document.getElementById('editStockItemId').value;
        const quantity = parseFloat(document.getElementById('editQuantity').value);
        
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.ingredients(menuItemId)}/${stockItemId}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: quantity })
            });
            if (!resp.ok) throw new Error('Failed');
            modal.hide();
            Swal.fire({ icon: 'success', title: 'Saved!', timer: 1500, showConfirmButton: false });
            await loadData();
        } catch (e) { 
            Swal.fire('Error', e.message, 'error'); 
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'Save';
        }
    }
    
    async function deleteIngredient(menuItemId, stockItemId) {
        const result = await Swal.fire({
            title: 'Delete?', 
            text: 'Remove this ingredient?', 
            icon: 'warning',
            showCancelButton: true, 
            confirmButtonColor: '#dc3545', 
            confirmButtonText: 'Delete'
        });
        if (!result.isConfirmed) return;
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.ingredients(menuItemId)}/${stockItemId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!resp.ok) throw new Error('Failed');
            Swal.fire({ icon: 'success', title: 'Deleted!', timer: 1500, showConfirmButton: false });
            await loadData();
        } catch (e) { 
            Swal.fire('Error', e.message, 'error'); 
        }
    }
    
    function escapeHtml(text) { 
        if (!text) return ''; 
        const div = document.createElement('div'); 
        div.textContent = text; 
        return div.innerHTML; 
    }
    
    window.ingredientsPage = {
        edit: openEditModal,
        delete: deleteIngredient
    };
    
    init();
})();
</script>
