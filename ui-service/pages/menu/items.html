<!-- Menu Items Page Partial -->
<style>
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 1.75rem; margin: 0; }
    .filters { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .data-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-light); overflow: hidden; }
    .data-table { width: 100%; margin: 0; }
    .data-table th { background: #f8f9fa; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid #e9ecef; }
    .data-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #e9ecef; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .action-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85rem; }
    .empty-state, .loading-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
    .status-badge.available { background: #d4edda; color: #155724; }
    .status-badge.unavailable { background: #f8d7da; color: #721c24; }
    .type-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
    .type-badge.kitchen { background: #fff3cd; color: #856404; }
    .type-badge.bar { background: #cce5ff; color: #004085; }
    .price { font-weight: 600; color: var(--primary-color); }
    .item-image { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #f8f9fa; }
    .item-image-placeholder { width: 50px; height: 50px; border-radius: 8px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #ccc; }
    .ingredient-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 0.5rem; }
    .ingredient-row .ingredient-name { flex: 1; }
    .ingredient-row .ingredient-qty { width: 100px; }
    .ingredient-count { font-size: 0.7rem; background: var(--primary-color); color: white; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; margin-left: 2px; }
</style>

<div class="page-header">
    <h1 class="page-title">Menu Items</h1>
    <button class="btn btn-primary" id="addItemBtn"><i class="fas fa-plus me-2"></i>Add Item</button>
</div>

<div class="filters">
    <select class="form-select" id="subMenuFilter" style="width: auto;"><option value="">All Sub Menus</option></select>
    <select class="form-select" id="availabilityFilter" style="width: auto;">
        <option value="">All Status</option>
        <option value="true">Available</option>
        <option value="false">Unavailable</option>
    </select>
    <button class="btn btn-outline-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
</div>

<div class="data-card">
    <div id="tableContainer">
        <div class="loading-state" id="loadingState">
            <div class="spinner-border text-primary mb-3"></div>
            <p>Loading menu items...</p>
        </div>
        <div class="empty-state d-none" id="emptyState">
            <i class="fas fa-utensils"></i>
            <h5>No menu items yet</h5>
            <p>Create your first menu item to get started.</p>
        </div>
        <table class="data-table d-none" id="dataTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Sub Menu</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th width="180">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Item Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="itemForm">
                <div class="modal-body">
                    <input type="hidden" id="itemId">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Sub Menu <span class="text-danger">*</span></label>
                            <select class="form-select" id="itemSubMenu" required><option value="">Select...</option></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price <span class="text-danger">*</span></label>
                            <div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="itemPrice" step="0.01" min="0" required></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Prep Time (min)</label>
                            <input type="number" class="form-control" id="itemPrepTime" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="itemDisplayOrder" value="0" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Menu Types <span class="text-danger">*</span></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="menuTypeBreakfast" value="breakfast">
                            <label class="form-check-label" for="menuTypeBreakfast">Breakfast</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="menuTypeLunch" value="lunch" checked>
                            <label class="form-check-label" for="menuTypeLunch">Lunch</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="menuTypeDinner" value="dinner" checked>
                            <label class="form-check-label" for="menuTypeDinner">Dinner</label>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="itemAlcoholic">
                        <label class="form-check-label" for="itemAlcoholic">Contains Alcohol</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="itemAvailable" checked>
                        <label class="form-check-label" for="itemAvailable">Available for ordering</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ingredients Modal -->
<div class="modal fade" id="ingredientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-list-ul me-2"></i>Ingredients for <span id="ingredientItemName">-</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ingredientMenuItemId">
                
                <!-- Add Ingredient Form -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-plus me-2"></i>Add Ingredient</h6>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-6">
                                <label class="form-label">Stock Item</label>
                                <select class="form-select" id="newIngredientStockItem">
                                    <option value="">Select stock item...</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="newIngredientQty" step="0.01" min="0.01" placeholder="0.00">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-success w-100" id="addIngredientBtn">
                                    <i class="fas fa-plus me-1"></i>Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ingredients List -->
                <div id="ingredientsLoading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    <span class="ms-2">Loading ingredients...</span>
                </div>
                <div id="ingredientsEmpty" class="text-center py-3 text-muted d-none">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No ingredients added yet</p>
                </div>
                <div id="ingredientsList"></div>
                
                <!-- Cost Summary -->
                <div class="card mt-3 bg-light">
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Total Cost:</strong> <span id="totalCost" class="text-primary fs-5">$0.00</span>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="recalculateCostBtn">
                            <i class="fas fa-calculator me-1"></i>Recalculate & Save
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    let items = [];
    let subMenus = [];
    let stockItems = [];
    let currentIngredients = [];
    let modal = null;
    let ingredientsModal = null;
    let editingId = null;
    
    function init() {
        modal = new bootstrap.Modal(document.getElementById('itemModal'));
        ingredientsModal = new bootstrap.Modal(document.getElementById('ingredientsModal'));
        setupEventListeners();
        loadSubMenus();
        loadStockItems();
        loadItems();
    }
    
    function setupEventListeners() {
        document.getElementById('addItemBtn')?.addEventListener('click', () => openModal());
        document.getElementById('refreshBtn')?.addEventListener('click', () => loadItems());
        document.getElementById('itemForm')?.addEventListener('submit', (e) => { e.preventDefault(); saveItem(); });
        document.getElementById('subMenuFilter')?.addEventListener('change', () => loadItems());
        document.getElementById('availabilityFilter')?.addEventListener('change', () => loadItems());
        document.getElementById('addIngredientBtn')?.addEventListener('click', addIngredient);
        document.getElementById('recalculateCostBtn')?.addEventListener('click', recalculateCost);
    }
    
    async function loadSubMenus() {
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.subMenus, { headers: { 'Authorization': `Bearer ${token}` } });
            if (resp.ok) {
                const result = await resp.json();
                // Response is wrapped in { success, message, data: { sub_menus, total, page, limit } }
                subMenus = result.data?.sub_menus || result.sub_menus || [];
                populateSubMenuDropdowns();
            }
        } catch (e) { console.error('Error loading sub menus:', e); }
    }
    
    async function loadStockItems() {
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.stockItems, { headers: { 'Authorization': `Bearer ${token}` } });
            if (resp.ok) {
                const result = await resp.json();
                stockItems = result.data?.items || result.data || [];
                populateStockItemsDropdown();
            }
        } catch (e) { console.error('Error loading stock items:', e); }
    }
    
    function populateSubMenuDropdowns() {
        const options = subMenus.map(sm => `<option value="${sm.id}">${sm.name} (${sm.item_type})</option>`).join('');
        document.getElementById('subMenuFilter').innerHTML = '<option value="">All Sub Menus</option>' + options;
        document.getElementById('itemSubMenu').innerHTML = '<option value="">Select...</option>' + options;
    }
    
    function populateStockItemsDropdown() {
        const options = stockItems.map(s => `<option value="${s.id}">${s.name} (${s.unit})</option>`).join('');
        document.getElementById('newIngredientStockItem').innerHTML = '<option value="">Select stock item...</option>' + options;
    }
    
    async function loadItems() {
        showLoading();
        try {
            const token = window.authService.getToken();
            const params = new URLSearchParams();
            const subMenuId = document.getElementById('subMenuFilter').value;
            const avail = document.getElementById('availabilityFilter').value;
            if (subMenuId) params.append('sub_menu_id', subMenuId);
            if (avail) params.append('is_available', avail);
            
            const url = CONFIG.MENU.items + (params.toString() ? `?${params}` : '');
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            const result = await resp.json();
            items = result.data?.items || result.data || [];
            renderTable();
        } catch (e) {
            console.error('Error:', e);
            Swal.fire('Error', 'Failed to load items', 'error');
            showEmpty();
        }
    }
    
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const table = document.getElementById('dataTable');
        const empty = document.getElementById('emptyState');
        document.getElementById('loadingState').classList.add('d-none');
        
        if (!items.length) { table.classList.add('d-none'); empty.classList.remove('d-none'); return; }
        
        empty.classList.add('d-none');
        table.classList.remove('d-none');
        tbody.innerHTML = items.map(item => {
            const subMenu = subMenus.find(sm => sm.id === item.sub_menu_id);
            const itemType = item.item_type || subMenu?.item_type || 'kitchen';
            const typeIcon = itemType === 'bar' ? 'fa-cocktail' : 'fa-utensils';
            const typeLabel = itemType === 'bar' ? 'Bar' : 'Kitchen';
            return `
                <tr>
                    <td>${item.image_url ? `<img src="${item.image_url}" class="item-image">` : `<div class="item-image-placeholder"><i class="fas ${typeIcon}"></i></div>`}</td>
                    <td><strong>${escapeHtml(item.name)}</strong></td>
                    <td><span class="type-badge ${itemType}"><i class="fas ${typeIcon} me-1"></i>${typeLabel}</span></td>
                    <td>${item.sub_menu_name || subMenu?.name || '-'}</td>
                    <td class="price">$${(item.price || 0).toFixed(2)}</td>
                    <td>$${(item.item_cost || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${item.is_available ? 'available' : 'unavailable'}">${item.is_available ? 'Available' : 'Unavailable'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline-info btn-action" onclick="window.menuItemsPage.ingredients('${item.id}')" title="Ingredients">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button class="btn btn-outline-${item.is_available ? 'warning' : 'success'} btn-action" onclick="window.menuItemsPage.toggle('${item.id}', ${!item.is_available})" title="${item.is_available ? 'Unavailable' : 'Available'}">
                                <i class="fas fa-${item.is_available ? 'eye-slash' : 'eye'}"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-action" onclick="window.menuItemsPage.edit('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger btn-action" onclick="window.menuItemsPage.delete('${item.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function showLoading() { document.getElementById('loadingState').classList.remove('d-none'); document.getElementById('emptyState').classList.add('d-none'); document.getElementById('dataTable').classList.add('d-none'); }
    function showEmpty() { document.getElementById('loadingState').classList.add('d-none'); document.getElementById('emptyState').classList.remove('d-none'); document.getElementById('dataTable').classList.add('d-none'); }
    
    function openModal(item = null) {
        editingId = item?.id || null;
        document.getElementById('modalTitle').textContent = item ? 'Edit Menu Item' : 'Add Menu Item';
        document.getElementById('itemId').value = item?.id || '';
        document.getElementById('itemName').value = item?.name || '';
        document.getElementById('itemSubMenu').value = item?.sub_menu_id || '';
        document.getElementById('itemDescription').value = item?.description || '';
        document.getElementById('itemPrice').value = item?.price || '';
        document.getElementById('itemPrepTime').value = item?.preparation_time || '';
        document.getElementById('itemDisplayOrder').value = item?.display_order || 0;
        document.getElementById('itemAvailable').checked = item?.is_available !== false;
        document.getElementById('itemAlcoholic').checked = item?.is_alcoholic || false;
        
        // Parse menu_types JSON
        let menuTypes = [];
        if (item?.menu_types) {
            try {
                menuTypes = JSON.parse(item.menu_types);
            } catch (e) {
                menuTypes = ['lunch', 'dinner']; // default
            }
        } else {
            menuTypes = ['lunch', 'dinner']; // default
        }
        document.getElementById('menuTypeBreakfast').checked = menuTypes.includes('breakfast');
        document.getElementById('menuTypeLunch').checked = menuTypes.includes('lunch');
        document.getElementById('menuTypeDinner').checked = menuTypes.includes('dinner');
        
        modal.show();
    }
    
    async function saveItem() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const token = window.authService.getToken();
            
            // Build menu_types array from checkboxes
            const menuTypes = [];
            if (document.getElementById('menuTypeBreakfast').checked) menuTypes.push('breakfast');
            if (document.getElementById('menuTypeLunch').checked) menuTypes.push('lunch');
            if (document.getElementById('menuTypeDinner').checked) menuTypes.push('dinner');
            if (menuTypes.length === 0) {
                btn.disabled = false;
                btn.innerHTML = 'Save';
                Swal.fire('Error', 'Please select at least one menu type', 'warning');
                return;
            }
            
            const data = {
                name: document.getElementById('itemName').value,
                sub_menu_id: document.getElementById('itemSubMenu').value,
                description: document.getElementById('itemDescription').value || null,
                price: parseFloat(document.getElementById('itemPrice').value) || 0,
                preparation_time: parseInt(document.getElementById('itemPrepTime').value) || null,
                display_order: parseInt(document.getElementById('itemDisplayOrder').value) || 0,
                is_available: document.getElementById('itemAvailable').checked,
                is_alcoholic: document.getElementById('itemAlcoholic').checked,
                menu_types: JSON.stringify(menuTypes),
                dietary_tags: JSON.stringify([]),
                allergens: JSON.stringify([])
            };
            const url = editingId ? `${CONFIG.MENU.items}/${editingId}` : CONFIG.MENU.items;
            const resp = await fetch(url, { method: editingId ? 'PUT' : 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            modal.hide();
            Swal.fire({ icon: 'success', title: 'Saved!', timer: 1500, showConfirmButton: false });
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Save'; }
    }
    
    async function toggleAvailability(id, available) {
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.items}/${id}/availability`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ is_available: available }) });
            if (!resp.ok) throw new Error('Failed');
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function deleteItem(id) {
        const item = items.find(i => i.id === id);
        const result = await Swal.fire({ title: 'Delete?', text: `Delete "${item?.name}"?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'Delete' });
        if (!result.isConfirmed) return;
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.items}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            Swal.fire({ icon: 'success', title: 'Deleted!', timer: 1500, showConfirmButton: false });
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    // === INGREDIENTS MANAGEMENT ===
    async function openIngredientsModal(menuItemId) {
        const item = items.find(i => i.id === menuItemId);
        if (!item) return;
        
        document.getElementById('ingredientMenuItemId').value = menuItemId;
        document.getElementById('ingredientItemName').textContent = item.name;
        document.getElementById('newIngredientStockItem').value = '';
        document.getElementById('newIngredientQty').value = '';
        
        ingredientsModal.show();
        await loadIngredients(menuItemId);
    }
    
    async function loadIngredients(menuItemId) {
        const listEl = document.getElementById('ingredientsList');
        const loadingEl = document.getElementById('ingredientsLoading');
        const emptyEl = document.getElementById('ingredientsEmpty');
        
        listEl.innerHTML = '';
        loadingEl.classList.remove('d-none');
        emptyEl.classList.add('d-none');
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.ingredients(menuItemId), { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            const result = await resp.json();
            currentIngredients = result.data?.ingredients || [];
            renderIngredients();
        } catch (e) {
            console.error('Error:', e);
            Swal.fire('Error', 'Failed to load ingredients', 'error');
        } finally {
            loadingEl.classList.add('d-none');
        }
    }
    
    function renderIngredients() {
        const listEl = document.getElementById('ingredientsList');
        const emptyEl = document.getElementById('ingredientsEmpty');
        
        if (!currentIngredients.length) {
            emptyEl.classList.remove('d-none');
            listEl.innerHTML = '';
            document.getElementById('totalCost').textContent = '$0.00';
            return;
        }
        
        emptyEl.classList.add('d-none');
        let totalCost = 0;
        
        listEl.innerHTML = currentIngredients.map(ing => {
            const stockItem = stockItems.find(s => s.id === ing.stock_item_id);
            const unitCost = stockItem?.cost_per_unit || 0;
            const ingCost = unitCost * ing.quantity;
            totalCost += ingCost;
            
            return `
                <div class="ingredient-row">
                    <div class="ingredient-name">
                        <strong>${escapeHtml(ing.stock_item_name || stockItem?.name || 'Unknown')}</strong>
                        <small class="text-muted ms-2">(${ing.stock_item_unit || stockItem?.unit || '-'})</small>
                    </div>
                    <input type="number" class="form-control form-control-sm ingredient-qty" 
                           value="${ing.quantity}" step="0.01" min="0.01"
                           data-stock-id="${ing.stock_item_id}"
                           onchange="window.menuItemsPage.updateIngredient('${ing.stock_item_id}', this.value)">
                    <small class="text-muted" style="width: 80px;">$${ingCost.toFixed(2)}</small>
                    <button class="btn btn-outline-danger btn-sm" onclick="window.menuItemsPage.removeIngredient('${ing.stock_item_id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }).join('');
        
        document.getElementById('totalCost').textContent = '$' + totalCost.toFixed(2);
    }
    
    async function addIngredient() {
        const menuItemId = document.getElementById('ingredientMenuItemId').value;
        const stockItemId = document.getElementById('newIngredientStockItem').value;
        const quantity = parseFloat(document.getElementById('newIngredientQty').value);
        
        if (!stockItemId || !quantity || quantity <= 0) {
            Swal.fire('Error', 'Please select a stock item and enter a valid quantity', 'warning');
            return;
        }
        
        // Check if already added
        if (currentIngredients.some(i => i.stock_item_id === stockItemId)) {
            Swal.fire('Error', 'This ingredient is already added', 'warning');
            return;
        }
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.ingredients(menuItemId), {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ stock_item_id: stockItemId, quantity: quantity })
            });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            
            document.getElementById('newIngredientStockItem').value = '';
            document.getElementById('newIngredientQty').value = '';
            await loadIngredients(menuItemId);
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function updateIngredient(stockItemId, newQuantity) {
        const menuItemId = document.getElementById('ingredientMenuItemId').value;
        const quantity = parseFloat(newQuantity);
        
        if (!quantity || quantity <= 0) {
            Swal.fire('Error', 'Quantity must be greater than 0', 'warning');
            await loadIngredients(menuItemId);
            return;
        }
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.ingredients(menuItemId)}/${stockItemId}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: quantity })
            });
            if (!resp.ok) throw new Error('Failed');
            await loadIngredients(menuItemId);
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function removeIngredient(stockItemId) {
        const menuItemId = document.getElementById('ingredientMenuItemId').value;
        
        const result = await Swal.fire({
            title: 'Remove?', text: 'Remove this ingredient?', icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'Remove'
        });
        if (!result.isConfirmed) return;
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.ingredients(menuItemId)}/${stockItemId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!resp.ok) throw new Error('Failed');
            await loadIngredients(menuItemId);
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function recalculateCost() {
        const menuItemId = document.getElementById('ingredientMenuItemId').value;
        const btn = document.getElementById('recalculateCostBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.itemCost(menuItemId)}/recalculate`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!resp.ok) throw new Error('Failed');
            Swal.fire({ icon: 'success', title: 'Cost saved!', timer: 1500, showConfirmButton: false });
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
        finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-calculator me-1"></i>Recalculate & Save';
        }
    }
    
    function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    
    window.menuItemsPage = {
        edit: (id) => { const item = items.find(i => i.id === id); if (item) openModal(item); },
        delete: deleteItem,
        toggle: toggleAvailability,
        ingredients: openIngredientsModal,
        updateIngredient: updateIngredient,
        removeIngredient: removeIngredient
    };
    
    init();
})();
</script>
