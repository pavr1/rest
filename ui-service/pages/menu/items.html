<!-- Menu Items Page Partial -->
<style>
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .page-title { font-family: 'Playfair Display', serif; font-size: 1.75rem; margin: 0; }
    .filters { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
    .data-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-light); overflow: hidden; }
    .data-table { width: 100%; margin: 0; }
    .data-table th { background: #f8f9fa; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid #e9ecef; }
    .data-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #e9ecef; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .action-btns { display: flex; gap: 0.5rem; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85rem; }
    .empty-state, .loading-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
    .status-badge.available { background: #d4edda; color: #155724; }
    .status-badge.unavailable { background: #f8d7da; color: #721c24; }
    .type-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
    .type-badge.kitchen { background: #fff3cd; color: #856404; }
    .type-badge.bar { background: #cce5ff; color: #004085; }
    .price { font-weight: 600; color: var(--primary-color); }
    .item-image { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #f8f9fa; }
    .item-image-placeholder { width: 50px; height: 50px; border-radius: 8px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #ccc; }
</style>

<div class="page-header">
    <h1 class="page-title">Menu Items</h1>
    <button class="btn btn-primary" id="addItemBtn"><i class="fas fa-plus me-2"></i>Add Item</button>
</div>

<div class="filters">
    <select class="form-select" id="categoryFilter" style="width: auto;"><option value="">All Categories</option></select>
    <select class="form-select" id="typeFilter" style="width: auto;">
        <option value="">All Types</option>
        <option value="kitchen">Kitchen</option>
        <option value="bar">Bar</option>
    </select>
    <select class="form-select" id="availabilityFilter" style="width: auto;">
        <option value="">All Status</option>
        <option value="true">Available</option>
        <option value="false">Unavailable</option>
    </select>
    <button class="btn btn-outline-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i></button>
</div>

<div class="data-card">
    <div id="tableContainer">
        <div class="loading-state" id="loadingState">
            <div class="spinner-border text-primary mb-3"></div>
            <p>Loading menu items...</p>
        </div>
        <div class="empty-state d-none" id="emptyState">
            <i class="fas fa-utensils"></i>
            <h5>No menu items yet</h5>
            <p>Create your first menu item to get started.</p>
        </div>
        <table class="data-table d-none" id="dataTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th width="150">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="itemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Menu Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="itemForm">
                <div class="modal-body">
                    <input type="hidden" id="itemId">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="itemName" required>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Type <span class="text-danger">*</span></label>
                            <select class="form-select" id="itemType" required>
                                <option value="">Select...</option>
                                <option value="kitchen">Kitchen</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="itemCategory" required><option value="">Select...</option></select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="itemDescription" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price <span class="text-danger">*</span></label>
                            <div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="itemPrice" step="0.01" min="0" required></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Prep Time (min)</label>
                            <input type="number" class="form-control" id="itemPrepTime" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="itemDisplayOrder" value="0" min="0">
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="itemAvailable" checked>
                        <label class="form-check-label" for="itemAvailable">Available for ordering</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
(function() {
    let items = [];
    let categories = [];
    let modal = null;
    let editingId = null;
    
    function init() {
        modal = new bootstrap.Modal(document.getElementById('itemModal'));
        setupEventListeners();
        loadCategories();
        loadItems();
    }
    
    function setupEventListeners() {
        document.getElementById('addItemBtn')?.addEventListener('click', () => openModal());
        document.getElementById('refreshBtn')?.addEventListener('click', () => loadItems());
        document.getElementById('itemForm')?.addEventListener('submit', (e) => { e.preventDefault(); saveItem(); });
        document.getElementById('categoryFilter')?.addEventListener('change', () => loadItems());
        document.getElementById('typeFilter')?.addEventListener('change', () => loadItems());
        document.getElementById('availabilityFilter')?.addEventListener('change', () => loadItems());
    }
    
    async function loadCategories() {
        try {
            const token = window.authService.getSessionId();
            const resp = await fetch(CONFIG.MENU.categories, { headers: { 'Authorization': `Bearer ${token}` } });
            if (resp.ok) {
                const result = await resp.json();
                categories = result.data?.categories || result.data || [];
                populateCategoryDropdowns();
            }
        } catch (e) { console.error('Error loading categories:', e); }
    }
    
    function populateCategoryDropdowns() {
        const options = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        document.getElementById('categoryFilter').innerHTML = '<option value="">All Categories</option>' + options;
        document.getElementById('itemCategory').innerHTML = '<option value="">Select...</option>' + options;
    }
    
    async function loadItems() {
        showLoading();
        try {
            const token = window.authService.getSessionId();
            const params = new URLSearchParams();
            const catId = document.getElementById('categoryFilter').value;
            const itemType = document.getElementById('typeFilter').value;
            const avail = document.getElementById('availabilityFilter').value;
            if (catId) params.append('category_id', catId);
            if (itemType) params.append('item_type', itemType);
            if (avail) params.append('is_available', avail);
            
            const url = CONFIG.MENU.items + (params.toString() ? `?${params}` : '');
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            const result = await resp.json();
            items = result.data?.items || result.data || [];
            renderTable();
        } catch (e) {
            console.error('Error:', e);
            Swal.fire('Error', 'Failed to load items', 'error');
            showEmpty();
        }
    }
    
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const table = document.getElementById('dataTable');
        const empty = document.getElementById('emptyState');
        document.getElementById('loadingState').classList.add('d-none');
        
        if (!items.length) { table.classList.add('d-none'); empty.classList.remove('d-none'); return; }
        
        empty.classList.add('d-none');
        table.classList.remove('d-none');
        tbody.innerHTML = items.map(item => {
            const cat = categories.find(c => c.id === item.category_id);
            const typeIcon = item.item_type === 'bar' ? 'fa-cocktail' : 'fa-utensils';
            const typeLabel = item.item_type === 'bar' ? 'Bar' : 'Kitchen';
            return `
                <tr>
                    <td>${item.image_url ? `<img src="${item.image_url}" class="item-image">` : `<div class="item-image-placeholder"><i class="fas ${typeIcon}"></i></div>`}</td>
                    <td><strong>${escapeHtml(item.name)}</strong></td>
                    <td><span class="type-badge ${item.item_type || 'kitchen'}"><i class="fas ${typeIcon} me-1"></i>${typeLabel}</span></td>
                    <td>${cat?.name || '-'}</td>
                    <td class="price">$${(item.price || 0).toFixed(2)}</td>
                    <td>$${(item.cost || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${item.is_available ? 'available' : 'unavailable'}">${item.is_available ? 'Available' : 'Unavailable'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline-${item.is_available ? 'warning' : 'success'} btn-action" onclick="window.menuItemsPage.toggle('${item.id}', ${!item.is_available})" title="${item.is_available ? 'Unavailable' : 'Available'}">
                                <i class="fas fa-${item.is_available ? 'eye-slash' : 'eye'}"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-action" onclick="window.menuItemsPage.edit('${item.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger btn-action" onclick="window.menuItemsPage.delete('${item.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function showLoading() { document.getElementById('loadingState').classList.remove('d-none'); document.getElementById('emptyState').classList.add('d-none'); document.getElementById('dataTable').classList.add('d-none'); }
    function showEmpty() { document.getElementById('loadingState').classList.add('d-none'); document.getElementById('emptyState').classList.remove('d-none'); document.getElementById('dataTable').classList.add('d-none'); }
    
    function openModal(item = null) {
        editingId = item?.id || null;
        document.getElementById('modalTitle').textContent = item ? 'Edit Menu Item' : 'Add Menu Item';
        document.getElementById('itemId').value = item?.id || '';
        document.getElementById('itemName').value = item?.name || '';
        document.getElementById('itemType').value = item?.item_type || '';
        document.getElementById('itemCategory').value = item?.category_id || '';
        document.getElementById('itemDescription').value = item?.description || '';
        document.getElementById('itemPrice').value = item?.price || '';
        document.getElementById('itemPrepTime').value = item?.preparation_time || '';
        document.getElementById('itemDisplayOrder').value = item?.display_order || 0;
        document.getElementById('itemAvailable').checked = item?.is_available !== false;
        modal.show();
    }
    
    async function saveItem() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const token = window.authService.getSessionId();
            const data = {
                name: document.getElementById('itemName').value,
                item_type: document.getElementById('itemType').value,
                category_id: document.getElementById('itemCategory').value,
                description: document.getElementById('itemDescription').value,
                price: parseFloat(document.getElementById('itemPrice').value) || 0,
                preparation_time: parseInt(document.getElementById('itemPrepTime').value) || 0,
                display_order: parseInt(document.getElementById('itemDisplayOrder').value) || 0,
                is_available: document.getElementById('itemAvailable').checked
            };
            const url = editingId ? `${CONFIG.MENU.items}/${editingId}` : CONFIG.MENU.items;
            const resp = await fetch(url, { method: editingId ? 'PUT' : 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            modal.hide();
            Swal.fire({ icon: 'success', title: 'Saved!', timer: 1500, showConfirmButton: false });
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Save'; }
    }
    
    async function toggleAvailability(id, available) {
        try {
            const token = window.authService.getSessionId();
            const resp = await fetch(`${CONFIG.MENU.items}/${id}/availability`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ is_available: available }) });
            if (!resp.ok) throw new Error('Failed');
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function deleteItem(id) {
        const item = items.find(i => i.id === id);
        const result = await Swal.fire({ title: 'Delete?', text: `Delete "${item?.name}"?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'Delete' });
        if (!result.isConfirmed) return;
        try {
            const token = window.authService.getSessionId();
            const resp = await fetch(`${CONFIG.MENU.items}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            Swal.fire({ icon: 'success', title: 'Deleted!', timer: 1500, showConfirmButton: false });
            await loadItems();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    
    window.menuItemsPage = {
        edit: (id) => { const item = items.find(i => i.id === id); if (item) openModal(item); },
        delete: deleteItem,
        toggle: toggleAvailability
    };
    
    init();
})();
</script>
