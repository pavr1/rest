<!-- Menu Variants Page Partial -->
<style>
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .page-title { font-family: Arial, sans-serif; font-size: 1.75rem; margin: 0; }
    .filter-section { margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: var(--border-radius); }
    .data-card { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-light); overflow: hidden; }
    .data-table { width: 100%; margin: 0; }
    .data-table th { background: #f8f9fa; padding: 0.75rem 1rem; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; border-bottom: 2px solid #e9ecef; }
    .data-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #e9ecef; }
    .data-table tbody tr:hover { background: #f8f9fa; }
    .action-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .btn-action { width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.85rem; }
    .empty-state, .loading-state { text-align: center; padding: 3rem 1rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .status-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
    .status-badge.available { background: #d4edda; color: #155724; }
    .status-badge.unavailable { background: #f8d7da; color: #721c24; }
    .type-badge { padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
    .type-badge.kitchen { background: #fff3cd; color: #856404; }
    .type-badge.bar { background: #cce5ff; color: #004085; }
    .price { font-weight: 600; color: var(--primary-color); }
    .item-image { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #f8f9fa; }
    .item-image-placeholder { width: 50px; height: 50px; border-radius: 8px; background: #f8f9fa; display: flex; align-items: center; justify-content: center; color: #ccc; }
    .ingredient-row { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; margin-bottom: 0.5rem; }
    .ingredient-row .ingredient-name { flex: 1; }
    .ingredient-row .ingredient-qty { width: 100px; }
    .ingredient-count { font-size: 0.7rem; background: var(--primary-color); color: white; border-radius: 50%; width: 18px; height: 18px; display: inline-flex; align-items: center; justify-content: center; margin-left: 2px; }
</style>

<div class="page-header">
    <h1 class="page-title">Menu Variants</h1>
    <button class="btn btn-primary" id="addVariantBtn"><i class="fas fa-plus me-2"></i>Add Variant</button>
</div>

<div class="filter-section">
    <div class="row">
        <div class="col-md-4">
            <label class="form-label">Filter by Category</label>
            <select class="form-select" id="categoryFilter">
                <option value="">Select a Category</option>
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label">Filter by Sub-Category</label>
            <select class="form-select" id="subCategoryFilter" disabled>
                <option value="">Select a category first</option>
            </select>
        </div>
    </div>
</div>

<div class="data-card">
    <div id="tableContainer">
        <div class="loading-state d-none" id="loadingState">
            <div class="spinner-border text-primary mb-3"></div>
            <p>Loading menu variants...</p>
        </div>
        <div class="empty-state" id="selectCategoryState">
            <i class="fas fa-filter"></i>
            <h5>Select a category to view variants</h5>
            <p>Use the filters above to browse menu variants.</p>
        </div>
        <div class="empty-state d-none" id="emptyState">
            <i class="fas fa-utensils"></i>
            <h5>No menu variants yet</h5>
            <p>Create your first menu variant to get started.</p>
        </div>
        <table class="data-table d-none" id="dataTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Sub Menu</th>
                    <th>Price</th>
                    <th>Cost</th>
                    <th>Status</th>
                    <th width="180">Actions</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<!-- Variant Modal -->
<div class="modal fade" id="variantModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Menu Variant</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="variantForm">
                <div class="modal-body">
                    <input type="hidden" id="variantId">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="variantCategory" required><option value="">Select...</option></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Sub-Category <span class="text-danger">*</span></label>
                            <select class="form-select" id="variantSubCategory" required><option value="">Select a category first</option></select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="variantName" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="variantDescription" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price <span class="text-danger">*</span></label>
                            <div class="input-group"><span class="input-group-text">$</span><input type="number" class="form-control" id="variantPrice" step="0.01" min="0" required></div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Prep Time (min)</label>
                            <input type="number" class="form-control" id="variantPrepTime" min="0">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Display Order</label>
                            <input type="number" class="form-control" id="variantDisplayOrder" value="0" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Menu Types <span class="text-danger">*</span></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="menuTypeBreakfast" value="breakfast">
                            <label class="form-check-label" for="menuTypeBreakfast">Breakfast</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="menuTypeLunch" value="lunch" checked>
                            <label class="form-check-label" for="menuTypeLunch">Lunch</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="menuTypeDinner" value="dinner" checked>
                            <label class="form-check-label" for="menuTypeDinner">Dinner</label>
                        </div>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="variantAlcoholic">
                        <label class="form-check-label" for="variantAlcoholic">Contains Alcohol</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="variantAvailable" checked>
                        <label class="form-check-label" for="variantAvailable">Available for ordering</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ingredients Modal -->
<div class="modal fade" id="ingredientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-list-ul me-2"></i>Ingredients for <span id="ingredientVariantName">-</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="ingredientMenuVariantId">
                
                <!-- Add Ingredient Form -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="fas fa-plus me-2"></i>Add Ingredient</h6>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label">Stock Variant</label>
                                <select class="form-select" id="newIngredientStockVariant">
                                    <option value="">Select stock variant...</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="newIngredientQty" step="0.01" min="0.01" placeholder="0.00">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Optional</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="newIngredientOptional">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-control" id="newIngredientNotes" placeholder="Optional notes">
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-success" id="addIngredientBtn">
                                <i class="fas fa-plus me-1"></i>Add Ingredient
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Ingredients List -->
                <div id="ingredientsLoading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    <span class="ms-2">Loading ingredients...</span>
                </div>
                <div id="ingredientsEmpty" class="text-center py-3 text-muted d-none">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="mb-0">No ingredients added yet</p>
                </div>
                <div id="ingredientsList"></div>
                
                <!-- Cost Summary -->
                <div class="card mt-3 bg-light">
                    <div class="card-body d-flex justify-content-between align-items-center">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    let variants = [];
    let categories = [];
    let subCategories = [];
    let stockVariants = [];
    let currentIngredients = [];
    let modal = null;
    let ingredientsModal = null;
    let editingId = null;

    function init() {
        modal = new bootstrap.Modal(document.getElementById('variantModal'));
        ingredientsModal = new bootstrap.Modal(document.getElementById('ingredientsModal'));
        setupEventListeners();
        loadCategories();
        showSelectCategory();
    }
    
    function initSearchableSelects() {
        SearchableSelect.init('#categoryFilter', {
            searchPlaceholderValue: 'Search categories...',
            placeholderValue: 'Select a Category'
        });
        SearchableSelect.init('#subCategoryFilter', {
            searchPlaceholderValue: 'Search sub-categories...',
            placeholderValue: 'Select a category first'
        });
        SearchableSelect.init('#variantCategory', {
            searchPlaceholderValue: 'Search categories...',
            placeholderValue: 'Select Category'
        });
        SearchableSelect.init('#variantSubCategory', {
            searchPlaceholderValue: 'Search sub-categories...',
            placeholderValue: 'Select a category first'
        });
    }

    function setupEventListeners() {
        document.getElementById('addVariantBtn')?.addEventListener('click', () => openModal());
        document.getElementById('variantForm')?.addEventListener('submit', (e) => { e.preventDefault(); saveVariant(); });
        document.getElementById('categoryFilter')?.addEventListener('change', () => {
            const categoryId = document.getElementById('categoryFilter')?.value;
            if (categoryId) {
                loadSubCategoriesForFilter();
            } else {
                subCategories = [];
                SearchableSelect.setChoices('#subCategoryFilter', [{ value: '', label: 'Select a category first', selected: true }]);
                SearchableSelect.setEnabled('#subCategoryFilter', false);
                showSelectCategory();
            }
        });
        document.getElementById('subCategoryFilter')?.addEventListener('change', () => loadVariants());
        document.getElementById('variantCategory')?.addEventListener('change', (e) => {
            console.log('variantCategory change event fired, value:', e.target.value);
            document.getElementById('variantSubCategory').value = '';
            loadSubCategoriesForModal();
        });
        document.getElementById('addIngredientBtn')?.addEventListener('click', addIngredient);
    }
    
    async function loadCategories() {
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.categories, { headers: { 'Authorization': `Bearer ${token}` } });
            if (resp.ok) {
                const result = await resp.json();
                categories = result.data?.categories || result.data || [];
                
                // Populate filter dropdown
                const categoryFilter = document.getElementById('categoryFilter');
                categoryFilter.innerHTML = '<option value="">Select a Category</option>';
                categories.forEach(cat => {
                    categoryFilter.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
                });
                
                // Populate modal dropdown
                const categorySelect = document.getElementById('variantCategory');
                categorySelect.innerHTML = '<option value="">Select...</option>';
                categories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat.id}">${escapeHtml(cat.name)}</option>`;
                });
                
                initSearchableSelects();
            }
        } catch (e) { console.error('Error loading categories:', e); }
    }
    
    async function loadSubCategoriesForFilter() {
        try {
            const token = window.authService.getToken();
            const categoryId = document.getElementById('categoryFilter')?.value;
            if (!categoryId) return;
            
            const url = `${CONFIG.MENU.subCategories}?category_id=${categoryId}`;
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) return;
            
            const result = await resp.json();
            subCategories = result.data?.sub_categories || result.sub_categories || [];
            
            // Build choices array for Choices.js
            const choices = [{ value: '', label: 'All Sub-Categories', selected: true }];
            subCategories.forEach(sc => {
                choices.push({ value: sc.id, label: sc.name });
            });
            
            SearchableSelect.setChoices('#subCategoryFilter', choices);
            SearchableSelect.setEnabled('#subCategoryFilter', true);
            
            loadVariants();
        } catch (e) { console.error('Error loading sub-categories for filter:', e); }
    }
    
    async function loadSubCategoriesForModal() {
        const categoryId = document.getElementById('variantCategory').value;
        
        if (!categoryId) {
            // Use Choices.js API to set empty state
            const choices = [{ value: '', label: 'Select a category first', selected: true }];
            SearchableSelect.setChoices('#variantSubCategory', choices);
            return;
        }
        
        // Show loading state
        SearchableSelect.setChoices('#variantSubCategory', [{ value: '', label: 'Loading...', selected: true }]);
        
        try {
            const token = window.authService.getToken();
            const url = `${CONFIG.MENU.subCategories}?category_id=${categoryId}`;
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) {
                SearchableSelect.setChoices('#variantSubCategory', [{ value: '', label: 'Failed to load', selected: true }]);
                return;
            }
            
            const result = await resp.json();
            const modalSubCategories = result.data?.sub_categories || result.sub_categories || [];
            
            // Build choices array for Choices.js
            const choices = [{ value: '', label: 'Select...', selected: true }];
            if (modalSubCategories.length === 0) {
                choices[0].label = 'No sub-categories available';
            } else {
                modalSubCategories.forEach(sc => {
                    choices.push({ value: sc.id, label: sc.name });
                });
            }
            
            SearchableSelect.setChoices('#variantSubCategory', choices);
        } catch (e) {
            console.error('Error loading sub-categories for modal:', e);
            SearchableSelect.setChoices('#variantSubCategory', [{ value: '', label: 'Error loading', selected: true }]);
        }
    }
    
    async function loadStockVariants() {
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.inventoryVariants, { headers: { 'Authorization': `Bearer ${token}` } });
            if (resp.ok) {
                const result = await resp.json();
                stockVariants = result.data?.variants || result.data?.items || result.data || [];
            }
        } catch (e) { console.error('Error loading stock variants:', e); }
    }
    
    function populateStockVariantsDropdown() {
        const select = document.getElementById('newIngredientStockVariant');
        select.innerHTML = '<option value="">Select stock variant...</option>';
        
        stockVariants.forEach(sv => {
            const label = escapeHtml(sv.name) + (sv.description ? ' - ' + escapeHtml(sv.description) : '');
            select.innerHTML += `<option value="${sv.id}">${label}</option>`;
        });
        
        // Initialize searchable select for stock variants (can be a large list)
        SearchableSelect.init('#newIngredientStockVariant', {
            searchPlaceholderValue: 'Search stock variants...'
        });
    }
    
    async function loadVariants() {
        const categoryId = document.getElementById('categoryFilter').value;
        const subCategoryId = document.getElementById('subCategoryFilter').value;
        
        // Don't load if no category is selected
        if (!categoryId) {
            showSelectCategory();
            return;
        }
        
        showLoading();
        try {
            const token = window.authService.getToken();
            if (!token) {
                throw new Error('No authentication token found');
            }

            const params = new URLSearchParams();
            if (subCategoryId) {
                params.append('sub_category_id', subCategoryId);
            } else {
                // If no sub-category selected, filter by category (get all sub-categories for this category)
                params.append('category_id', categoryId);
            }

            const url = CONFIG.MENU.variants + (params.toString() ? `?${params}` : '');
            const resp = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });

            if (!resp.ok) {
                const errorText = await resp.text();
                throw new Error(`HTTP ${resp.status}: ${errorText}`);
            }

            const result = await resp.json();
            variants = result.data?.items || result.data || [];
            renderTable();
        } catch (e) {
            console.error('Error loading variants:', e);
            Swal.fire('Error', `Failed to load variants: ${e.message}`, 'error');
            showEmpty();
        }
    }
    
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const table = document.getElementById('dataTable');
        const empty = document.getElementById('emptyState');
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('selectCategoryState').classList.add('d-none');
        
        if (!variants.length) { table.classList.add('d-none'); empty.classList.remove('d-none'); return; }
        
        empty.classList.add('d-none');
        table.classList.remove('d-none');
        tbody.innerHTML = variants.map(variant => {
            const subCategory = subCategories.find(sc => sc.id === variant.sub_category_id);
            const itemType = variant.item_type || subCategory?.item_type || 'kitchen';
            const typeIcon = itemType === 'bar' ? 'fa-cocktail' : 'fa-utensils';
            const typeLabel = itemType === 'bar' ? 'Bar' : 'Kitchen';
            return `
                <tr>
                    <td><div class="item-image-placeholder"><i class="fas ${typeIcon}"></i></div></td>
                    <td><strong>${escapeHtml(variant.name)}</strong></td>
                    <td><span class="type-badge ${itemType}"><i class="fas ${typeIcon} me-1"></i>${typeLabel}</span></td>
                    <td>${variant.sub_category_name || subCategory?.name || '-'}</td>
                    <td class="price">$${(variant.price || 0).toFixed(2)}</td>
                    <td>$${(variant.cost || 0).toFixed(2)}</td>
                    <td><span class="status-badge ${variant.is_available ? 'available' : 'unavailable'}">${variant.is_available ? 'Available' : 'Unavailable'}</span></td>
                    <td>
                        <div class="action-btns">
                            <button class="btn btn-outline-info btn-action" onclick="window.menuVariantsPage.ingredients('${variant.id}')" title="Ingredients">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button class="btn btn-outline-${variant.is_available ? 'warning' : 'success'} btn-action" onclick="window.menuVariantsPage.toggle('${variant.id}', ${!variant.is_available})" title="${variant.is_available ? 'Unavailable' : 'Available'}">
                                <i class="fas fa-${variant.is_available ? 'eye-slash' : 'eye'}"></i>
                            </button>
                            <button class="btn btn-outline-primary btn-action" onclick="window.menuVariantsPage.edit('${variant.id}')" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger btn-action" onclick="window.menuVariantsPage.delete('${variant.id}')" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }
    
    function showLoading() {
        document.getElementById('loadingState').classList.remove('d-none');
        document.getElementById('selectCategoryState').classList.add('d-none');
        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('dataTable').classList.add('d-none');
    }
    function showEmpty() {
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('selectCategoryState').classList.add('d-none');
        document.getElementById('emptyState').classList.remove('d-none');
        document.getElementById('dataTable').classList.add('d-none');
    }
    function showSelectCategory() {
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('selectCategoryState').classList.remove('d-none');
        document.getElementById('emptyState').classList.add('d-none');
        document.getElementById('dataTable').classList.add('d-none');
    }
    
    async function openModal(variant = null) {
        editingId = variant?.id || null;

        // Safely set modal title
        const titleEl = document.getElementById('modalTitle');
        if (titleEl) titleEl.textContent = variant ? 'Edit Menu Variant' : 'Add Menu Variant';

        // Safely set form values
        const setValue = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.value = value || '';
        };

        const setChecked = (id, checked) => {
            const el = document.getElementById(id);
            if (el) el.checked = checked;
        };

        setValue('variantId', variant?.id);
        setValue('variantName', variant?.name);
        setValue('variantDescription', variant?.description);
        setValue('variantPrice', variant?.price);
        setValue('variantPrepTime', variant?.preparation_time);
        setValue('variantDisplayOrder', variant?.display_order || 0);
        setChecked('variantAvailable', variant?.is_available !== false);
        setChecked('variantAlcoholic', variant?.is_alcoholic || false);

        // Handle category and sub-category
        if (variant?.sub_category_id) {
            // Find the sub-category to get its category_id
            const subCat = subCategories.find(sc => sc.id === variant.sub_category_id);
            if (subCat?.category_id) {
                SearchableSelect.setValue('#variantCategory', subCat.category_id);
                await loadSubCategoriesForModal();
                SearchableSelect.setValue('#variantSubCategory', variant.sub_category_id);
            } else {
                SearchableSelect.setValue('#variantCategory', '');
                document.getElementById('variantSubCategory').innerHTML = '<option value="">Select a category first</option>';
                SearchableSelect.refresh('#variantSubCategory');
            }
        } else {
            SearchableSelect.setValue('#variantCategory', '');
            document.getElementById('variantSubCategory').innerHTML = '<option value="">Select a category first</option>';
            SearchableSelect.refresh('#variantSubCategory');
        }

        // Parse menu_types JSON
        let menuTypes = [];
        if (variant?.menu_types) {
            try {
                menuTypes = JSON.parse(variant.menu_types);
            } catch (e) {
                menuTypes = ['lunch', 'dinner']; // default
            }
        } else {
            menuTypes = ['lunch', 'dinner']; // default
        }
        setChecked('menuTypeBreakfast', menuTypes.includes('breakfast'));
        setChecked('menuTypeLunch', menuTypes.includes('lunch'));
        setChecked('menuTypeDinner', menuTypes.includes('dinner'));

        if (modal) {
            modal.show();
        } else {
            console.error('Modal not initialized');
        }
    }
    
    async function saveVariant() {
        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        try {
            const token = window.authService.getToken();
            
            // Build menu_types array from checkboxes
            const menuTypes = [];
            if (document.getElementById('menuTypeBreakfast').checked) menuTypes.push('breakfast');
            if (document.getElementById('menuTypeLunch').checked) menuTypes.push('lunch');
            if (document.getElementById('menuTypeDinner').checked) menuTypes.push('dinner');
            if (menuTypes.length === 0) {
                btn.disabled = false;
                btn.innerHTML = 'Save';
                Swal.fire('Error', 'Please select at least one menu type', 'warning');
                return;
            }
            
            const data = {
                name: document.getElementById('variantName').value,
                sub_category_id: document.getElementById('variantSubCategory').value,
                description: document.getElementById('variantDescription').value || null,
                price: parseFloat(document.getElementById('variantPrice').value) || 0,
                preparation_time: parseInt(document.getElementById('variantPrepTime').value) || null,
                display_order: parseInt(document.getElementById('variantDisplayOrder').value) || 0,
                is_available: document.getElementById('variantAvailable').checked,
                is_alcoholic: document.getElementById('variantAlcoholic').checked,
                menu_types: JSON.stringify(menuTypes),
                dietary_tags: JSON.stringify([]),
                allergens: JSON.stringify([])
            };
            const url = editingId ? `${CONFIG.MENU.variants}/${editingId}` : CONFIG.MENU.variants;
            const resp = await fetch(url, { method: editingId ? 'PUT' : 'POST', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            modal.hide();
            Swal.fire({ icon: 'success', title: 'Saved!', timer: 1500, showConfirmButton: false });
            await loadVariants();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
        finally { btn.disabled = false; btn.innerHTML = 'Save'; }
    }
    
    async function toggleAvailability(id, available) {
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.variants}/${id}/availability`, { method: 'PATCH', headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ is_available: available }) });
            if (!resp.ok) throw new Error('Failed');
            await loadVariants();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function deleteVariant(id) {
        const variant = variants.find(v => v.id === id);
        const result = await Swal.fire({ title: 'Delete?', text: `Delete "${variant?.name}"?`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'Delete' });
        if (!result.isConfirmed) return;
        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.variants}/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            Swal.fire({ icon: 'success', title: 'Deleted!', timer: 1500, showConfirmButton: false });
            await loadVariants();
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    // === INGREDIENTS MANAGEMENT ===
    async function openIngredientsModal(menuVariantId) {
        const variant = variants.find(v => v.id === menuVariantId);
        if (!variant) return;

        document.getElementById('ingredientMenuVariantId').value = menuVariantId;
        document.getElementById('ingredientVariantName').textContent = variant.name;
        document.getElementById('newIngredientStockSubCategory').value = '';
        document.getElementById('newIngredientQty').value = '';
        document.getElementById('newIngredientOptional').checked = false;
        document.getElementById('newIngredientNotes').value = '';

        ingredientsModal.show();
        await loadStockVariants();
        populateStockVariantsDropdown();
        await loadIngredients(menuVariantId);
    }
    
    async function loadIngredients(menuVariantId) {
        const listEl = document.getElementById('ingredientsList');
        const loadingEl = document.getElementById('ingredientsLoading');
        const emptyEl = document.getElementById('ingredientsEmpty');
        
        listEl.innerHTML = '';
        loadingEl.classList.remove('d-none');
        emptyEl.classList.add('d-none');
        
        try {
            const token = window.authService.getToken();
            const resp = await fetch(CONFIG.MENU.ingredientsByVariant(menuVariantId), { headers: { 'Authorization': `Bearer ${token}` } });
            if (!resp.ok) throw new Error('Failed');
            const result = await resp.json();
            currentIngredients = result.data?.ingredients || [];
            renderIngredients();
        } catch (e) {
            console.error('Error:', e);
            Swal.fire('Error', 'Failed to load ingredients', 'error');
        } finally {
            loadingEl.classList.add('d-none');
        }
    }
    
    function renderIngredients() {
        const listEl = document.getElementById('ingredientsList');
        const emptyEl = document.getElementById('ingredientsEmpty');
        
        if (!currentIngredients.length) {
            emptyEl.classList.remove('d-none');
            listEl.innerHTML = '';
            document.getElementById('totalCost').textContent = '$0.00';
            return;
        }
        
        emptyEl.classList.add('d-none');
        let totalCost = 0;
        
        listEl.innerHTML = currentIngredients.map(ing => {
            return `
                <div class="ingredient-row">
                    <div class="ingredient-name">
                        <strong>${escapeHtml(ing.stock_variant_name || 'Unknown')}</strong>
                        <small class="text-muted ms-2">(Qty: ${ing.quantity})</small>
                    </div>
                    <input type="number" class="form-control form-control-sm ingredient-qty"
                           value="${ing.quantity}" step="0.01" min="0.01"
                           data-stock-id="${ing.stock_variant_id}"
                           onchange="window.menuVariantsPage.updateIngredient('${ing.id}', '${ing.stock_variant_id}', this.value)">
                    <small class="text-muted" style="width: 80px;">Optional: ${ing.is_optional ? 'Yes' : 'No'}</small>
                    <button class="btn btn-outline-danger btn-sm" onclick="window.menuVariantsPage.removeIngredient('${ing.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        }).join('');
        
        document.getElementById('totalCost').textContent = '$' + totalCost.toFixed(2);
    }
    
    async function addIngredient() {
        const menuVariantId = document.getElementById('ingredientMenuVariantId').value;
        const stockVariantId = document.getElementById('newIngredientStockVariant').value;
        const quantity = parseFloat(document.getElementById('newIngredientQty').value);
        const isOptional = document.getElementById('newIngredientOptional').checked;
        const notes = document.getElementById('newIngredientNotes').value;

        if (!stockVariantId || !quantity || quantity <= 0) {
            Swal.fire('Error', 'Please select a stock variant and enter a valid quantity', 'warning');
            return;
        }

        try {
            const token = window.authService.getToken();
            const url = `${CONFIG.MENU.ingredients}?menu_variant_id=${menuVariantId}`;
            const resp = await fetch(url, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    stock_variant_id: stockVariantId,
                    quantity: quantity,
                    is_optional: isOptional,
                    notes: notes || null
                })
            });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');

            SearchableSelect.setValue('#newIngredientStockVariant', '');
            document.getElementById('newIngredientQty').value = '';
            document.getElementById('newIngredientOptional').checked = false;
            document.getElementById('newIngredientNotes').value = '';
            await loadIngredients(menuVariantId);
            Swal.fire({ icon: 'success', title: 'Added!', timer: 1500, showConfirmButton: false });
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function updateIngredient(ingredientId, stockVariantId, newQuantity) {
        const menuVariantId = document.getElementById('ingredientMenuVariantId').value;
        const quantity = parseFloat(newQuantity);

        if (!quantity || quantity <= 0) {
            Swal.fire('Error', 'Quantity must be greater than 0', 'warning');
            await loadIngredients(menuVariantId);
            return;
        }

        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.ingredients}/${ingredientId}`, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: quantity })
            });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            await loadIngredients(menuVariantId);
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    async function removeIngredient(ingredientId) {
        const menuVariantId = document.getElementById('ingredientMenuVariantId').value;

        const result = await Swal.fire({
            title: 'Remove?', text: 'Remove this ingredient?', icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#dc3545', confirmButtonText: 'Remove'
        });
        if (!result.isConfirmed) return;

        try {
            const token = window.authService.getToken();
            const resp = await fetch(`${CONFIG.MENU.ingredients}/${ingredientId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!resp.ok) throw new Error((await resp.json()).message || 'Failed');
            await loadIngredients(menuVariantId);
            Swal.fire({ icon: 'success', title: 'Removed!', timer: 1500, showConfirmButton: false });
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }
    
    
    function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }
    
    window.menuVariantsPage = {
        edit: (id) => { const variant = variants.find(v => v.id === id); if (variant) openModal(variant); },
        delete: deleteVariant,
        toggle: toggleAvailability,
        ingredients: openIngredientsModal,
        updateIngredient: updateIngredient,
        removeIngredient: removeIngredient
    };
    
    init();
})();
</script>
