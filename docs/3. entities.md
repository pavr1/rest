# ðŸ—„ï¸ Bar-Restaurant Application - Database Entities

## Overview
This document defines all database entities (tables) and their fields required for the bar-restaurant application, based on the requirements in `bar-rest.md`.

---

## Table of Contents

### Service Ownership

| Service | Entities |
|---------|----------|
| **menu-service** (8088) | Menu Categories, Menu Sub-Categories, Menu Variants, Menu Ingredients |
| **inventory-service** (8090) | Stock Categories, Stock Sub-Categories, Stock Variants, Suppliers |
| **invoice-service** (8092) | Income Invoices, Invoice Items, Outcome Invoices |
| **orders-service** (8089) | Orders, Order Items, Payments, Tables, Table Sessions, Request Notifications |
| **customer-service** (8095) | Customers, Customer Favorites, Loyalty Points Transactions, Reviews |
| **karaoke-service** (8093) | Karaoke Song Requests, Karaoke Song Library |
| **promotion-service** (8094) | Promotions, Reservations |
| **session-service** (8087) | Staff, Sessions |

### Menu Service Entities
5. [Menu Categories](#5-menu-categories) - Top-level menu categories (Drinks, Desserts, etc.)
6. [Menu Sub-Categories](#6-menu-sub-categories) - Group related menu variants (Smoothies, Sodas, etc.)
7. [Menu Variants](#7-menu-variants) - Actual orderable items with pricing
8. [Menu Ingredients](#8-menu-ingredients) - Ingredient requirements for menu variants

### Inventory Service Entities
8. [Stock Categories](#8-stock-categories) - Top-level stock organization (Drinks, Alacena, etc.)
9. [Stock Sub-Categories](#9-stock-sub-categories) - Group similar items within categories (Beers, Rice, etc.)
10. [Stock Variants](#10-stock-variants) - Specific item variations with units and quantities (6Pack, 1kg, etc.)
11. [Suppliers](#11-suppliers) - Track stock item suppliers

### Invoice Service Entities
12. [Outcome Invoices](#12-outcome-invoices) - Track expense invoices from suppliers
13. [Income Invoices](#13-income-invoices) - Generate sales invoices for customers
14. [Invoice Items](#14-invoice-items) - Line items for invoices

### Orders Service Entities
1. [Tables](#1-tables) - Manage restaurant tables and their status
3. [Orders](#3-orders) - Manage customer orders
4. [Order Items](#4-order-items) - Individual items within an order with status tracking
16. [Payments](#16-payments) - Track payment transactions
19. [Request Notifications](#19-request-notifications) - Store all customer requests (payment, assistance, etc.)
23. [Table Sessions](#23-table-sessions) - Track table sessions (when table is occupied)

### Customer Service Entities
2. [Customers](#2-customers) - Store customer information for loyalty and promotions
15. [Customer Favorites](#15-customer-favorites) - Store customer favorite menu items
22. [Loyalty Points Transactions](#22-loyalty-points-transactions) - Track loyalty points earned and spent
26. [Reviews](#26-reviews) - Customer reviews and ratings

### Karaoke Service Entities
20. [Karaoke Song Requests](#20-karaoke-song-requests) - Manage karaoke song requests
21. [Karaoke Song Library](#21-karaoke-song-library) - Available songs in karaoke library

### Promotion Service Entities
24. [Reservations](#24-reservations) - Table reservations
25. [Promotions](#25-promotions) - Promotional campaigns

### Session Service Entities
18. [Staff](#18-staff) - Staff accounts and authentication

---

## Core Entities

### 1. Tables
**Purpose**: Manage restaurant tables and their status

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique table identifier |
| table_number | VARCHAR(10) | UNIQUE, NOT NULL | Table number/identifier |
| capacity | INTEGER | NOT NULL, DEFAULT 4 | Maximum number of people |
| status | ENUM | NOT NULL, DEFAULT 'available' | Table status: available, occupied, reserved |
| floor_plan_position | JSON | NULLABLE | Position coordinates for floor plan visualization |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Status Values**: `available`, `occupied`, `reserved`

**Notes**:
- QR codes are generated dynamically: `{ordering_link}/{table_number}` for orders, `{karaoke_link}/{table_number}` for karaoke
- QR codes are not stored in database - generated in real-time or via third-party service
- Table number is used to generate QR codes on-the-fly

---

### 1. Customers
**Purpose**: Store customer information for loyalty and promotions

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique customer identifier |
| customer_id | VARCHAR(50) | UNIQUE, NOT NULL | CÃ©dula/identification number |
| name | VARCHAR(255) | NOT NULL | Customer full name (first name + last name) |
| phone | VARCHAR(20) | NOT NULL | Phone number |
| email | VARCHAR(255) | NULLABLE | Email address (optional) |
| date_of_birth | DATE | NULLABLE | Date of birth (for birthday promotions) |
| loyalty_points | INTEGER | DEFAULT 0 | Current loyalty points balance |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | First visit timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- **Customer record is only created when customer opts into loyalty program**
- Flow: Customer scans QR â†’ app asks FIRST if they want loyalty program
  - **If YES**: Customer provides ID, Name (first name + last name), Phone (all required), Email (optional), Date of Birth (optional) â†’ customer record created
  and Customer ID stored in a cookie (non-expired), so next time logged the system will recognize that id and create orders under it.
  - **If NO**: Customer enters simple name only â†’ NO customer record created (order uses only person_name)
- All fields except email and date_of_birth are REQUIRED when record exists (ID, Name, Phone are NOT NULL)
- Name field stores full name (first name + last name) for loyalty program members
- `date_of_birth` is optional but enables birthday promotions (if provided, customer becomes eligible for birthday promotions)
- Customer can be identified by `customer_id` or `phone` for lookup

---

### 2. Orders
**Purpose**: Manage customer orders

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique order identifier |
| table_id | UUID | FOREIGN KEY â†’ tables.id, NOT NULL | Table where order was placed |
| customer_id | UUID | FOREIGN KEY â†’ customers.id, NULLABLE | Customer record (only if customer opted into loyalty program) |
| customer_name | VARCHAR(255) | CONDITIONAL NOT NULL | Customer name (see notes for conditional requirement) |
| status | ENUM | NOT NULL, DEFAULT 'created' | Order status: created, preparing, paid, cancelled |
| payment_status | ENUM | NOT NULL, DEFAULT 'unpaid' | Payment status: unpaid, requested, paid, refunded |
| payment_requested_at | TIMESTAMP | NULLABLE | When customer requested payment |
| paid_at | TIMESTAMP | NULLABLE | When order was paid |
| promotion_id | UUID | FOREIGN KEY â†’ promotions.id, NULLABLE | Promotion applied to this order |
| total_amount | DECIMAL(10,2) | DEFAULT 0.00 | Total order amount |
| promotion_discount_amount | DECIMAL(10,2) | DEFAULT 0.00 | Discount amount from promotion (if applied) |
| tax_amount | DECIMAL(10,2) | DEFAULT 0.00 | Tax amount |
| service_charge | DECIMAL(10,2) | DEFAULT 0.00 | Service charge amount |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Order creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |
| confirmed_at | TIMESTAMP | NULLABLE | When customer confirmed order |

**Status Values**: `created`, `preparing`, `paid`, `cancelled`
**Payment Status Values**: `unpaid`, `requested`, `paid`, `refunded`

**Notes**:
- **Customer Name Logic**:
  - If `customer_id` is NOT NULL: `customer_name` is populated from customer record (name field)
  - If `customer_id` is NULL: `customer_name` is REQUIRED (entered by customer, simple name)
- Multiple orders can exist for the same table simultaneously
- Each order is independent and can be paid separately
- `customer_id` is nullable - only set if customer opted into loyalty program
- Flow: App asks FIRST if customer wants loyalty program â†’ if YES, customer provides full info (ID, first+last name, phone) and record created; if NO, customer enters simple name only
- **Status Rules**:
  - `created`: Order has been created and confirmed
  - `preparing`: Order has started being worked on (at least one item status is "Preparing" or beyond)
  - `paid`: Order has been paid
  - `cancelled`: Order was cancelled
  - **If status is `cancelled`, payment_status remains `unpaid`** (cancelled orders are not paid)
- **Promotion Logic**:
  - **Time-based promotions** (`happy_hour`, `daily_deal`, `seasonal`): If order is created within promotion's time window (`start_date` to `end_date`), automatically apply `promotion_id` to order
  - **Customer-specific promotions** (`birthday`, `loyalty_reward`): 
    - For `loyalty_reward`: Check if customer has enough `loyalty_points` (must have â‰¥ `promotion.points_required`)
    - If eligible: Create negative loyalty points transaction (mark points as "used"), apply `promotion_id` to order, calculate `promotion_discount_amount`
    - For `birthday`: Check if customer's birthday matches current date (implementation detail)
  - Only one promotion can be applied per order
  - `promotion_discount_amount` stores the calculated discount based on `discount_type` and `discount_value`

---

### 3. Order Items
**Purpose**: Individual items within an order with status tracking

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique order item identifier |
| order_id | UUID | FOREIGN KEY â†’ orders.id, NOT NULL | Parent order |
| menu_item_id | UUID | FOREIGN KEY â†’ menu_items.id, NOT NULL | Menu item reference |
| quantity | INTEGER | NOT NULL, DEFAULT 1 | Quantity ordered |
| unit_price | DECIMAL(10,2) | NOT NULL | Price at time of order |
| subtotal | DECIMAL(10,2) | NOT NULL | Quantity Ã— unit_price |
| status | ENUM | NOT NULL, DEFAULT 'requested' | Item status: requested, preparing, ready, delivered, lost |
| order_type | ENUM | NULLABLE | "For Here" or "To Go" (food items only) |
| special_instructions | TEXT | NULLABLE | Special instructions/comments |
| lost_reason | VARCHAR(255) | NULLABLE | Reason for loss (if status = lost) |
| fault_type | ENUM | NULLABLE | Fault type: restaurant_fault, customer_fault (if lost) |
| lost_cost | DECIMAL(10,2) | NULLABLE | Cost lost (if restaurant fault) - calculated proportionally based on quantity lost |
| requested_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | When item was requested |
| preparing_at | TIMESTAMP | NULLABLE | When item status changed to preparing |
| ready_at | TIMESTAMP | NULLABLE | When item status changed to ready |
| delivered_at | TIMESTAMP | NULLABLE | When item status changed to delivered |
| lost_at | TIMESTAMP | NULLABLE | When item status changed to lost |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Status Values**: `requested`, `preparing`, `ready`, `delivered`, `lost`
**Order Type Values**: `for_here`, `to_go` (NULL for drinks)
**Fault Type Values**: `restaurant_fault`, `customer_fault`

**Notes**:
- Each item has individual status tracking
- Time tracking for each status transition
- Lost items require reason and fault determination
- Order type only applies to food items (drinks don't have this)
- **Lost Cost Calculation**: If an order item has `quantity > 1` but only some dishes are lost, `lost_cost` is calculated proportionally:
  - Example: If quantity = 2, unit_price = $10, subtotal = $20, but only 1 dish is lost â†’ `lost_cost` = $10 (half the subtotal, or unit_price Ã— quantity_lost)
  - Only applies when `fault_type = 'restaurant_fault'`

---

### 4. Menu Categories
**Purpose**: Top-level menu categories (e.g., Drinks, Desserts, Appetizers)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique category identifier |
| name | VARCHAR(255) | NOT NULL, UNIQUE | Category name (Drinks, Desserts, Appetizers, etc.) |
| display_order | INTEGER | NOT NULL, DEFAULT 0 | Order for display in menu |
| description | TEXT | NULLABLE | Category description |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- Top level of the menu hierarchy
- Examples: "Drinks", "Desserts", "Appetizers", "Main Courses"

---

### 6. Menu Sub-Categories
**Purpose**: Group related menu variants within a category (e.g., Smoothies under Drinks)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique sub-category identifier |
| name | VARCHAR(255) | NOT NULL | Sub-category name (e.g., Smoothies, Sodas, Cocktails) |
| description | TEXT | NULLABLE | Sub-category description |
| category_id | UUID | FOREIGN KEY â†’ menu_categories.id, NOT NULL | Parent menu category |
| item_type | ENUM | NOT NULL | Item type: kitchen, bar (inherited by all menu variants) |
| display_order | INTEGER | NOT NULL, DEFAULT 0 | Order for display in menu |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Whether sub-category is active/visible |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Item Type Values**: `kitchen`, `bar`

**Notes**:
- Second level of menu hierarchy (under Menu Categories)
- Groups similar menu variants together (e.g., all smoothie variants under "Smoothies")
- `item_type` determines which station (kitchen or bar) prepares all variants in this sub-category
- Does NOT have pricing information - that's at the Menu Variants level
- Examples:
  - Category "Drinks" â†’ Sub-Category "Smoothies" (item_type: bar)
  - Category "Drinks" â†’ Sub-Category "Sodas" (item_type: bar)
  - Category "Desserts" â†’ Sub-Category "Ice Cream" (item_type: kitchen)

---

### 7. Menu Variants
**Purpose**: Actual orderable items with pricing (e.g., Banana Smoothie, Pineapple Smoothie)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique menu variant identifier |
| name | VARCHAR(255) | NOT NULL | Variant name (e.g., Banana Smoothie, Coca Cola) |
| description | TEXT | NULLABLE | Variant description |
| sub_category_id | UUID | FOREIGN KEY â†’ menu_sub_categories.id, NOT NULL | Parent sub-category |
| price | DECIMAL(10,2) | NOT NULL | Selling price (price customer pays) |
| item_cost | DECIMAL(10,2) | NULLABLE | Item cost (calculated from stock variants) |
| happy_hour_price | DECIMAL(10,2) | NULLABLE | Happy hour price |
| image_url | VARCHAR(500) | NULLABLE | Variant image URL |
| is_available | BOOLEAN | NOT NULL, DEFAULT true | Availability flag (staff can toggle) |
| preparation_time | INTEGER | NULLABLE | Estimated preparation time in minutes |
| menu_types | JSON | NOT NULL | Array of menu types: ["breakfast"], ["lunch"], ["dinner"], or combinations |
| dietary_tags | JSON | NULLABLE | Array of dietary tags: ["vegetarian", "vegan", "gluten-free"] |
| allergens | JSON | NULLABLE | Array of allergens: ["nuts", "dairy", "eggs"] |
| is_alcoholic | BOOLEAN | DEFAULT false | Whether variant contains alcohol |
| display_order | INTEGER | NOT NULL, DEFAULT 0 | Order for display in menu |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Menu Types**: Array of strings: `["breakfast"]`, `["lunch"]`, `["dinner"]`, or combinations like `["lunch", "dinner"]`

**Notes**:
- Third and final level of menu hierarchy (under Menu Sub-Categories)
- These are the actual variants customers order
- `item_type` is inherited from the parent Menu Sub-Category (not stored here)
- `item_cost` will be calculated from stock variants (implementation TBD)
- Income (profit) = `price` - `item_cost`
- `is_available` can be toggled by staff in real-time (e.g., when out of stock)
- `menu_types` determines which time-based menu(s) the variant appears in
- `preparation_time` helps kitchen/bar estimate order completion
- Examples:
  - Sub-Category "Smoothies" â†’ Menu Variant "Banana Smoothie" ($5.99)
  - Sub-Category "Smoothies" â†’ Menu Variant "Pineapple Smoothie" ($6.49)
  - Sub-Category "Sodas" â†’ Menu Variant "Coca Cola" ($2.99)

**Menu Hierarchy Example**:
```
Menu Category: Drinks
  â””â”€â”€ Menu Sub-Category: Smoothies (item_type: bar)
        â”œâ”€â”€ Menu Variant: Banana Smoothie ($5.99, prep_time: 5min)
        â”œâ”€â”€ Menu Variant: Pineapple Smoothie ($6.49, prep_time: 5min)
        â””â”€â”€ Menu Variant: Strawberry Smoothie ($5.99, prep_time: 5min)
  â””â”€â”€ Menu Sub-Category: Sodas (item_type: bar)
        â”œâ”€â”€ Menu Variant: Coca Cola ($2.99)
        â”œâ”€â”€ Menu Variant: Sprite ($2.99)
        â””â”€â”€ Menu Variant: Fanta ($2.99)
```

---

### 8. Menu Ingredients
**Purpose**: Define ingredient requirements for menu variants (links menu variants to stock sub-categories)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique ingredient requirement identifier |
| menu_variant_id | UUID | FOREIGN KEY â†’ menu_variants.id, NOT NULL | Menu variant that requires this ingredient |
| stock_sub_category_id | UUID | FOREIGN KEY â†’ stock_sub_categories.id, NOT NULL | Required stock sub-category |
| quantity | DECIMAL(10,2) | NOT NULL | Quantity required (in standard units for the sub-category) |
| is_optional | BOOLEAN | NOT NULL, DEFAULT false | Whether this ingredient is optional |
| notes | TEXT | NULLABLE | Preparation notes for this ingredient |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- Links individual menu variants to their required stock sub-categories
- `quantity` specifies how much of the stock sub-category is needed (in standard units)
- Examples:
  - "Casado con Pollo" requires 1 quantity of "Pollo" (chicken), 2 quantities of "Arroz" (rice), 1 quantity of "Frijoles" (beans)
  - "Banana Smoothie" requires 2 quantities of "Bananas" (from stock sub-category "Bananas")
- Enables inventory tracking and cost calculation for menu items
- `is_optional` allows for ingredient substitutions or omissions

---

### Menu Service Entities
5. [Menu Categories](#5-menu-categories) - Top-level menu categories (Drinks, Desserts, etc.)
6. [Menu Sub-Categories](#6-menu-sub-categories) - Group related menu variants (Smoothies, Sodas, etc.)
7. [Menu Variants](#7-menu-variants) - Actual orderable items with pricing
8. [Menu Ingredients](#8-menu-ingredients) - Ingredient requirements for menu variants

### 8. Stock Categories
**Purpose**: Top-level stock organization categories (e.g., Drinks, Alacena, Meat, Vegetables)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique category identifier |
| name | VARCHAR(255) | NOT NULL, UNIQUE | Category name (Drinks, Alacena, Meat, Vegetables, etc.) |
| description | TEXT | NULLABLE | Category description |
| display_order | INTEGER | NOT NULL, DEFAULT 0 | Order for display in inventory management |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Whether category is active/visible |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- Top level of the inventory hierarchy
- Examples: "Drinks", "Alacena", "Carnes", "Frutas y Verduras", "Bebidas", "ReposterÃ­a"
- Categories can contain multiple sub-categories

---

### 9. Stock Sub-Categories
**Purpose**: Group similar items within stock categories (e.g., Beers under Drinks, Rice under Alacena)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique sub-category identifier |
| name | VARCHAR(255) | NOT NULL | Sub-category name (Beers, Iced Tea, Rice, etc.) |
| description | TEXT | NULLABLE | Sub-category description |
| stock_category_id | UUID | FOREIGN KEY â†’ stock_categories.id, NOT NULL | Parent stock category |
| display_order | INTEGER | NOT NULL, DEFAULT 0 | Order for display in inventory management |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Whether sub-category is active/visible |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- Second level of the inventory hierarchy (under Stock Categories)
- Groups similar items together for better organization
- Examples:
  - Category "Drinks" â†’ Sub-Category "Beers"
  - Category "Drinks" â†’ Sub-Category "Iced Tea"
  - Category "Alacena" â†’ Sub-Category "Rice"

---

### 10. Stock Variants
**Purpose**: Specific item variations with units and quantities (e.g., 6Pack, 1kg, individual)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique variant identifier |
| name | VARCHAR(255) | NOT NULL | Variant name (6Pack, 12Pack, 1kg, 2kg, individual, etc.) |
| stock_sub_category_id | UUID | FOREIGN KEY â†’ stock_sub_categories.id, NOT NULL | Parent sub-category |
| unit | VARCHAR(50) | NOT NULL | Unit of measurement (Kg, g, L, ML, Unit, Box, Bottle, Bag) |
| number_of_units | DECIMAL(10,2) | NOT NULL | Number of units in this variant (e.g., 6 for 6Pack, 1 for individual) |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Whether variant is active/available |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Unit Values**: `Kg`, `g`, `L`, `ML`, `Unit`, `Box`, `Bottle`, `Bag`, etc.

**Notes**:
- Third level of the inventory hierarchy (under Stock Sub-Categories)
- Defines specific variations of items with their units and quantities
- Examples:
  - Sub-Category "Beers" â†’ Variant "6Pack" (unit: "Bottle", number_of_units: 6)
  - Sub-Category "Beers" â†’ Variant "individual" (unit: "Bottle", number_of_units: 1)
  - Sub-Category "Rice" â†’ Variant "1kg" (unit: "Kg", number_of_units: 1)
  - Sub-Category "Rice" â†’ Variant "8kg" (unit: "Kg", number_of_units: 8)


---

### 11. Suppliers
**Purpose**: Track stock item suppliers

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique supplier identifier |
| name | VARCHAR(255) | NOT NULL, UNIQUE | Supplier name |
| contact_name | VARCHAR(255) | NULLABLE | Contact person name |
| phone | VARCHAR(20) | NULLABLE | Phone number |
| email | VARCHAR(255) | NULLABLE | Email address |
| address | TEXT | NULLABLE | Supplier address |
| notes | TEXT | NULLABLE | Additional notes |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

---

### 12. Outcome Invoices
**Purpose**: Track expense invoices from suppliers

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique invoice identifier |
| invoice_number | VARCHAR(100) | NOT NULL, UNIQUE | Invoice number from supplier |
| supplier_id | UUID | FOREIGN KEY â†’ suppliers.id, NULLABLE | Supplier reference |
| transaction_date | DATE | NOT NULL | Invoice date |
| total_amount | DECIMAL(12,2) | NULLABLE | Total invoice amount |
| image_url | VARCHAR(500) | NULLABLE | Scanned invoice image URL |
| notes | TEXT | NULLABLE | Additional notes |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Relationships**:
- Has many invoice_items (via invoice_id with invoice_type='outcome')

**Notes**:
- Outcome invoices track stock item purchases from suppliers
- Used to create/update stock items when invoices are processed

---

### 13. Income Invoices
**Purpose**: Generate income invoices for customers (Costa Rica compliance)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique invoice identifier |
| order_id | UUID | FOREIGN KEY â†’ orders.id, NOT NULL | Related order |
| payment_id | UUID | FOREIGN KEY â†’ payments.id, NULLABLE | Related payment |
| customer_id | VARCHAR(50) | NULLABLE | Customer tax ID (CÃ©dula) - primary customer identifier |
| invoice_number | VARCHAR(50) | UNIQUE, NOT NULL | Sequential invoice number |
| invoice_type | ENUM | NOT NULL | Invoice type: sales, credit_note |
| subtotal | DECIMAL(10,2) | NOT NULL | Subtotal before taxes |
| tax_amount | DECIMAL(10,2) | NOT NULL | Tax amount |
| service_charge | DECIMAL(10,2) | DEFAULT 0.00 | Service charge |
| total_amount | DECIMAL(10,2) | NOT NULL | Total amount |
| payment_method | VARCHAR(50) | NOT NULL | Payment method used |
| xml_data | TEXT | NULLABLE | XML invoice data (Costa Rica Factura ElectrÃ³nica) |
| digital_signature | TEXT | NULLABLE | Digital signature (if required) |
| status | ENUM | NOT NULL, DEFAULT 'draft' | Invoice status: draft, generated, sent, cancelled |
| generated_at | TIMESTAMP | NULLABLE | When invoice was generated |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Invoice Type Values**: `sales`, `credit_note`
**Status Values**: `draft`, `generated`, `sent`, `cancelled`

**Relationships**:
- Has many invoice_items (via invoice_id with invoice_type='income')

**Notes**:
- Customer ID (customer_id) is the primary identifier for Costa Rican invoices
- Customer name should be retrieved from customers table using tax ID when needed
- Customer details are editable before payment is processed
- Invoice generation requires research (likely when staff requests)
- Costa Rica compliance requirements need investigation

---

### 14. Invoice Items
**Purpose**: Line items for invoices (purchased items)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique invoice item identifier |
| invoice_id | UUID | NOT NULL | Parent invoice ID (references income_invoices.id or outcome_invoices.id) |
| invoice_type | VARCHAR(20) | NOT NULL | Invoice type: 'income' or 'outcome' |
| stock_variant_id | UUID | FOREIGN KEY â†’ stock_variants.id, NULLABLE | Associated stock variant |
| detail | TEXT | NOT NULL | Item description/name |
| count | DECIMAL(10,2) | NOT NULL, CHECK (count > 0) | Quantity purchased |
| unit_type | VARCHAR(50) | NOT NULL | Unit type (gallon, bottle, unit, liter, kg, etc.) |
| price | DECIMAL(10,2) | NOT NULL, CHECK (price > 0) | Price per unit |
| items_per_unit | INTEGER | NOT NULL, DEFAULT 1, CHECK (items_per_unit > 0) | Items per unit (e.g., 31 ice cream balls per gallon) |
| total | DECIMAL(12,2) | GENERATED ALWAYS AS (count Ã— price) STORED | Total cost (count Ã— price) |
| expiration_date | DATE | NULLABLE | Expiration date (if applicable) |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- Invoice items represent individual line items in both income and outcome invoices
- `invoice_type` field distinguishes between 'income' (customer sales) and 'outcome' (supplier purchases)
- `items_per_unit` allows tracking of sub-units (e.g., 31 ice cream balls per gallon)
- Examples: Invoice item for "Bottled Beer" with count=24, unit_type="bottle"

---

---

### 15. Customer Favorites
**Purpose**: Store customer favorite menu items

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique favorite identifier |
| customer_id | UUID | FOREIGN KEY â†’ customers.id, NOT NULL | Customer reference |
| menu_item_id | UUID | FOREIGN KEY â†’ menu_items.id, NOT NULL | Menu item reference |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | When item was favorited |

**Notes**:
- Requires customer to have provided ID/phone (customer_id must exist)
- Favorites persist across visits

---

### 16. Payments
**Purpose**: Track payment transactions

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique payment identifier |
| order_id | UUID | FOREIGN KEY â†’ orders.id, NOT NULL | Order being paid |
| amount | DECIMAL(10,2) | NOT NULL | Payment amount |
| payment_method | ENUM | NOT NULL | Payment method used |
| payment_status | ENUM | NOT NULL, DEFAULT 'pending' | Payment status |
| exact_change_amount | DECIMAL(10,2) | NULLABLE | Exact change amount (for cash payments) |
| cash_amount_provided | DECIMAL(10,2) | NULLABLE | Cash amount customer provided (for exact change calculation) |
| tip_amount | DECIMAL(10,2) | DEFAULT 0.00 | Tip amount |
| processed_by_staff_id | UUID | FOREIGN KEY â†’ staff.id, NULLABLE | Staff member who processed payment |
| transaction_id | VARCHAR(255) | NULLABLE | External transaction ID (for card/digital payments) |
| processed_at | TIMESTAMP | NULLABLE | When payment was processed |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Payment request timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Payment Method Values**: `cash`, `credit_card`, `debit_card`, `apple_pay`, `google_pay`
**Payment Status Values**: `pending`, `processing`, `completed`, `failed`, `refunded`

**Notes**:
- All payments are waiter-assisted
- Cash payments require exact change calculation

---

### 17. Staff
**Purpose**: Staff accounts and authentication

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique staff identifier |
| username | VARCHAR(100) | UNIQUE, NOT NULL | Username for login |
| email | VARCHAR(255) | UNIQUE, NULLABLE | Staff email |
| password_hash | VARCHAR(255) | NOT NULL | Hashed password |
| first_name | VARCHAR(255) | NOT NULL | First name |
| last_name | VARCHAR(255) | NOT NULL | Last name |
| role | ENUM | NOT NULL | Staff role |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Whether staff member is active |
| last_login_at | TIMESTAMP | NULLABLE | Last login timestamp |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Role Values**: `waiter`, `bartender`, `chef`, `manager`, `admin`, `dj_karaoke_operator`

---

### 18. Sessions
**Purpose**: Session token storage for authentication

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| session_id | VARCHAR(255) | PRIMARY KEY | Unique session identifier |
| token | TEXT | NOT NULL | Session token (JWT or similar) |

**Notes**:
- Simple key-value storage for session tokens
- Session ID maps to the token for validation
- Managed by session service for authentication

---

### 18. Request Notifications
**Purpose**: Store all customer requests (payment, assistance, etc.)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique notification identifier |
| request_type | ENUM | NOT NULL | Type of request |
| table_id | UUID | FOREIGN KEY â†’ tables.id, NOT NULL | Table making request |
| order_id | UUID | FOREIGN KEY â†’ orders.id, NULLABLE | Related order (if applicable) |
| customer_name | VARCHAR(255) | NULLABLE | Customer name (if applicable) |
| message | TEXT | NULLABLE | Additional message/details |
| status | ENUM | NOT NULL, DEFAULT 'pending' | Request status |
| handled_by_staff_id | UUID | FOREIGN KEY â†’ staff.id, NULLABLE | Staff member handling request |
| handled_at | TIMESTAMP | NULLABLE | When request was handled |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Request timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Request Type Values**: `payment`, `assistance`, `refill`, `issue_report`, `special_request`
**Status Values**: `pending`, `in_progress`, `completed`, `cancelled`

**Notes**:
- All requests stored in FIFO queue
- UI retrieves from this table to display notifications

---

### 19. Karaoke Song Requests
**Purpose**: Manage karaoke song requests

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique song request identifier |
| table_id | UUID | FOREIGN KEY â†’ tables.id, NOT NULL | Table requesting song |
| customer_name | VARCHAR(255) | NOT NULL | Customer name (no ID/phone stored) |
| song_title | VARCHAR(255) | NOT NULL | Song title |
| artist_name | VARCHAR(255) | NOT NULL | Artist name |
| status | ENUM | NOT NULL, DEFAULT 'queued' | Song status |
| position_in_queue | INTEGER | NOT NULL | Position in FIFO queue |
| skip_reason | TEXT | NULLABLE | Reason if song was skipped |
| skipped_by_staff_id | UUID | FOREIGN KEY â†’ staff.id, NULLABLE | Staff who skipped song |
| started_at | TIMESTAMP | NULLABLE | When song started playing |
| completed_at | TIMESTAMP | NULLABLE | When song finished |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Request timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Status Values**: `queued`, `playing`, `completed`, `skipped`, `removed`

**Notes**:
- Queue is FIFO (first in, first out) - cannot be reordered
- No customer data persistence (name only, not linked to customers table)

---

### 20. Karaoke Song Library
**Purpose**: Available songs in karaoke library

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique song identifier |
| song_title | VARCHAR(255) | NOT NULL | Song title |
| artist_name | VARCHAR(255) | NOT NULL | Artist name |
| duration_estimate | INTEGER | NULLABLE | Estimated duration in seconds |
| is_available | BOOLEAN | NOT NULL, DEFAULT true | Whether song is available |
| popularity_count | INTEGER | DEFAULT 0 | Number of times requested |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Notes**:
- Used for pre-populating song names and artists (if feasible)

---

### 21. Loyalty Points Transactions
**Purpose**: Track loyalty points earned and spent

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique transaction identifier |
| customer_id | UUID | FOREIGN KEY â†’ customers.id, NOT NULL | Customer earning/spending points |
| order_id | UUID | FOREIGN KEY â†’ orders.id, NULLABLE | Related order (if points from purchase) |
| transaction_type | ENUM | NOT NULL | Transaction type |
| points | INTEGER | NOT NULL | Points amount (positive for earned, negative for spent) |
| description | VARCHAR(255) | NULLABLE | Transaction description |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Transaction timestamp |

**Transaction Type Values**: `earned`, `spent`, `expired`, `bonus`, `referral`

**Notes**:
- Points accumulate based on purchases (`earned` transactions)
- Points can be spent on rewards/discounts (`spent` transactions)
- When a customer uses a `loyalty_reward` promotion:
  - A `spent` transaction is created with `points` = negative value (e.g., -100)
  - `order_id` links to the order where promotion was applied
  - Customer's `loyalty_points` balance is decremented accordingly

---

### 22. Table Sessions
**Purpose**: Track table sessions (when table is occupied)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique session identifier |
| table_id | UUID | FOREIGN KEY â†’ tables.id, NOT NULL | Table for this session |
| started_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Session start time |
| ended_at | TIMESTAMP | NULLABLE | Session end time (when staff clears session) |
| cleared_by_staff_id | UUID | FOREIGN KEY â†’ staff.id, NULLABLE | Staff member who cleared session |
| status | ENUM | NOT NULL, DEFAULT 'active' | Session status |

**Status Values**: `active`, `closed`

**Notes**:
- Session ends when staff clears it after all orders are paid
- Prevents new orders until session is cleared

---

## Advanced Features Entities (Future)

### 23. Reservations
**Purpose**: Table reservations (future feature)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique reservation identifier |
| table_id | UUID | FOREIGN KEY â†’ tables.id, NOT NULL | Reserved table |
| customer_id | UUID | FOREIGN KEY â†’ customers.id, NULLABLE | Customer (if known) |
| customer_name | VARCHAR(255) | NOT NULL | Customer name |
| customer_phone | VARCHAR(20) | NOT NULL | Customer phone |
| reservation_date | DATE | NOT NULL | Reservation date |
| reservation_time | TIME | NOT NULL | Reservation time |
| party_size | INTEGER | NOT NULL | Number of people |
| status | ENUM | NOT NULL, DEFAULT 'confirmed' | Reservation status |
| special_requests | TEXT | NULLABLE | Special requests/preferences |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Status Values**: `confirmed`, `cancelled`, `completed`, `no_show`

---

### 24. Promotions
**Purpose**: Promotional campaigns (future feature)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique promotion identifier |
| name | VARCHAR(255) | NOT NULL | Promotion name |
| description | TEXT | NULLABLE | Promotion description |
| promotion_type | ENUM | NOT NULL | Promotion type: happy_hour, daily_deal, seasonal, birthday, loyalty_reward |
| discount_type | ENUM | NOT NULL | Discount type: percentage, fixed_amount |
| discount_value | DECIMAL(10,2) | NOT NULL | Discount value |
| points_required | INTEGER | NULLABLE | Points required for loyalty_reward promotions (only for promotion_type = 'loyalty_reward') |
| recurrence_type | ENUM | NOT NULL, DEFAULT 'none' | Recurrence pattern: none, daily, weekly, monthly |
| start_date | DATE | NOT NULL | Promotion start date (first occurrence or single date) |
| end_date | DATE | NULLABLE | Promotion end date (NULL = never ends, continues indefinitely) |
| from_time | TIME | NOT NULL | Start time within day (e.g., 15:00 for 3pm) |
| to_time | TIME | NOT NULL | End time within day (e.g., 16:00 for 4pm) |
| days_of_week | JSON | NULLABLE | Days of week for weekly recurrence: ["monday", "friday"] or ["friday"] (only for recurrence_type = 'weekly') |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Whether promotion is active |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Promotion Type Values**: `happy_hour`, `daily_deal`, `seasonal`, `birthday`, `loyalty_reward`
**Discount Type Values**: `percentage`, `fixed_amount`
**Recurrence Type Values**: `none`, `daily`, `weekly`, `monthly`

**Notes**:
- **Recurrence Patterns**:
  - `none`: Single occurrence promotion (runs from `start_date` to `end_date`, or indefinitely if `end_date` is NULL)
  - `daily`: Repeats every day from `start_date` to `end_date` (or indefinitely), between `from_time` and `to_time`
  - `weekly`: Repeats on specified days of week (`days_of_week` JSON array) from `start_date` to `end_date` (or indefinitely), between `from_time` and `to_time`
    - Example: `days_of_week: ["friday"]` for "Every Friday from 3pm to 4pm"
    - Example: `days_of_week: ["monday", "wednesday", "friday"]` for "Every Monday, Wednesday, Friday"
  - `monthly`: Repeats on the same day of month each month (e.g., 15th of every month)
- **Time Windows**:
  - `from_time` and `to_time` are ALWAYS required (NOT NULL)
  - Defines the time window within each day when the promotion is active
  - Example: Happy hour every Friday 3pm-4pm requires `from_time='15:00'` and `to_time='16:00'`
- **End Date**:
  - `end_date` can be NULL for promotions that never end (run indefinitely)
  - If `end_date` is set, promotion stops recurring after that date
- **Promotion Application Logic**:
  - **Time-based promotions** (`happy_hour`, `daily_deal`, `seasonal`): Apply to ALL orders created within promotion's active time window (checks `start_date`/`end_date`, `from_time`/`to_time`, and `days_of_week` if weekly)
  - **Customer-specific promotions**:
    - `loyalty_reward`: Requires customer to have `loyalty_points` â‰¥ `points_required`. When applied, points are deducted (negative transaction in `loyalty_points_transactions`)
    - `birthday`: Requires customer's birthday to match current date (customer eligibility check needed)
  - Promotions are applied at order creation time
  - Only one promotion can be applied per order
  - `points_required` is only used for `promotion_type = 'loyalty_reward'` (NULL for other types)
- **Examples**:
  - Happy Hour every Friday 3pm-4pm: `recurrence_type='weekly'`, `days_of_week=["friday"]`, `from_time='15:00'`, `to_time='16:00'`, `start_date='2024-01-01'`, `end_date=NULL` (never ends)
  - Daily deal for one month: `recurrence_type='daily'`, `start_date='2024-01-01'`, `end_date='2024-01-31'`, `from_time='12:00'`, `to_time='14:00'`
  - One-time seasonal promotion: `recurrence_type='none'`, `start_date='2024-12-01'`, `end_date='2024-12-31'`, `from_time='10:00'`, `to_time='22:00'`

---

### 25. Reviews
**Purpose**: Customer reviews and ratings (future feature)

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PRIMARY KEY | Unique review identifier |
| customer_id | UUID | FOREIGN KEY â†’ customers.id, NULLABLE | Customer (if provided ID/phone) |
| order_id | UUID | FOREIGN KEY â†’ orders.id, NULLABLE | Related order |
| menu_item_id | UUID | FOREIGN KEY â†’ menu_items.id, NULLABLE | Item being reviewed |
| rating | INTEGER | NOT NULL | Rating (1-5 stars) |
| comment | TEXT | NULLABLE | Review comment |
| is_moderated | BOOLEAN | NOT NULL, DEFAULT false | Whether review has been moderated |
| is_approved | BOOLEAN | NULLABLE | Whether review was approved |
| created_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Review timestamp |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT NOW() | Last update timestamp |

---

## Entity Relationships Summary

### Menu Hierarchy:
```
Menu Categories (1) â”€â”€< (many) Menu Sub-Categories (1) â”€â”€< (many) Menu Variants
     â”‚                                 â”‚                              â”‚
     â””â”€â”€ Drinks                       â””â”€â”€ Smoothies                 â””â”€â”€ Banana Smoothie ($5.99)
     â””â”€â”€ Desserts                     â””â”€â”€ Sodas                     â””â”€â”€ Pineapple Smoothie ($6.49)
                                      â””â”€â”€ Ice Cream                 â””â”€â”€ Coca Cola ($2.99)
```

### Menu-Stock Relationships:
```
Menu Variants â”€â”€< (many) Menu Ingredients >â”€â”€ Stock Sub-Categories
     â”‚                                              â”‚
     â””â”€â”€ Casado con Pollo                        â””â”€â”€ Pollo (chicken)
     â””â”€â”€ Banana Smoothie                          â””â”€â”€ Bananas
                                                   â””â”€â”€ Leche (milk)
```

### Inventory Hierarchy:
```
Stock Categories (1) â”€â”€< (many) Stock Sub-Categories (1) â”€â”€< (many) Stock Variants
       â”‚                              â”‚                               â”‚
       â””â”€â”€ Drinks                    â””â”€â”€ Beers                       â””â”€â”€ 6Pack
       â””â”€â”€ Alacena                   â””â”€â”€ Rice                        â””â”€â”€ 1kg
                                      â””â”€â”€ Iced Tea                   â””â”€â”€ individual
                                                                    â””â”€â”€ 12Pack
```

### Primary Relationships:

**Orders Service Relationships:**
- **Tables** â†’ **Orders** (one-to-many)
- **Orders** â†’ **Order Items** (one-to-many)
- **Order Items** â†’ **Menu Variants** (many-to-one, cross-service via API)
- **Orders** â†’ **Payments** (one-to-many)
- **Tables** â†’ **Request Notifications** (one-to-many)
- **Tables** â†’ **Table Sessions** (one-to-many, active session only)

**Menu Service Relationships:**
- **Menu Categories** â†’ **Menu Sub-Categories** (one-to-many)
- **Menu Sub-Categories** â†’ **Menu Variants** (one-to-many)
- **Menu Variants** â†’ **Menu Ingredients** (one-to-many)
- **Menu Ingredients** â†’ **Stock Sub-Categories** (many-to-one, cross-service via API)

**Inventory Service Relationships:**
- **Stock Categories** â†’ **Stock Sub-Categories** (one-to-many)
- **Stock Sub-Categories** â†’ **Stock Variants** (one-to-many)

**Invoice Service Relationships:**
- **Suppliers** â†’ **Outcome Invoices** (one-to-many)
- **Outcome Invoices** â†’ **Invoice Items** (one-to-many)
- **Orders** â†’ **Income Invoices** (one-to-one, cross-service via API)
- **Payments** â†’ **Income Invoices** (one-to-one, optional)
- **Customers** â†’ **Income Invoices** (one-to-many, optional, cross-service via API)

**Customer Service Relationships:**
- **Customers** â†’ **Orders** (one-to-many, optional, cross-service via API)
- **Customers** â†’ **Customer Favorites** (one-to-many)
- **Menu Variants** â†’ **Customer Favorites** (one-to-many, cross-service via API)
- **Customers** â†’ **Loyalty Points Transactions** (one-to-many)
- **Orders** â†’ **Loyalty Points Transactions** (one-to-many, cross-service via API)

**Promotion Service Relationships:**
- **Orders** â†’ **Promotions** (many-to-one, optional, cross-service via API)
- **Promotions** â†’ **Orders** (one-to-many)

**Karaoke Service Relationships:**
- **Tables** â†’ **Karaoke Song Requests** (one-to-many, cross-service via API)

### Foreign Key Constraints:
- All foreign keys should have appropriate CASCADE or RESTRICT rules
- Consider soft deletes for important entities (add `deleted_at` timestamp)

---

## Indexes Recommendations

### Performance Indexes:
- `customers.customer_id` (UNIQUE)
- `customers.phone` (for lookup)
- `orders.table_id` + `orders.status`
- `orders.customer_id` (for customer history)
- `order_items.order_id` + `order_items.status`
- `order_items.menu_item_id`
- `payments.order_id`
- `request_notifications.table_id` + `request_notifications.status`
- `request_notifications.request_type` + `request_notifications.status`
- `karaoke_song_requests.status` + `karaoke_song_requests.position_in_queue`
- `menu_sub_categories.category_id` + `menu_sub_categories.is_active`
- `menu_variants.sub_category_id` + `menu_variants.is_available`
- `menu_variants.is_available` + `menu_variants.menu_types`
- `menu_ingredients.menu_variant_id`
- `menu_ingredients.stock_sub_category_id`
- `stock_sub_categories.stock_category_id` + `stock_sub_categories.is_active`
- `stock_variants.stock_sub_category_id` + `stock_variants.is_active`

---

## Notes

- All timestamps should use UTC timezone
- All monetary values use DECIMAL(10,2) for precision
- UUIDs are used for all primary keys for security and scalability
- JSON fields are used for flexible data structures (dietary_tags, allergens, menu_types)
- Enum types should be defined at database level for data integrity
- Consider adding `deleted_at` timestamp for soft deletes on important entities
- Audit fields (`created_at`, `updated_at`) should be automatically managed

---

---

## Future Enhancements

### Inventory Management Approaches (For Future Implementation)

#### Current Approach: Manual Stock-Out Reporting
- **How it works:** Kitchen staff report when stock items run out (e.g., "5kg meat bag is empty")
- **Process:** Staff marks the appropriate stock variant as out of stock
- **Pros:** Simple, matches current workflow, minimal training required
- **Cons:** Reactive (stock-outs happen first), less precise tracking
- **Status:** âœ… IMPLEMENTED

#### Future Approach: Automatic Suggestions (Hybrid)
- **How it works:** System calculates expected ingredient usage from orders but gives staff control
- **Process:**
  1. Orders trigger automatic usage calculations
  2. Kitchen dashboard shows suggestions (not forced deductions)
  3. Staff can confirm, modify, or skip suggestions
  4. System learns from actual usage patterns over time
- **Pros:** Real-time guidance, accurate cost tracking, prevents stock-outs
- **Cons:** More complex implementation, requires staff engagement
- **Status:** ðŸ“‹ PLANNED FOR FUTURE

#### Implementation Plan for Automatic Suggestions:
1. **Phase 1:** Menu Ingredients table + basic calculations
2. **Phase 2:** Kitchen dashboard with confirm/modify options
3. **Phase 3:** Usage pattern learning + smart suggestions
4. **Phase 4:** Predictive reordering + cost analytics

**Last Updated:** 2026-01-18 (Renamed menu entities for consistency, added menu ingredients)
**Status:** Planning Phase
