# üöÄ Bar-Restaurant Application - Implementation Plan

## Overview
This document outlines the implementation plan for building the bar-restaurant application, ordered by service dependencies. Services with fewer dependencies are implemented first, ensuring a solid foundation before building dependent services.

---

## Implementation Order (by Dependencies)

### Phase 1: Foundation Services (No Dependencies)

#### 1. Data Service (Storage Service)
**Dependencies**: None (Foundation)

**Purpose**: Central database service that handles all database connections, migrations, and schema management.

**Responsibilities**:
- PostgreSQL database setup and configuration
- Database connection pooling
- Schema creation and migrations
- Database health checks
- Centralized configuration storage
- PgAdmin container for database management

**Key Features**:
- Initialize all 25 database entities (tables)
- Create all indexes and foreign key constraints
- Set up migration system
- Provide database connection endpoints for other services
- Configuration management (store service configs)

**Entities Managed**:
- All 25 entities from `entities.md`

**Deliverables**:
- `data-service/` directory structure
- Docker Compose setup (PostgreSQL + PgAdmin)
- SQL migration files for all entities
- Database connection utilities
- Configuration loader

**Acceptance Criteria**:
- ‚úÖ Database can be started with `docker-compose up`
- ‚úÖ All 25 tables created successfully
- ‚úÖ All foreign keys and indexes created
- ‚úÖ Migration system working
- ‚úÖ Other services can connect to database

---

### Phase 2: Authentication & Gateway (Depends on Data Service)

#### 2. Session Service
**Dependencies**: Data Service

**Purpose**: Handle user authentication, session management, and JWT token generation/validation.

**Responsibilities**:
- Staff login/logout
- JWT token generation
- JWT token validation
- Session management
- Password hashing/verification
- Staff account management (CRUD operations)

**Key Features**:
- Staff authentication endpoints:
  - `POST /login` - Staff login (username/password)
  - `POST /logout` - Staff logout (invalidate token)
  - `GET /validate` - Validate JWT token
  - `GET /me` - Get current staff user info
- Password hashing (bcrypt)
- JWT token generation with expiration
- Session storage (in database)
- Role-based access control (waiter, bartender, chef, manager, admin, dj_karaoke_operator)

**Entities Managed**:
- `staff` table

**API Endpoints**:
```
POST   /api/v1/session/login
POST   /api/v1/session/logout
GET    /api/v1/session/validate
GET    /api/v1/session/me
```

**Deliverables**:
- `session-service/` directory structure
- Authentication handlers
- JWT middleware
- Session management SQL queries
- Password utilities

**Acceptance Criteria**:
- ‚úÖ Staff can login with username/password
- ‚úÖ JWT token generated on successful login
- ‚úÖ Token validation works
- ‚úÖ Logout invalidates token
- ‚úÖ Role-based access control implemented

---

#### 3. Gateway Service
**Dependencies**: Session Service, Data Service

**Purpose**: API Gateway that routes requests to internal services, handles authentication, and injects metadata.

**Responsibilities**:
- Request routing to internal services
- JWT token validation (delegates to Session Service)
- CORS handling
- Request ID injection
- Rate limiting (future)
- Request/response logging
- Service discovery and load balancing (future)

**Key Features**:
- Reverse proxy to internal services
- Authentication middleware (validates JWT from Session Service)
- CORS configuration
- Request ID generation and injection
- Error handling and response formatting
- Health check endpoints for all services

**Routes**:
```
/api/v1/orders/*          ‚Üí orders-service
/api/v1/menu/*           ‚Üí menu-service
/api/v1/inventory/*      ‚Üí inventory-service
/api/v1/payments/*       ‚Üí payment-service
/api/v1/invoices/*       ‚Üí invoice-service
/api/v1/karaoke/*        ‚Üí karaoke-service
/api/v1/promotions/*     ‚Üí promotion-service
/api/v1/customers/*      ‚Üí customer-service
/api/v1/session/*        ‚Üí session-service
```

**Deliverables**:
- `gateway-service/` directory structure
- Routing configuration
- Authentication middleware
- CORS middleware
- Request ID middleware
- Service routing handlers

**Acceptance Criteria**:
- ‚úÖ Routes requests to correct services
- ‚úÖ Validates JWT tokens before routing
- ‚úÖ CORS configured correctly
- ‚úÖ Request IDs injected
- ‚úÖ Health checks working

---

### Phase 3: Core Business Services (Depends on Data Service + Gateway)

#### 4. Menu Service
**Dependencies**: Data Service, Gateway Service

**Purpose**: Manage menu items, categories, stock items, and menu-stock item relationships.

**Responsibilities**:
- Menu item CRUD operations
- Menu category management
- Stock item management
- Stock item category management
- Menu item-stock item relationship management
- Menu availability toggling
- Menu type management (breakfast, lunch, dinner)

**Key Features**:
- Menu item endpoints:
  - `GET /api/v1/menu/items` - List menu items (filter by menu_type, category, availability)
  - `GET /api/v1/menu/items/:id` - Get menu item details
  - `POST /api/v1/menu/items` - Create menu item (admin/manager only)
  - `PUT /api/v1/menu/items/:id` - Update menu item (admin/manager only)
  - `DELETE /api/v1/menu/items/:id` - Delete menu item (admin/manager only)
  - `PATCH /api/v1/menu/items/:id/availability` - Toggle availability (kitchen staff)
- Menu category endpoints
- Stock item endpoints
- Stock item category endpoints
- Menu item-stock item relationship endpoints
- Calculate `item_cost` from stock items and existences

**Entities Managed**:
- `menu_items`
- `menu_categories`
- `stock_items`
- `stock_item_categories`
- `menu_item_stock_items`

**Deliverables**:
- `menu-service/` directory structure
- Menu item handlers
- Stock item handlers
- Cost calculation logic
- SQL queries for all operations

**Acceptance Criteria**:
- ‚úÖ Menu items can be created/updated/deleted
- ‚úÖ Stock items can be managed
- ‚úÖ Menu item cost calculated from stock items
- ‚úÖ Availability can be toggled
- ‚úÖ Menu filtering by type works

---

#### 5. Inventory Service
**Dependencies**: Data Service, Gateway Service, Menu Service (for stock items)

**Purpose**: Manage inventory, suppliers, purchase invoices, and existences.

**Responsibilities**:
- Supplier management
- Purchase invoice management
- Invoice detail management
- Existence (inventory stock) management
- Stock level tracking
- Cost tracking
- Low stock alerts

**Key Features**:
- Supplier endpoints:
  - `GET /api/v1/inventory/suppliers` - List suppliers
  - `POST /api/v1/inventory/suppliers` - Create supplier
  - `PUT /api/v1/inventory/suppliers/:id` - Update supplier
  - `DELETE /api/v1/inventory/suppliers/:id` - Delete supplier
- Purchase invoice endpoints:
  - `GET /api/v1/inventory/invoices` - List purchase invoices
  - `POST /api/v1/inventory/invoices` - Create purchase invoice
  - `GET /api/v1/inventory/invoices/:id` - Get invoice details
- Existence endpoints:
  - `GET /api/v1/inventory/existences` - List existences (filter by stock_item_id, expired, low_stock)
  - `GET /api/v1/inventory/existences/ingredient/:id/unit-type/:type` - Get most recent existence
  - `POST /api/v1/inventory/existences` - Create existence (from invoice detail)
  - `PUT /api/v1/inventory/existences/:id` - Update existence (decrement units_available)
- Stock level queries
- Low stock detection

**Entities Managed**:
- `suppliers`
- `invoices` (purchase invoices)
- `invoice_details`
- `existences`

**Deliverables**:
- `inventory-service/` directory structure
- Supplier handlers
- Invoice handlers
- Existence handlers
- Stock tracking logic
- SQL queries for inventory operations

**Acceptance Criteria**:
- ‚úÖ Suppliers can be managed
- ‚úÖ Purchase invoices can be created
- ‚úÖ Existences created from invoice details
- ‚úÖ Stock levels tracked correctly
- ‚úÖ Low stock alerts work

---

#### 6. Customer Service
**Dependencies**: Data Service, Gateway Service

**Purpose**: Manage customer records, loyalty points, and customer favorites.

**Responsibilities**:
- Customer CRUD operations
- Loyalty points management
- Customer favorites management
- Customer lookup (by ID, phone)
- Customer caching (for quick lookup)

**Key Features**:
- Customer endpoints:
  - `POST /api/v1/customers` - Create customer (opt into loyalty program)
  - `GET /api/v1/customers/:id` - Get customer details
  - `GET /api/v1/customers/lookup` - Lookup by phone or customer_id
  - `PUT /api/v1/customers/:id` - Update customer
- Loyalty points endpoints:
  - `GET /api/v1/customers/:id/points` - Get loyalty points balance
  - `GET /api/v1/customers/:id/transactions` - Get loyalty points transactions
- Customer favorites endpoints:
  - `GET /api/v1/customers/:id/favorites` - Get customer favorites
  - `POST /api/v1/customers/:id/favorites` - Add favorite
  - `DELETE /api/v1/customers/:id/favorites/:menu_item_id` - Remove favorite
- Customer caching (Redis or in-memory cache)

**Entities Managed**:
- `customers`
- `customer_favorites`
- `loyalty_points_transactions`

**Deliverables**:
- `customer-service/` directory structure
- Customer handlers
- Loyalty points handlers
- Favorites handlers
- Caching implementation
- SQL queries for customer operations

**Acceptance Criteria**:
- ‚úÖ Customers can be created (loyalty opt-in)
- ‚úÖ Customer lookup works (by ID, phone)
- ‚úÖ Loyalty points tracked correctly
- ‚úÖ Favorites can be added/removed
- ‚úÖ Customer caching works

---

### Phase 4: Order & Payment Services (Depends on Data Service + Gateway + Menu + Customer)

#### 7. Orders Service
**Dependencies**: Data Service, Gateway Service, Menu Service, Customer Service, Promotion Service

**Purpose**: Manage orders, order items, order status, and order operations.

**Responsibilities**:
- Order creation
- Order item management
- Order status updates
- Order splitting (staff only)
- Order cancellation
- Promotion application
- Order history

**Key Features**:
- Order endpoints:
  - `POST /api/v1/orders` - Create order (with promotion check)
  - `GET /api/v1/orders` - List orders (filter by table, status, customer)
  - `GET /api/v1/orders/:id` - Get order details
  - `PUT /api/v1/orders/:id/status` - Update order status
  - `POST /api/v1/orders/:id/cancel` - Cancel order
  - `POST /api/v1/orders/:id/split` - Split order (staff only)
- Order item endpoints:
  - `POST /api/v1/orders/:id/items` - Add item to order
  - `PUT /api/v1/orders/:id/items/:item_id` - Update order item
  - `DELETE /api/v1/orders/:id/items/:item_id` - Remove item (only if status = "Requested")
  - `PUT /api/v1/orders/:id/items/:item_id/status` - Update item status (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered)
  - `POST /api/v1/orders/:id/items/:item_id/lost` - Mark item as lost
- Promotion application logic
- Order total calculation (with promotions)

**Entities Managed**:
- `orders`
- `order_items`

**Deliverables**:
- `orders-service/` directory structure
- Order handlers
- Order item handlers
- Status update logic
- Order splitting logic
- Promotion integration
- SQL queries for order operations

**Acceptance Criteria**:
- ‚úÖ Orders can be created
- ‚úÖ Order items can be added/removed (only if Requested)
- ‚úÖ Order status updates work
- ‚úÖ Item status tracking works
- ‚úÖ Order splitting works (staff only)
- ‚úÖ Promotions applied correctly

---

#### 8. Promotion Service
**Dependencies**: Data Service, Gateway Service, Customer Service

**Purpose**: Manage promotions and promotion application logic.

**Responsibilities**:
- Promotion CRUD operations
- Promotion eligibility checking
- Promotion application to orders
- Recurrence pattern handling
- Time-based promotion checking

**Key Features**:
- Promotion endpoints:
  - `GET /api/v1/promotions` - List active promotions
  - `GET /api/v1/promotions/active` - Get promotions active now (for order creation)
  - `POST /api/v1/promotions` - Create promotion (admin/manager only)
  - `PUT /api/v1/promotions/:id` - Update promotion
  - `DELETE /api/v1/promotions/:id` - Delete promotion
- Promotion checking logic:
  - Check time-based promotions (happy_hour, daily_deal, seasonal)
  - Check customer-specific promotions (birthday, loyalty_reward)
  - Calculate discount amount
- Recurrence pattern evaluation:
  - Daily, weekly, monthly patterns
  - Time window checking (from_time, to_time)
  - Days of week checking (for weekly)

**Entities Managed**:
- `promotions`

**Deliverables**:
- `promotion-service/` directory structure
- Promotion handlers
- Promotion checking logic
- Recurrence pattern evaluator
- Discount calculation
- SQL queries for promotion operations

**Acceptance Criteria**:
- ‚úÖ Promotions can be created/updated/deleted
- ‚úÖ Time-based promotions checked correctly
- ‚úÖ Customer-specific promotions checked correctly
- ‚úÖ Recurrence patterns work (daily, weekly, monthly)
- ‚úÖ Discount calculation correct

---

#### 9. Payment Service
**Dependencies**: Data Service, Gateway Service, Orders Service

**Purpose**: Handle payment processing and payment management.

**Responsibilities**:
- Payment creation
- Payment processing
- Payment status updates
- Exact change calculation (cash)
- Tip handling
- Payment history

**Key Features**:
- Payment endpoints:
  - `POST /api/v1/payments` - Create payment request
  - `GET /api/v1/payments/order/:order_id` - Get payments for order
  - `POST /api/v1/payments/:id/process` - Process payment (waiter)
  - `PUT /api/v1/payments/:id/status` - Update payment status
  - `POST /api/v1/payments/:id/refund` - Process refund
- Payment methods:
  - Cash (with exact change calculation)
  - Credit/Debit card
  - Digital wallets (Apple Pay, Google Pay)
- Exact change calculation for cash payments

**Entities Managed**:
- `payments`

**Deliverables**:
- `payment-service/` directory structure
- Payment handlers
- Payment processing logic
- Exact change calculator
- SQL queries for payment operations

**Acceptance Criteria**:
- ‚úÖ Payments can be created
- ‚úÖ Payment processing works
- ‚úÖ Exact change calculated correctly
- ‚úÖ Payment status tracked
- ‚úÖ Refunds work

---

### Phase 5: Supporting Services (Depends on Data Service + Gateway + Core Services)

#### 10. Invoice Service
**Dependencies**: Data Service, Gateway Service, Orders Service, Payment Service

**Purpose**: Generate customer invoices/receipts (Costa Rica compliance).

**Responsibilities**:
- Invoice generation
- Invoice management
- Costa Rica tax compliance (research needed)
- XML generation (Factura Electr√≥nica)
- Invoice printing

**Key Features**:
- Invoice endpoints:
  - `POST /api/v1/invoices` - Generate invoice (from order/payment)
  - `GET /api/v1/invoices/:id` - Get invoice details
  - `GET /api/v1/invoices/order/:order_id` - Get invoice for order
  - `POST /api/v1/invoices/:id/print` - Print invoice
- Invoice generation logic:
  - Generate from order
  - Include promotion discounts
  - Calculate taxes
  - Generate sequential invoice numbers
- Costa Rica compliance (requires research)

**Entities Managed**:
- `invoices` (customer invoices/receipts)

**Deliverables**:
- `invoice-service/` directory structure
- Invoice handlers
- Invoice generation logic
- Tax calculation
- XML generation (if required)
- SQL queries for invoice operations

**Acceptance Criteria**:
- ‚úÖ Invoices can be generated from orders
- ‚úÖ Invoice numbers sequential
- ‚úÖ Tax calculation correct
- ‚úÖ Invoice data stored correctly
- ‚ö†Ô∏è Costa Rica compliance (pending research)

---

#### 11. Request Notification Service
**Dependencies**: Data Service, Gateway Service, Orders Service, Staff Service

**Purpose**: Handle customer requests (payment, assistance, etc.) as FIFO queue.

**Responsibilities**:
- Request creation
- Request queue management (FIFO)
- Request status updates
- Request assignment to staff
- Request notifications

**Key Features**:
- Request endpoints:
  - `POST /api/v1/requests` - Create request (from customer)
  - `GET /api/v1/requests` - List requests (filter by status, type, table)
  - `GET /api/v1/requests/pending` - Get pending requests (FIFO queue)
  - `PUT /api/v1/requests/:id/status` - Update request status
  - `POST /api/v1/requests/:id/assign` - Assign request to staff
  - `POST /api/v1/requests/:id/complete` - Mark request as completed
- Request types:
  - Payment request
  - Assistance request
  - Refill request
  - Issue report
  - Special request

**Entities Managed**:
- `request_notifications`

**Deliverables**:
- `request-service/` directory structure
- Request handlers
- FIFO queue logic
- Request assignment logic
- SQL queries for request operations

**Acceptance Criteria**:
- ‚úÖ Requests can be created
- ‚úÖ FIFO queue works correctly
- ‚úÖ Requests can be assigned to staff
- ‚úÖ Request status updates work

---

#### 12. Karaoke Service
**Dependencies**: Data Service, Gateway Service

**Purpose**: Manage karaoke song requests and song library.

**Responsibilities**:
- Song request management
- Song library management
- Queue management (FIFO, cannot reorder)
- Song status tracking

**Key Features**:
- Song request endpoints:
  - `POST /api/v1/karaoke/requests` - Create song request
  - `GET /api/v1/karaoke/requests` - List requests (filter by table, status)
  - `GET /api/v1/karaoke/queue` - Get current queue (FIFO order)
  - `PUT /api/v1/karaoke/requests/:id/status` - Update song status
  - `POST /api/v1/karaoke/requests/:id/skip` - Skip song (staff only)
- Song library endpoints:
  - `GET /api/v1/karaoke/songs` - List songs (search by title, artist)
  - `POST /api/v1/karaoke/songs` - Add song to library (admin)
  - `PUT /api/v1/karaoke/songs/:id` - Update song
  - `DELETE /api/v1/karaoke/songs/:id` - Delete song
- Queue management (FIFO, no reordering)

**Entities Managed**:
- `karaoke_song_requests`
- `karaoke_song_library`

**Deliverables**:
- `karaoke-service/` directory structure
- Song request handlers
- Song library handlers
- Queue management logic
- SQL queries for karaoke operations

**Acceptance Criteria**:
- ‚úÖ Song requests can be created
- ‚úÖ FIFO queue works correctly
- ‚úÖ Songs cannot be reordered
- ‚úÖ Song library can be managed
- ‚úÖ Song status tracking works

---

### Phase 6: UI Service (Depends on Gateway)

#### 13. UI Service
**Dependencies**: Gateway Service (all services accessible through gateway)

**Purpose**: Customer-facing and staff-facing web interfaces.

**Responsibilities**:
- Customer ordering interface (QR code access)
- Staff dashboard
- Admin panel
- Real-time updates (WebSocket or polling)
- Responsive design

**Key Features**:
- Customer interface:
  - QR code scanning/table selection
  - Menu browsing (filtered by menu_type)
  - Order creation and management
  - Order status tracking
  - Bill viewing
  - Payment request
  - Assistance request
  - Karaoke song requests
  - Favorites management
- Staff dashboard:
  - Order management (KDS/BDS)
  - Request notifications
  - Payment processing
  - Table management
  - Menu management
  - Inventory management
- Admin panel:
  - Staff management
  - Menu management
  - Promotion management
  - Analytics and reports

**Deliverables**:
- `ui-service/` directory structure
- HTML pages (customer, staff, admin)
- JavaScript for API calls
- Real-time update mechanism
- Responsive CSS (Bootstrap)

**Acceptance Criteria**:
- ‚úÖ Customer can scan QR and order
- ‚úÖ Staff can manage orders
- ‚úÖ Real-time updates work
- ‚úÖ Responsive design works
- ‚úÖ All features accessible through UI

---

## Service Dependencies Graph

```
Data Service (Foundation)
    ‚Üì
Session Service
    ‚Üì
Gateway Service ‚îÄ‚îÄ‚îê
    ‚îÇ              ‚îÇ
    ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚Üí Menu Service
    ‚îÇ       ‚Üì
    ‚îÇ   Inventory Service
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚Üí Customer Service
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚Üí Promotion Service
    ‚îÇ       ‚Üì
    ‚îÇ   Orders Service ‚îÄ‚îÄ‚Üí Payment Service ‚îÄ‚îÄ‚Üí Invoice Service
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚Üí Request Notification Service
    ‚îÇ
    ‚îú‚îÄ‚îÄ‚Üí Karaoke Service
    ‚îÇ
    ‚îî‚îÄ‚îÄ‚Üí UI Service (depends on all via Gateway)
```

## Implementation Phases Summary

### Phase 1: Foundation (Week 1-2)
- ‚úÖ Data Service
- ‚úÖ Database setup and migrations
- ‚úÖ All 25 entities created

### Phase 2: Authentication (Week 2-3)
- ‚úÖ Session Service
- ‚úÖ Gateway Service

### Phase 3: Core Business (Week 3-6)
- ‚úÖ Menu Service
- ‚úÖ Inventory Service
- ‚úÖ Customer Service

### Phase 4: Orders & Payments (Week 6-8)
- ‚úÖ Orders Service
- ‚úÖ Promotion Service
- ‚úÖ Payment Service

### Phase 5: Supporting Services (Week 8-9)
- ‚úÖ Invoice Service
- ‚úÖ Request Notification Service
- ‚úÖ Karaoke Service

### Phase 6: UI (Week 9-12)
- ‚úÖ UI Service (Customer interface)
- ‚úÖ UI Service (Staff dashboard)
- ‚úÖ UI Service (Admin panel)

---

## Development Guidelines

### Code Structure
- Follow the structure from `/Users/pvillalobos/Documents/poc/local`
- Each service should have:
  - `main.go` - Service entry point
  - `handlers/` - HTTP handlers
  - `models/` - Domain models
  - `sql/` - SQL queries
  - `docker/` - Docker configuration
  - `Makefile` - Build and run commands

### Database
- All services connect to Data Service
- Use connection pooling
- All queries in `sql/` directory
- Use prepared statements

### Authentication
- JWT tokens issued by Session Service
- Gateway validates tokens before routing
- Role-based access control

### Error Handling
- Consistent error response format
- Proper HTTP status codes
- Error logging

### Testing
- Unit tests for business logic
- Integration tests for API endpoints
- Database migration tests

---

**Last Updated:** 2024-12-19
**Status:** Planning Phase - Ready for Implementation
