# This are the rules the AI must follow to generate custom applications:

## Language
Golang

## Reference
Base off of /Users/pvillalobos/Documents/poc/local to follow the structure

Below you can see a structure chart of how local works, we need to follow the same patterns.

```
â”œâ”€â”€ ğŸ“‹ Root Level (Orchestration)
â”‚   â”œâ”€â”€ Makefile              # Root orchestration for all services
â”‚   â”œâ”€â”€ README.md             # System overview & documentation
â”‚   â”œâ”€â”€ LOCAL-DEVELOPMENT.md  # Local dev setup guide
â”‚   â”œâ”€â”€ start-local.sh        # Start all services locally
â”‚   â””â”€â”€ stop-local.sh         # Stop all services
â”‚
â”œâ”€â”€ ğŸ”§ Shared Components
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ config/           # Centralized config loader (fetches from data-service)
â”‚       â”œâ”€â”€ logger/          # Shared logging utilities
â”‚       â”œâ”€â”€ middlewares/     # Gateway & RequestID middleware
â”‚       â””â”€â”€ models/          # Shared data models
â”‚
â”œâ”€â”€ ğŸ—„ï¸ Data Service (Foundation)
â”‚   â””â”€â”€ data-service/
â”‚       â”œâ”€â”€ docker/          # PostgreSQL + PgAdmin containers
â”‚       â””â”€â”€ sql/             # Database schemas & migrations
â”‚
â”œâ”€â”€ ğŸ” Session Service (Authentication)
â”‚   â””â”€â”€ session-service/
â”‚       â”œâ”€â”€ main.go
â”‚       â””â”€â”€ sql/             # Session management queries
â”‚
â”œâ”€â”€ ğŸŒ Gateway Service (API Gateway)
â”‚   â””â”€â”€ gateway-service/
â”‚       â”œâ”€â”€ main.go          # Reverse proxy + routing
â”‚       â”œâ”€â”€ middleware/      # CORS, Session validation
â”‚       â””â”€â”€ docs/            # Architecture documentation
â”‚
â”œâ”€â”€ ğŸ“¦ Business Services (Domain-Specific)
â”‚   â”œâ”€â”€ menu-service/
â”‚   â”‚   â”œâ”€â”€ main.go
â”‚   â”‚   â””â”€â”€ entities/       # Domain entities (DDD pattern)
â”‚   â”‚       â”œâ”€â”€ menu_categories/
â”‚   â”‚       â”œâ”€â”€ sub_menus/
â”‚   â”‚       â”œâ”€â”€ menu_items/
â”‚   â”‚       â””â”€â”€ [each entity has:]
â”‚   â”‚           â”œâ”€â”€ handlers/  # HTTP + DB handlers
â”‚   â”‚           â”œâ”€â”€ models/    # Domain models
â”‚   â”‚           â””â”€â”€ sql/       # Queries & scripts
â”‚   â”‚
â”‚   â”œâ”€â”€ inventory-service/
â”‚   â”‚   â”œâ”€â”€ main.go
â”‚   â”‚   â””â”€â”€ entities/       # Domain entities (DDD pattern)
â”‚   â”‚       â”œâ”€â”€ stock_items/
â”‚   â”‚       â”œâ”€â”€ stock_item_categories/
â”‚   â”‚       â”œâ”€â”€ suppliers/
â”‚   â”‚       â”œâ”€â”€ existences/
â”‚   â”‚       â”œâ”€â”€ ingredients/   # Links menu items to stock items
â”‚   â”‚       â””â”€â”€ [each entity has:]
â”‚   â”‚           â”œâ”€â”€ handlers/  # HTTP + DB handlers
â”‚   â”‚           â”œâ”€â”€ models/    # Domain models
â”‚   â”‚           â””â”€â”€ sql/       # Queries & scripts
â”‚   â”‚
â”‚   â”œâ”€â”€ invoice-service/
â”‚   â”‚   â”œâ”€â”€ main.go
â”‚   â”‚   â””â”€â”€ entities/        # Domain entities
â”‚   â”‚       â”œâ”€â”€ purchase_invoices/    # Buying from suppliers
â”‚   â”‚       â”œâ”€â”€ invoice_details/      # Line items for purchases
â”‚   â”‚       â”œâ”€â”€ customer_invoices/    # Sales receipts
â”‚   â”‚       â””â”€â”€ [each entity has:]
â”‚   â”‚           â”œâ”€â”€ handlers/  # HTTP + DB handlers
â”‚   â”‚           â”œâ”€â”€ models/    # Domain models
â”‚   â”‚           â””â”€â”€ sql/       # Queries & scripts
â”‚   â”‚
â”‚   â””â”€â”€ orders-service/
â”‚       â”œâ”€â”€ main.go
â”‚       â””â”€â”€ entities/       # Domain entities
â”‚           â”œâ”€â”€ orders/
â”‚           â”œâ”€â”€ order_items/
â”‚           â”œâ”€â”€ payments/
â”‚           â””â”€â”€ [each entity has:]
â”‚               â”œâ”€â”€ handlers/  # HTTP + DB handlers
â”‚               â”œâ”€â”€ models/    # Domain models
â”‚               â””â”€â”€ sql/       # Queries & scripts
â”‚
â””â”€â”€ ğŸ¨ UI Service
    â””â”€â”€ ui/
        â”œâ”€â”€ index.html
        â”œâ”€â”€ dashboard.html
        â””â”€â”€ partials/        # Modular HTML components
```

## Layouts
The application must have the following layers:
- DB (postgres)
- Server (http)
- Client (html)

## Server Structure
The server layout must follow the bellow structure:

REST
    REST will be the workspace where all services will be stored within. Each service will be created here as a standalone service. i.e: inventory_service, payment_service, etc.
    
    - storage: The first service to be created is storage_service which will handle all db-related connections. All the services must be connected and pinging storage_service to function.

    - internals: ** TBD: Need to plan all the services that will be created here.

    - gateway: This will be the point of comunication between the ui and the internal services. Gateway will be in charge of user authentication and authorization using jwt token. Besides injecting metadata avoind direct connection to internal services.

    - ui: this service will handle all the pages and user interface content, using html and bootstrap.

    ### Structure
    ui -> gateway -> internal services -> storage

## Environment setup.
Base on the local project, we need to use docker, docker-compose and kubernetes setup. We have colima installed so we can set it up and work it locally with that.

## Makefile Standards

**Each service's Makefile must contain Docker-related commands and test commands only.**

Do NOT include:
- `build` (Go build commands)
- `run` (direct Go run)
- `deps` (Go mod commands)

DO include:
- `start` - Start Docker containers
- `stop` - Stop Docker containers
- `restart` - Restart containers
- `logs` - View container logs
- `status` - Show container status
- `clean` - Remove containers/volumes
- `test` - Run tests
- `help` - Show available commands

Example Makefile structure:
```makefile
.PHONY: start stop restart logs status clean test help
.DEFAULT_GOAL := help

start: _network
	@cd docker && docker-compose up -d

stop:
	@cd docker && docker-compose down

restart: stop start

logs:
	@cd docker && docker-compose logs -f

status:
	@cd docker && docker-compose ps

clean:
	@cd docker && docker-compose down -v

test:
	@go test -v ./...

help:
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST)

_network:
	@docker network create docker_barrest_network 2>/dev/null || true
```

This ensures consistent Docker-based development across all services.

## Global Makefile

**When creating a new service, the root `Makefile` MUST be updated to include it.**

The global Makefile at `/rest/Makefile` orchestrates all services. For each new service:

1. Add a `test-{service}` target
2. Include the service in the `test` target (runs all tests)
3. Include the service in `start`, `stop`, `status`, `clean`, and `fresh` targets

Example additions for a new `orders-service`:

```makefile
# Add new test target
test-orders: ## Run orders-service tests only
	@cd orders-service && go test -v ./...

# Update the main test target to include it
test:
	@cd data-service && go test -v ./...
	@cd session-service && go test -v ./...
	@cd orders-service && go test -v ./...  # Add this line

# Update start/stop targets
start:
	@cd data-service && make start
	@cd session-service && make start
	@cd orders-service && make start  # Add this line
```

**Checklist when adding a new service:**
- [ ] Create service directory with Makefile following standards
- [ ] Add `test-{service}` target to root Makefile
- [ ] Add service to `test` target
- [ ] Add service to `start` target
- [ ] Add service to `stop` target
- [ ] Add service to `status` target
- [ ] Add service to `clean` target
- [ ] Add service to `fresh` target

## Docker Healthcheck Standards

**Every service container MUST have a healthcheck configured.**

### Healthcheck Configuration

All services must follow this healthcheck pattern in their `docker-compose.yml`:

```yaml
healthcheck:
  test: ["CMD", "curl", "-f", "http://localhost:{PORT}/api/v1/{service}/p/health"]
  interval: 1s
  timeout: 5s
  retries: 3
  start_period: 10s
```

### Health Endpoint Requirements

Each service must expose a health endpoint at:
```
GET /api/v1/{service}/p/health
```

Examples:
- data-service: `/api/v1/data/p/health`
- session-service: `/api/v1/sessions/p/health`
- orders-service: `/api/v1/orders/p/health`

### Health Dependency Chain

Services must check their dependencies' health in their health endpoint:

```
postgres (pg_isready)
    â†“
data-service (checks postgres via DB query)
    â†“
session-service (checks data-service health endpoint)
    â†“
other services (check their dependencies)
```

**If a dependency is unhealthy, the service must return `503 Service Unavailable`.**

### Docker Compose Dependencies

Use `depends_on` with `condition: service_healthy` for startup ordering:

```yaml
services:
  my-service:
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/api/v1/myservice/p/health"]
      interval: 1s
      timeout: 5s
      retries: 3
      start_period: 10s
```

### Dockerfile Requirements

The runtime image must include `curl` for healthchecks:

```dockerfile
FROM alpine:latest
RUN apk --no-cache add ca-certificates curl
```

### Healthcheck Values

| Parameter | Value | Description |
|-----------|-------|-------------|
| `interval` | `1s` | How often to check |
| `timeout` | `5s` | Max time for check to complete |
| `retries` | `3` | Failures before unhealthy |
| `start_period` | `10s` | Grace period at startup (can be adjusted per service) |

### Health Response Format

Healthy response (200 OK):
```json
{
  "code": 200,
  "message": "Service healthy",
  "data": {
    "status": "healthy",
    "service": "service-name"
  }
}
```

Unhealthy response (503 Service Unavailable):
```json
{
  "code": 503,
  "message": "Dependency unhealthy",
  "error": "Data-service is not healthy"
}
```

### Background Health Monitor (shared/health)

All services use the shared `HealthMonitor` to continuously ping dependencies in the background.

**Location:** `shared/health/health_monitor.go`

**Configuration:**
```go
const (
    // HealthCheckInterval is how often to ping dependencies
    HealthCheckInterval = 5 * time.Second
)
```

**Usage in main():**
```go
import sharedHealth "shared/health"

// Create and start health monitor
ctx, cancel := context.WithCancel(context.Background())
healthMonitor := sharedHealth.NewHealthMonitor(logger, HealthCheckInterval)
healthMonitor.AddService("data-service", dataServiceUrl+"/api/v1/data/p/health")
go healthMonitor.Start(ctx)

// On shutdown:
cancel() // Stops the health monitor
```

**Features:**
- Background goroutine pings all registered services every 5 seconds
- Thread-safe health state caching
- Consecutive failure tracking with smart logging (first 3 failures, then every 10th)
- Recovery detection with logging ("Service is healthy again")
- Graceful shutdown via context cancellation

**Usage in health endpoint:**
```go
// Use cached state instead of live HTTP check
if !healthMonitor.IsServiceHealthy("data-service") {
    httpresponse.SendError(w, http.StatusServiceUnavailable, "Data-service is not healthy", nil)
    return
}

// Get detailed status
status := healthMonitor.GetServiceStatus("data-service")
// status.Healthy, status.LastCheck, status.ConsecutiveFails
```

**When adding a new service:**
1. Add service to monitor: `healthMonitor.AddService("new-service", url+"/api/v1/new/p/health")`
2. Health endpoint will automatically include it in status checks

**Services using HealthMonitor:**
| Service | Monitors |
|---------|----------|
| session-service | data-service |
| gateway-service | data-service, session-service, [future business services] |
| [future services] | data-service |

## Service Dependency Architecture### Dependency Chain

Services depend on each other in the following order:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     INFRASTRUCTURE LAYER                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚  â”‚ postgres â”‚ â† Foundation (no dependencies)                    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FOUNDATION LAYER                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚ data-service â”‚ â† Depends on: postgres                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   Provides: config, settings, DB access       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        BUSINESS LAYER                           â”‚
â”‚  All services depend on: data-service (for config/DB)           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ session-service â”‚ â”‚ menu-service â”‚ â”‚ orders-service â”‚        â”‚
â”‚  â”‚ (auth/JWT)      â”‚ â”‚ (categories, â”‚ â”‚ (orders, items,â”‚        â”‚
â”‚  â”‚                 â”‚ â”‚  sub-menus,  â”‚ â”‚  payments)     â”‚        â”‚
â”‚  â”‚                 â”‚ â”‚  menu items) â”‚ â”‚                â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                             â”‚                                   â”‚
â”‚                             â”‚ calls API                         â”‚
â”‚                             â–¼                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ inventory-serviceâ”‚ â”‚ invoice-service â”‚                       â”‚
â”‚  â”‚ (stock items,    â”‚ â”‚ (purchase &     â”‚                       â”‚
â”‚  â”‚  categories,     â”‚â—„â”‚  customer       â”‚                       â”‚
â”‚  â”‚  suppliers,      â”‚ â”‚  invoices)      â”‚                       â”‚
â”‚  â”‚  existences,     â”‚ â”‚                 â”‚                       â”‚
â”‚  â”‚  ingredients)    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ karaoke-service â”‚ â”‚ promotion-service â”‚ â”‚ customer-service â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²               â–²               â–²
          â”‚               â”‚               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ (routes to)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        GATEWAY LAYER                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚ gateway-service â”‚ â† Depends on: all business layer services  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   Provides: auth, CORS, routing, proxy     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â–²
          â”‚ (external requests)
       [Client]
```

**Note:** Gateway depends on all business services to ensure they are healthy before accepting requests.

### Gateway Service Dependencies

The gateway is the central routing point. When adding new services:

1. **Update `docker-compose.yml`** - Add service URL environment variable:
   ```yaml
   environment:
     - NEW_SERVICE_URL=http://barrest_new_service:PORT
   ```

2. **Update `main.go`** - Add route configuration:
   ```go
   // Load URL from config
   newServiceUrl := config.GetString("NEW_SERVICE_URL")
   
   // Add protected routes
   newRouter := api.PathPrefix("/v1/newservice").Subrouter()
   newRouter.Use(sessionMiddleware.ValidateSession)
   newRouter.PathPrefix("").HandlerFunc(createProxyHandler(newServiceUrl, "/api/v1/newservice", logger))
   ```

3. **Update `createHealthHandler`** - Add to health check if critical:
   ```go
   newServiceHealthy := checkServiceHealth(newServiceUrl+"/api/v1/newservice/p/health", logger)
   ```

4. **Update migration** - Add service URL to settings table:
   ```sql
   INSERT INTO settings (service, key, value, description) VALUES
       ('gateway', 'NEW_SERVICE_URL', 'http://barrest_new_service:PORT', 'New service URL');
   ```

### Service Startup Order

Services must be started in dependency order. The following table shows the startup levels:

| Level | Service | Port | Depends On | Description |
|-------|---------|------|------------|-------------|
| 0 | postgres | 5432 | - | Database (foundation) |
| 1 | data-service | 8086 | postgres | Configuration & DB access |
| 2 | session-service | 8087 | data-service | Authentication & staff management |
| 2 | inventory-service | 8090 | data-service | Stock, suppliers, existences, ingredients |
| 3 | invoice-service | 8092 | data-service, inventory-service | Purchase & customer invoices |
| 3 | menu-service | 8088 | data-service, inventory-service | Menu categories, sub-menus, items |
| 3 | customer-service | 8095 | data-service | Customers, favorites, loyalty |
| 3 | karaoke-service | 8093 | data-service | Karaoke song requests & library |
| 3 | promotion-service | 8094 | data-service | Promotions & reservations |
| 4 | orders-service | 8089 | data-service, menu-service, invoice-service | Orders, payments, tables |
| 5 | gateway-service | 8082 | all business services | API gateway & routing |
| 6 | ui-service | 3000 | gateway-service | User interface |

**Dependency Diagram:**
```
Level 0:  [postgres]
              â”‚
Level 1:  [data-service]
              â”‚
              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Level 2:  [session-service]    [inventory-service]        â”‚
              â”‚                      â”‚                     â”‚
              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
Level 3:      â”‚    [invoice-service]    [menu-service]    â”‚
              â”‚         â”‚                   â”‚              â”‚
              â”‚         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
              â”‚         â”‚    â”‚                             â”‚
              â”‚         â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Level 4:      â”‚              â”‚                    
              â”‚         [orders-service]
              â”‚              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
Level 5:              [gateway-service]
                             â”‚
Level 6:              [ui-service]
```

### Starting Services

Each service has its own `docker-compose.yml`. The root `Makefile` orchestrates startup order:

```bash
make fresh   # Clean install with proper ordering
make start   # Start all services
make stop    # Stop all services
```

The root `Makefile` handles startup order by levels:

```makefile
fresh: clean
    # Level 0-1: Database + Data Service
    @cd data-service && make fresh
    @sleep 2
    
    # Level 2: Auth + Inventory (parallel-safe)
    @cd session-service && make start
    @cd inventory-service && make start
    @sleep 2
    
    # Level 3: Business services (parallel-safe)
    @cd invoice-service && make start
    @cd menu-service && make start
    @cd customer-service && make start
    @cd karaoke-service && make start
    @cd promotion-service && make start
    @sleep 2
    
    # Level 4: Orders (depends on menu + invoice)
    @cd orders-service && make start
    @sleep 2
    
    # Level 5: Gateway (depends on all)
    @cd gateway-service && make start
    @sleep 2
    
    # Level 6: UI
    @cd ui-service && make start
```

**Service Health Monitoring:**
- Gateway actively pings all business services via `/api/v1/{service}/p/health` endpoints
- If a service is unhealthy, gateway returns appropriate error to client
- No Docker `depends_on` - services check dependencies via HTTP health endpoints

**Rule:** Start services in dependency order. Gateway should be started last.

### Port Allocation

| Service | Port | Container Name | Entities |
|---------|------|----------------|----------|
| PostgreSQL | 5432 | barrest_postgres | - |
| PgAdmin | 5050 | barrest_pgadmin | - |
| Portainer | 9000 | barrest_portainer | - |
| Data Service | 8086 | barrest_data_service | Settings, Config |
| Session Service | 8087 | barrest_session_service | Sessions, Staff |
| Gateway Service | 8082 | barrest_gateway_service | - |
| Menu Service | 8088 | barrest_menu_service | Menu Categories, Sub Menus, Menu Items |
| Orders Service | 8089 | barrest_orders_service (future) | Orders, Order Items, Payments |
| Inventory Service | 8090 | barrest_inventory_service (future) | Stock Items, Stock Item Categories, Suppliers, Existences, Ingredients |
| Invoice Service | 8092 | barrest_invoice_service (future) | Invoices, Invoice Items, Customer Invoices |
| Karaoke Service | 8093 | barrest_karaoke_service (future) | Karaoke Song Requests, Karaoke Song Library |
| Promotion Service | 8094 | barrest_promotion_service (future) | Promotions |
| Customer Service | 8095 | barrest_customer_service (future) | Customers, Customer Favorites, Loyalty Points, Reviews |
