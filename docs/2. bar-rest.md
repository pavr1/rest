# üçª Bar-Restaurant Application - Feature List

## Overview
A comprehensive bar-restaurant management system that enables customers to order via QR codes at tables, with full order management, payment processing, and administrative features.

---

## üéØ Core Customer Features (QR Code Ordering)

### Table & Order Management
- ‚úÖ **QR Code Scanning**
  - Each table has a unique QR code generated from `{ordering_link}/{table_number}`
  - QR code is generated dynamically (not stored in database)
  - May use third-party service to generate QR codes with table number in real-time
  - Scan QR code to start ordering session
  - QR code links directly to table-specific ordering interface

- ‚úÖ **Multi-Order Support**
  - Multiple people can create separate orders at the same table
  - Each order requires a customer name (see order creation flow)
  - Table can have multiple active orders simultaneously
  - Each person manages their own order independently
  - Each order can be paid independently
  - If someone wants to leave first, they can pay their order and leave
  - Other orders at the table remain active until paid

- ‚úÖ **Order Creation**
  - **Order Creation Flow**:
    1. Customer scans QR code and accesses menu
    2. App asks: "Do you want to join the loyalty program?"
    3. **If YES** (opt into loyalty program):
       - Customer must provide: **ID, Name (first name + last name), and Phone** (all required)
       - Email is optional
       - Date of Birth is optional (enables birthday promotions if provided)
       - Customer record is created in `customers` table
       - **Customer info is added to cache** (ID, name, phone) with **no expiration**
       - Cache allows quick lookup on future visits - customer can be identified immediately
       - Customer becomes eligible for promotions and loyalty programs
    4. **If NO** (decline loyalty program):
       - Customer enters only their **name** (simple name, no last name required)
       - No customer record is created
       - Order uses `customer_name` field (required when customer_id is NULL)
       - Customer is NOT eligible for promotions or loyalty programs
  - **Customer Name Logic**:
    - **If customer_id exists**: `customer_name` is populated from customer record (full name)
    - **If customer_id is NULL**: `customer_name` is required (entered by customer, simple name)
  - **Customer Record Creation**:
    - Customer record is ONLY created when customer opts into loyalty program
    - When created: ID, Name, Phone are REQUIRED (NOT NULL), Email and Date of Birth are optional
    - If customer declines loyalty program, order uses `customer_name` field (no customer record)
    - Date of Birth enables birthday promotions (if provided, customer becomes eligible for birthday promotions)
  - **Promotion & Loyalty Eligibility**:
    - Only customers who opted into loyalty program (have customer record) are eligible for:
      - Promotional offers and discounts
      - Loyalty program participation
      - Points accumulation
      - Special deals and birthday offers
    - Customers without customer record can still order but are NOT eligible
  - **Customer Data Persistence**:
    - Customer information persists across visits (for loyalty tracking and notifications)
    - **Customer Info Caching**: When customer opts into loyalty program, their info (ID, name, phone) is added to cache with **no expiration**
    - Cache allows quick lookup when customer returns - customer can be identified by ID or phone number
    - When customer returns and provides ID/phone, cache provides customer ID instantly to create orders
    - Future visits: Customer can be identified by ID or phone number from cache (no database lookup needed)
    - Customer purchase history is tracked across all visits (staff-only access)
    - Enables loyalty points accumulation and targeted promotions
  - Order is tied to table number
  - Real-time order status tracking
  - Order history per table session (customers can only see current session orders)

### Menu & Ordering
- ‚úÖ **Menu Browsing**
  - **Time-based menus**: System displays different menus based on time of day:
    - Breakfast menu (morning hours)
    - Lunch menu (midday hours)
    - Dinner menu (evening hours)
  - Menu automatically switches based on current time
  - View menu items with descriptions, prices, images
  - **Item availability**: Items marked as unavailable by kitchen staff are handled (display behavior to be determined)
  - **Add items to favorites**: Customers can mark menu items as favorites (requires customer ID/phone)
  - Filter by category, dietary preferences, allergens
  - Search functionality (searches current time-based menu)
  - Daily specials and promotions highlighted

- ‚úÖ **Food Ordering**
  - Add items to cart with customizations
  - Quantity selection
  - **Order type selection**: "For Here" or "To Go" (per item)
  - **"To Go" handling**: Staff brings "To Go" items to the table when ready (same as "For Here")
  - Special instructions/comments per item
  - Dietary preferences (vegetarian, vegan, gluten-free, etc.)
  - Allergen information display

- ‚úÖ **Drink Ordering**
  - Alcoholic and non-alcoholic beverages
  - Customization options (ice, garnish, strength)
  - Happy hour pricing display
  - Drink recommendations

- ‚úÖ **Order Management**
  - Add/remove items before submission
  - Modify quantities
  - View cart summary
  - **Promotion Application**: Promotions are automatically applied at order creation if eligible
    - Time-based promotions (happy hour, daily deals, seasonal) apply to all orders during active time window
    - Customer-specific promotions (birthday, loyalty rewards) apply if customer is eligible
  - **Order confirmation step**: Customer reviews order summary (including any applied promotions/discounts) and confirms before submission
  - Submit order to kitchen/bar (after confirmation)
  - Real-time order status tracking
  
- ‚úÖ **Order Status**
  - Order status values: `created`, `preparing`, `paid`, `cancelled`
  - **created**: Order has been created and confirmed by customer
  - **preparing**: Order has started being worked on (at least one item status is "Preparing" or beyond)
  - **paid**: Order has been paid
  - **cancelled**: Order was cancelled
  - **Important**: If order status is `cancelled`, payment_status remains `unpaid` (cancelled orders are not paid)
  
- ‚úÖ **Order Item Status Tracking**
  - Each item in an order has individual status tracking:
    - **Requested**: Item has been ordered but not yet started
    - **Preparing**: Item is currently being prepared (cannot be cancelled)
    - **Ready**: Item is ready for waiter to pickup and serve
    - **Delivered**: Item has been served to the customer
    - **Lost**: Item was lost due to various reasons (requires reason and handling)
  - Time tracking for each status change:
    - Timestamp when item status changes
    - Time elapsed since order placed
    - Estimated time until delivery
    - Actual delivery time tracking
    - Time from Ready to Delivered (waiter pickup time)
  - Real-time status updates visible to customer
  - Visual indicators for item status (color-coded badges)
  
- ‚úÖ **Lost Items Management**
  - When an item is lost (returned, wrong order, quality issue, etc.), staff must:
    - Mark item status as "Lost"
    - Record reason for loss (required field, waiter must provide valid reason):
      - Quality issue (too salty, overcooked, undercooked, spoiled, etc.)
      - Wrong item (incorrect order prepared)
      - Not as described (menu mismatch, customer expectation)
      - Customer complaint (any customer-reported issue)
      - Spilled/dropped (accident during service)
      - Other (with text explanation required)
    - Determine fault:
      - **Restaurant fault**: Cost is lost, item must be replaced
      - **Customer fault**: No replacement, customer still pays
    - If restaurant fault:
      - System tracks lost cost (calculated proportionally based on quantity lost)
        - Example: If order item has quantity = 2, but only 1 dish is lost ‚Üí lost_cost = half the item price
        - Lost cost = (unit_price √ó quantity_lost) / quantity_ordered
      - Item status changes to "Lost"
      - Waiter asks customer what replacement item they want
      - Waiter manually adds the replacement item to the same order
      - Replacement item follows normal status flow (starts as "Requested")
      - Lost item remains in order with "Lost" status (for billing/cost tracking)
      - Waiters can see all table orders and updates to make informed decisions
    - If customer fault:
      - Item remains on bill
      - No replacement provided
    - Lost items cannot be modified or cancelled
    - Loss tracking for analytics, quality control, and cost management

- ‚úÖ **Order Modification Rules**
  - Customers can add items to an order **only before payment is processed**
  - Once payment is requested/processed, no more items can be added to that order
  - If customer needs additional items after payment:
    - Ask waiter to create a new order, OR
    - Create a brand new order themselves (new order session)
  - Customers can delete items from an order **only if** item status is "Requested"
  - Once an item status changes to "Preparing", it cannot be cancelled or deleted by customer
  - Items in "Ready", "Delivered", or "Lost" status cannot be modified by customer
  - Clear visual feedback showing which items can be modified
  - Confirmation prompt before deleting items
  - **Lost items**: Cannot be modified; handled by staff with required reason tracking

- ‚úÖ **Order Splitting** (Staff Only)
  - **Staff-only feature**: Only restaurant staff can split orders (customers cannot split orders)
  - Prevents customers from assigning unauthorized payments to others
  - Split a single order into multiple separate orders
  - Can split orders at any time, regardless of item status:
    - Items in "Requested" status can be moved to new orders
    - Items in "Preparing", "Ready", "Delivered", or "Lost" status remain in original order
    - Only "Requested" items can be moved during split
  - Select specific items to move to a new order
  - Assign items to different person names
  - Original order can be split into 2+ orders
  - Each split order becomes independent with its own bill
  - Must be done before payment is processed

### Payment & Billing
- ‚úÖ **Bill Viewing**
  - Real-time bill calculation
  - View current debt/balance
  - Itemized receipt
  - Promotion discounts displayed (if promotion applied)
  - Tax and service charge breakdown
  - Note: Order splitting is handled by staff only (request staff assistance if needed)

- ‚úÖ **Payment Processing**
  - Request payment (call waiter)
  - **All payments are waiter-assisted** (waiter processes payment at the table with payment device)
  - **Individual Order Payment**:
    - Each order can be paid independently
    - Multiple people at same table can have separate orders
    - If someone wants to leave first, they can pay their order and leave
    - Other orders at the table remain active until paid
    - No requirement to pay all orders together
  - Multiple payment methods:
    - Credit/Debit card (waiter processes with card reader)
    - Digital wallets (Apple Pay, Google Pay) - waiter processes with payment device
    - Cash payment (waiter-assisted)
      - **Exact Change Feature**: When paying with cash, customer must enter the exact amount they will pay
      - System calculates exact change needed
      - Waiter receives notification with exact change amount
      - Ensures waiter brings correct change at once
  - Payment confirmation and receipt (provided by waiter)
  - Note: Order splitting is handled by staff only (prevents unauthorized payment assignment)

### Customer Assistance
- ‚úÖ **Request Assistance**
  - Simple assistance request button
  - Request refills
  - Report issues
  - Special requests
  - All assistance requests handled as FIFO queue (first in, first out)
  - No priority levels (urgent/normal removed)

### üé§ Karaoke Song Requests
- ‚úÖ **Karaoke QR Code System**
  - Separate QR code link for karaoke song requests
  - QR code generated dynamically from `{karaoke_link}/{table_number}`
  - QR code is generated dynamically (not stored in database)
  - May use third-party service to generate QR codes with table number in real-time
  - Customer scans QR code to access karaoke request interface
  
- ‚úÖ **Song Request Management**
  - Customer enters their name (required, no ID/phone needed)
  - No customer data persistence for karaoke (name only, not stored)
  - Add song requests with:
    - Song title (required)
    - Artist name (required)
  - View queue of all incoming songs:
    - See all songs requested from all tables
    - See position in queue
    - See estimated wait time
    - See which songs are currently playing
  - Table-specific view:
    - See only songs requested from your table
    - See status of your song requests
  - Real-time queue updates
  - Remove song from queue (if not yet played)
  - Duplicate song detection (warn if song already in queue)

---

## üè¢ Administrative Features

### Table Management
- **Table Configuration**
  - Create/edit/delete tables
  - **QR Code Generation**: QR codes generated dynamically from `{ordering_link}/{table_number}` and `{karaoke_link}/{table_number}`
  - QR codes are not stored - generated in real-time or via third-party service
  - Table capacity settings
  - Table status (Available, Occupied, Reserved)
  - Floor plan visualization
  - **Clear Table Session**: Staff action to close session after all orders are paid

- **Table Status Tracking**
  - Real-time table status dashboard
  - Occupancy monitoring
  - Table turnover analytics
  - Reservation integration
  - **Table Session Management**:
    - Table session ends when all orders are canceled and paid
    - Staff must manually clear/close session to mark table as available
    - After clearing session, table appears as available for new customers
    - Prevents new orders on table until session is cleared

### Menu Management
- **Menu Item Management**
  - Add/edit/delete menu items
  - Categorize items (Food, Drinks, Desserts, etc.)
  - Set selling price (price customer pays)
  - Set item cost (cost to buy/make the item):
    - **ALL menu items**: Cost is calculated automatically from stock items (sum of stock item costs √ó quantities)
    - Examples:
      - Food item (burger): Uses multiple stock items (bun, patty, lettuce, etc.) ‚Üí cost calculated from all
      - Bottled beer: Uses single stock item ("Bottled Beer") ‚Üí cost calculated from that stock item's existence
  - **Income calculation**: Income (profit) = selling price - item cost
  - **Item type**: `kitchen` (food items) or `bar` (drink items)
  - **"Is Available" boolean field**: Kitchen staff can mark items as available/unavailable
  - Toggle availability in real-time (e.g., when item runs out of stock)
  - Upload item images
  - Set dietary tags and allergens
  - Link stock items to menu items with quantities for automatic cost calculation
  - **ALL items are stock items**: Raw ingredients (flour, tomatoes), finished products (bottled beer, canned soda), everything tracked in inventory

- **Menu Categories**
  - Create/edit categories
  - Reorder categories
  - Category-specific pricing rules
  
- **Time-Based Menu Management**
  - Configure 3 separate menus: Breakfast, Lunch, Dinner
  - Set time windows for each menu (e.g., Breakfast: 7am-11am, Lunch: 11am-3pm, Dinner: 3pm-11pm)
  - Assign menu items to specific menus (breakfast, lunch, dinner, or multiple)
  - Menu automatically switches based on configured time windows
  - Items only appear in their assigned menu(s) during appropriate times

- **Pricing Management**
  - Regular pricing
  - Happy hour pricing
  - Daily specials
  - Promotional pricing
  - Bulk pricing for groups

### Order Management (Staff View)
- **Kitchen Display System (KDS)**
  - Real-time order queue
  - Order prioritization
  - Preparation time tracking
  - Order status updates (Requested ‚Üí Preparing ‚Üí Ready)
  - Mark items as "Ready" when prepared
  - Display order type: "For Here" or "To Go" (per item)
  - **"To Go" items**: Staff brings to table when ready (same handling as "For Here")
  - **Toggle menu item availability**: Kitchen staff can mark items as available/unavailable (e.g., when out of stock)
  - Print order tickets (with order type indicator)
  - Display replacement orders (for lost items that need replacement)

- **Bar Display System (BDS)**
  - Drink orders queue
  - Order preparation tracking
  - Mark items as "Ready" when prepared
  - Display order type: "For Here" or "To Go" (per item)
  - Ready-to-serve notifications for waiters
  - Display replacement orders (for lost items that need replacement)

- **Order Processing**
  - View all active orders
  - Filter by table, status, time, order type (For Here/To Go)
  - **Create orders for pickup customers**: Staff can create orders for customers who come to pick up (not dining in)
  - **Order Status Management**:
    - Order status values: `created`, `preparing`, `paid`, `cancelled`
    - `created`: Order has been created and confirmed
    - `preparing`: Order has started being worked on (at least one item status is "Preparing" or beyond)
    - `paid`: Order has been paid
    - `cancelled`: Order was cancelled
    - **If order status is `cancelled`, payment_status remains `unpaid`** (cancelled orders are not paid)
  - Update order item status (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered)
  - Time tracking for each status change
  - Cancel orders (only items in "Requested" status)
  - Cannot cancel items once status is "Preparing", "Ready", "Delivered", or "Lost"
  - **Order Splitting (Staff Only)**:
    - Split orders into multiple separate orders
    - Can split at any time, but only items in "Requested" status can be moved
    - Items already "Preparing" or beyond remain in original order
    - Select items to move to new order
    - Assign items to different customer names
    - Prevents unauthorized payment assignment
  - **Handle lost items**:
    - Mark items as "Lost"
    - Record loss reason (required - waiter must provide valid reason)
    - Determine fault (restaurant vs customer)
    - If restaurant fault:
      - Item status changes to "Lost"
      - System calculates lost cost proportionally (if quantity > 1, only lost dishes count toward cost)
      - Waiter asks customer what replacement item they want
      - Waiter manually adds the replacement item to the same order
      - Replacement item follows normal status flow (starts as "Requested")
      - Lost item remains in order with "Lost" status
      - Waiters can see all table orders and updates to make informed decisions
    - Track lost costs for analytics and cost management
  - Refund processing
  - Order notes and special instructions
  - View preparation time metrics per item
  - Filter/view orders by "For Here" vs "To Go"

### Staff Management
- **Staff Accounts**
  - Role-based access (Waiter, Bartender, Chef, Manager, Admin, DJ/Karaoke Operator)
  - Staff login/logout
  - Shift management
  - Performance tracking

- **Staff Dashboard**
  - Assigned tables
  - Active orders (can see all table orders and updates)
  - Assistance requests
  - Payment requests
  - Lost items requiring replacement decisions
  - **Clear table sessions** (after all orders are paid)
  - Daily statistics
  
- **Request Notification System** (Backend)
  - **Request-notification table**: All requests (payment, assistance, etc.) stored in database table
  - Each request has a type (payment, assistance, etc.)
  - UI retrieves from this table to check for notifications
  - Display behavior in UI to be determined (dashboard, push notifications, etc.)
  - Server-side implementation: requests stored with type, table, order info, timestamp

### Customer Data Management
- **Customer Information Collection**
  - **Flow**: Customer scans QR ‚Üí app asks if they want loyalty program FIRST
  - **If customer opts into loyalty program**:
    - Customer provides: ID, Name (first name + last name), Phone (all required), Email (optional)
    - Customer record created with full information
    - Customer becomes eligible for promotions and loyalty
  - **If customer declines loyalty program**:
    - Customer enters only simple name (no last name required)
    - No customer record created
    - Order uses `customer_name` field (required when customer_id is NULL)
    - Customer is NOT eligible for promotions or loyalty
  - Clear indication to customers about promotion eligibility based on their choice
  
- **Customer Database**
  - **Customer record is only created when customer opts into loyalty program**
  - When created: ID, Name, Phone are REQUIRED (NOT NULL), Email is optional
  - Store customer information persistently for loyalty and notification purposes
  - Link orders to customer records (only if customer opted into loyalty program)
  - **Customer purchase history tracking across all visits** - **Staff-only access** (customers cannot view past orders)
  - **Customer favorites**: `customer_favorites` table linking customers to favorite menu items
  - Customer identification via ID or phone number
  - Customer lookup: When customer provides ID/phone, retrieve existing customer data
  - Update customer information on subsequent visits
  - Customers can only view: their own info, loyalty points, and favorites (if they have customer record)

- **Customer Info Caching**
  - **Cache Strategy**: When customer opts into loyalty program, add their info (ID, name, phone) to cache with **no expiration**
  - Cache key: Customer ID or Phone number
  - Cache value: Customer record (ID, name, phone, email, loyalty_points)
  - **Purpose**: Quick lookup when customer returns - allows immediate identification and order creation
  - When customer provides ID/phone on return visit, cache provides customer ID instantly
  - Cache persists indefinitely (no expiration) for fast access
  - Cache should be updated when customer info changes in database
  - Reduces database lookups for returning customers
  
- **Promotion & Loyalty Eligibility**
  - Identify eligible customers (those who opted into loyalty program and have customer record)
  - Customer record requires: ID, Name, Phone (all required), Email (optional)
  - Email is optional but recommended for email-based promotions
  - Track customer participation in promotions
  - Manage loyalty program enrollment
  - Send targeted promotions to eligible customers (SMS via phone, email if provided)
  - Customer segmentation based on purchase behavior
  
- **Customer Order History (Staff Only)**
  - View customer purchase history across all visits
  - Search customers by ID or phone number
  - View all orders associated with a customer
  - Customer spending patterns and preferences
  - Order frequency and visit history
  - This information is not visible to customers (privacy protection)

- **Privacy & Data Management**
  - Customer consent for data collection
  - Data retention policies
  - Customer data access and deletion requests
  - Compliance with privacy regulations

### Karaoke Management
- **Song Queue Management**
  - View all song requests from all tables
  - The queue cannot be reordered, it must be first in first out
  - Mark songs as "Currently Playing"
  - Mark songs as "Completed"
  - Remove songs from queue
  - Skip songs (with reason tracking)
  - Find the lightest way to pre-populate songs names and artists (if feasible)
  
- **Karaoke QR Code Management**
  - QR codes generated dynamically from `{karaoke_link}/{table_number}` (not stored)
  - May use third-party service to generate QR codes in real-time
  - Manage karaoke system settings
  - Enable/disable karaoke requests per table and per time (based on time karaoke request won't be allowed)
  
- **Song Library Management**
  - Add/edit/remove songs from available library
  - Search song database
  - Link songs to artists
  - Set song duration estimates
  - Popular songs tracking

### Inventory Management
- **Stock Item Management**
  - Create/edit/delete stock items
  - **ALL items are stock items**: Raw ingredients (flour, tomatoes), finished products (bottled beer, canned soda), everything tracked in inventory
  - Stock item name and unit (gallon, bottle, unit, liter, kg, etc.)
  - Organize stock items into categories (Dairy, Meat, Vegetables, Beverages, Spices, Finished Products, etc.)
  - Link stock items to menu items with quantities (for automatic cost calculation)
  - Examples: "Bottled Beer", "Flour", "Tomatoes", "Canned Soda", "Ice Cream Base"

- **Supplier Management**
  - Create/edit/delete suppliers
  - Track supplier contact information
  - Supplier notes and history

- **Outcome Invoice Management**
  - Create outcome invoices from suppliers
  - Add invoice line items (invoice details) with:
    - Stock item purchased
    - Quantity and unit type
    - Price per unit
    - Items per unit (for sub-unit tracking, e.g., 31 ice cream balls per gallon)
    - Expiration dates
  - Upload scanned invoice images
  - Track total invoice amounts

- **Stock Tracking (Stock Items)**
  - **Stock Items** track inventory:
    - Each existence represents a purchase batch from an invoice
    - Tracks `units_purchased` and `units_available` (current stock)
    - Stores `cost_per_unit` from invoice (used for cost calculations)
    - Tracks expiration dates for inventory rotation
    - `units_available` decreases as stock items are used in menu items
  - View current stock levels per stock item
  - Low stock alerts based on `units_available`
  - Track inventory value (`remaining_value` = units_available √ó cost_per_unit)
  - FIFO/LIFO inventory management when using stock items

- **Menu Item Cost Calculation**
  - **ALL menu items**: Cost calculated automatically from linked stock items
    - For each stock item, use `stock_item.unit_cost` (weighted average)
    - `item_cost` = SUM(existence.cost_per_unit √ó menu_item_stock_items.quantity) for all stock items
  - Examples:
    - Food item (burger): Uses multiple stock items ‚Üí cost calculated from all
    - Bottled beer: Uses single stock item ("Bottled Beer") ‚Üí cost calculated from that stock item's existence
  - Income (profit) = selling price - item cost
  - Cost tracking for financial reporting and pricing decisions
  - When menu items are prepared, stock item usage decrements `current_stock` in stock_items

### Financial Management
- **Revenue Tracking**
  - Daily/weekly/monthly sales reports
  - Revenue by category (kitchen vs bar items)
  - Payment method breakdown
  - Table turnover revenue
  - Peak hours analysis
  - **Income (profit) tracking**: Revenue - Cost = Income
    - Track income per menu item (selling price - item cost)
    - Track total income by category (kitchen vs bar), time period, etc.

- **Payment Processing**
  - **Waiter-assisted payment processing**:
    - All payments processed by waiters at the table
    - Payment device integration (card reader, digital wallet support)
    - Payment request notifications to waiters
    - Payment confirmation and receipt generation
  - Payment method management
  - Transaction history
  - Refund management
  - Cash reconciliation
  - Tip tracking
  
- **Lost Items Cost Tracking**
  - Track lost costs from lost items (when restaurant fault)
  - Lost items cost reporting
  - Impact on revenue calculations
  - Quality control cost analysis
  - Reason-based cost analysis (which reasons cost the most)

- **Invoice Management**
  - **Invoice Generation**: Requires research - likely generated when staff requests them
  - Invoice generation workflow and triggers need to be determined
  - **Costa Rica Tax Compliance**:
    - Compliance with Costa Rica tax regulations (requires investigation)
    - Support for required tax fields and calculations
    - Tax ID (C√©dula Jur√≠dica) management
    - Tax rate configuration per item/category
  - **Electronic Invoicing (Factura Electr√≥nica)**:
    - Integration with Costa Rica's electronic invoicing system
    - Generate XML invoices compliant with Costa Rica requirements
    - Digital signature support (requires investigation of specific requirements)
    - Invoice numbering and sequential control
    - Consecutive number management per invoice type
    - **Note**: Requirements for Costa Rica electronic invoicing need to be investigated:
      - Hacienda (Ministry of Finance) requirements
      - XML format specifications
      - Digital certificate requirements
      - Integration with authorized electronic invoicing providers (if applicable)
      - Invoice transmission and validation process
  - **Invoice Features**:
    - Print invoices (physical and PDF)
    - Email invoices to customers
    - Invoice templates customization
    - Multiple invoice types (sales, credit notes, etc.)
    - Invoice search and filtering
    - Invoice history and archive
    - Re-print invoices
    - Invoice cancellation (with proper authorization)
  - **Invoice Data**:
    - Customer information (name, tax ID if applicable)
    - Itemized list of products/services
    - Tax breakdown (sales tax, service tax, etc.)
    - Subtotal, taxes, total amounts
    - Payment method used
    - Date and time of transaction
    - Invoice number (consecutive)
    - QR code for invoice validation (if required)

### Analytics & Reporting
- **Sales Analytics**
  - Best-selling items
  - Peak hours analysis
  - Average order value
  - Customer spending patterns
  - Revenue trends

- **Operational Analytics**
  - Table utilization rates
  - Average service time
  - Order preparation time
  - **Item-level preparation time tracking**:
    - Average time from "Requested" to "Preparing"
    - Average time from "Preparing" to "Ready"
    - Average time from "Ready" to "Delivered" (waiter pickup time)
    - Total time from order to delivery per item
    - Preparation time by item category
    - Preparation time by staff member
  - **Lost items analytics**:
    - Loss rate by item/category
    - Loss reasons breakdown (quality issues, wrong orders, spills, etc.)
    - Lost cost tracking (restaurant fault losses)
    - Quality control metrics
    - Items with highest loss rates
    - Cost impact analysis
  - Staff performance metrics
  - Customer satisfaction scores

---

## üéÅ Advanced Features

### Customer Experience
- **Customer Information & Points**
  - View their own customer information (if provided ID/phone)
  - View loyalty points balance (if enrolled in loyalty program)
  - View points history (points earned/spent)
  - Cannot view past orders (order history is staff-only)
  - Cannot reorder from past orders (feature not available to customers)

- **Favorites & Preferences**
  - Customers can add menu items as favorites
  - **Customer favorites table**: `customer_favorites` table with references to customer and menu items
  - Favorites persist across visits (linked to customer record)
  - View favorite items from menu
  - Quick add favorites to cart
  - Dietary preferences storage
  - Customization presets
  - Requires customer to provide ID/phone to save favorites (favorites linked to customer record)

- **Loyalty Program**
  - **Eligibility Requirement**: Customer must opt into loyalty program during order creation
  - When opting in: Customer must provide **ID, name, and phone number** (all required)
  - Email is optional (not required for loyalty program participation)
  - Customer record is created only when they opt in
  - Points accumulation based on purchases
  - Rewards and discounts
  - Membership tiers
  - Referral program
  - Customer identification via ID or phone number for point tracking

- **Reviews & Ratings**
  - Rate items and service
  - Leave feedback
  - Photo uploads
  - Review moderation

### Reservation System
- **Table Reservations**
  - Online reservation booking
  - Table availability calendar
  - Reservation confirmation
  - Cancellation management
  - Guest preferences storage

- **Waitlist Management**
  - Add to waitlist
  - Estimated wait time
  - SMS/notification when table ready

### Promotions & Marketing
- **Promotional Campaigns**
  - **Promotion Types**:
    - `happy_hour`: Time-based promotions (apply to all orders during time window)
    - `daily_deal`: Daily specials (apply to all orders during time window)
    - `seasonal`: Seasonal promotions (apply to all orders during time window)
    - `birthday`: Customer-specific (requires date_of_birth in customer record)
    - `loyalty_reward`: Customer-specific (requires loyalty points ‚â• points_required)
  - **Recurrence Patterns**:
    - `none`: Single occurrence promotion (runs from start_date to end_date, or indefinitely)
    - `daily`: Repeats every day between from_time and to_time
    - `weekly`: Repeats on specified days of week (e.g., every Friday 3pm-4pm)
    - `monthly`: Repeats on same day of month each month
  - **Time Windows**: All promotions require `from_time` and `to_time` (e.g., 15:00-16:00 for 3pm-4pm)
  - **End Date**: Can be NULL for promotions that never end (run indefinitely)
  - **Promotion Application Logic**:
    - **Time-based promotions** (`happy_hour`, `daily_deal`, `seasonal`): 
      - Apply to ALL orders created within promotion's active time window
      - Checks start_date/end_date, from_time/to_time, and days_of_week (if weekly)
      - No customer eligibility check needed
    - **Customer-specific promotions**:
      - `loyalty_reward`: Requires customer to have loyalty_points ‚â• points_required
        - When applied: Points are deducted (negative transaction created)
        - Promotion discount is calculated and applied to order
      - `birthday`: Requires customer's date_of_birth to match current date
  - **Order Integration**:
    - Orders have `promotion_id` field (nullable) - references applied promotion
    - Orders have `promotion_discount_amount` field - stores calculated discount
    - Only one promotion can be applied per order
    - Promotions are applied at order creation time
  - **Examples**:
    - Happy Hour every Friday 3pm-4pm: `recurrence_type='weekly'`, `days_of_week=["friday"]`, `from_time='15:00'`, `to_time='16:00'`, `end_date=NULL` (never ends)
    - Daily deal for one month: `recurrence_type='daily'`, `from_time='12:00'`, `to_time='14:00'`
    - Birthday special: `promotion_type='birthday'`, applies when customer's date_of_birth matches current date

- **Push Notifications**
  - Order ready notifications
  - Promotional offers (only to eligible customers with phone/email)
  - Special event announcements
  - Loyalty program updates
  - SMS/Email notifications for promotions (requires phone/email)

### Group & Event Management
- **Group Orders**
  - Order splitting functionality (split one order into multiple orders)
  - Group order coordination
  - Shared cart functionality (if needed for future features)

- **Event Booking**
  - Private event reservations
  - Catering orders
  - Special menu customization
  - Event planning tools

### Integration Features
- **Third-Party Integrations**
  - Payment gateways (Stripe, Square, etc.)
  - POS system integration
  - Accounting software integration
  - Delivery platforms (if applicable)
  - Social media integration

- **Hardware Integration**
  - Kitchen printer integration
  - POS terminal integration
  - Barcode scanner support
  - Digital signage integration

---

## üîî Real-Time Features

### Live Updates
- **Order Status Updates**
  - Real-time order status changes (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered)
  - Push notifications when item is "Ready" (for waiters to pickup)
  - Push notifications when item is "Delivered" (for customers)
  - Notifications for lost items and replacements
  - Estimated preparation time

- **Table Status**
  - Live table availability
  - Real-time occupancy updates

- **Assistance Requests**
  - Real-time assistance request alerts
  - FIFO queue handling (first in, first out)
  - No priority levels - all requests handled in order received

### Communication
- **In-App Messaging**
  - Customer to staff messaging
  - Order clarification
  - Special requests communication

---

## üì± Mobile Features

### Mobile Optimization
- **Responsive Design**
  - Mobile-first interface
  - Tablet optimization
  - Desktop support

- **Progressive Web App (PWA)**
  - Offline menu viewing
  - Add to home screen
  - Push notifications

### Mobile-Specific Features
- **Camera Integration**
  - QR code scanning via camera
  - Photo uploads for reviews
  - Receipt scanning

- **Location Services**
  - Table location assistance
  - Nearby restaurant suggestions (if multi-location)

---

## üîí Security & Compliance

### Security Features
- **Data Protection**
  - Secure payment processing
  - PCI compliance
  - Data encryption
  - Secure session management

- **Access Control**
  - Role-based permissions
  - Staff authentication
  - Audit logging

### Compliance
- **Legal Requirements**
  - **Age verification for alcohol**: Handled by staff (human verification task)
    - Staff must verify customer age before serving alcohol
    - System does not automate age verification
    - Staff responsibility to check ID when serving alcoholic beverages
  - Tax compliance
  - Health code compliance
  - Privacy policy compliance (GDPR, etc.)

---

## üìä Business Intelligence

### Advanced Analytics
- **Predictive Analytics**
  - Demand forecasting
  - Inventory optimization
  - Staff scheduling optimization
  - Peak time predictions

### Customer Insights
- **Customer Analytics**
  - Customer behavior tracking
  - Preference analysis
  - Lifetime value calculation
  - Churn prediction

---

## üé® User Experience Enhancements

### UI/UX Features
- **Accessibility**
  - Screen reader support
  - High contrast mode
  - Font size adjustment

---

## üéØ Success Metrics

### Key Performance Indicators (KPIs)
- Order volume per table
- Average order value
- Table turnover rate
- Customer satisfaction score
- Payment processing time
- Order accuracy rate
- **Item preparation time** (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered)
- **Lost items rate** and lost cost tracking (with reason analysis)
- **Average time per status transition**
- Staff efficiency metrics
- Revenue per available table hour
- **Order cancellation rate** (items cancelled before "Preparing")
- **Karaoke queue wait time** (if karaoke feature implemented)

---

## üìù Notes

- All features should follow the microservices architecture pattern from `/Users/pvillalobos/Documents/poc/local`
- Each major feature domain should be a separate service
- Gateway service handles authentication and routing
- UI service provides customer-facing interface
- Admin panel can be part of UI service or separate admin UI service
- Real-time features may require WebSocket support or polling
- Payment processing must be PCI compliant
- Consider offline capabilities for menu viewing
- **Customer Info Caching**: 
  - When customer opts into loyalty program, add their info (ID, name, phone) to cache with **no expiration**
  - Cache key: Customer ID or Phone number
  - Cache allows instant lookup when customer returns - provides customer ID for order creation
  - Cache should be updated when customer info changes in database
  - Reduces database lookups for returning customers
- **Costa Rica Invoice Requirements**: Need to investigate and comply with:
  - Costa Rica tax regulations (Hacienda requirements)
  - Electronic invoicing (Factura Electr√≥nica) specifications
  - XML format requirements
  - Digital certificate and signature requirements
  - Integration with authorized electronic invoicing providers (if required)
  - Invoice numbering and consecutive control regulations

---

## üìã Implementation Summary

### What We're Building

A **QR code-based ordering system for bars and restaurants** that allows customers to order food and drinks directly from their phones without needing to download an app or create an account. The system enables multiple people at the same table to create separate orders, track their items in real-time, and pay independently.

### Core Functionality

**For Customers:**
- Scan a QR code at their table to access the menu
- Browse time-based menus (Breakfast, Lunch, Dinner) that automatically switch based on time
- View menu items with descriptions, prices, images, and availability status
- **Loyalty Program Opt-in**: App asks FIRST if they want to join loyalty program
  - **If YES**: Must provide ID, Name (first + last name), Phone (all required), Email (optional) ‚Üí Customer record created
  - **If NO**: Enter simple name only ‚Üí No customer record created, order proceeds with name only
- Customer data persists in database only if they opted into loyalty program
- **Order confirmation step**: Review and confirm order before submission to kitchen/bar
- Select "For Here" or "To Go" for food items (drinks don't have this option)
- Track order status in real-time (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered)
- Add items to order **only before payment is processed** (must create new order after payment)
- Can only cancel/delete items if status is "Requested" (cannot cancel once "Preparing" or beyond)
- Cannot split orders (staff-only feature to prevent unauthorized payment assignment)
- View their bill and request payment
- Pay with card, digital wallet, or cash (all waiter-assisted, with exact change calculation for cash)
- Each order can be paid independently (multiple people at table can pay separately)
- Request assistance from staff (FIFO queue, no priority levels)
- Request karaoke songs via separate QR code (name only, no ID/phone required, no persistence)
- Add menu items to favorites (requires customer ID/phone, persists across visits via customer_favorites table)
- View their own customer info and loyalty points (cannot view past orders)
- Participate in loyalty programs and receive promotions (if customer information provided)

**For Staff:**
- Manage tables (QR codes generated dynamically from table numbers)
- **Clear table sessions** after all orders are paid (marks table as available)
- View and manage menu items, prices, and availability
- **Toggle menu item availability** (boolean "Is Available" field) - kitchen staff can mark items as unavailable
- Configure 3 separate time-based menus (Breakfast, Lunch, Dinner) with time windows
- Monitor orders through Kitchen Display System (KDS) and Bar Display System (BDS)
- Update order item statuses (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered)
- **Handle lost items**: Mark items as "Lost", record reason (required), determine fault, manually add replacement items to order
- **Order splitting**: Staff-only feature to split orders (only "Requested" items can be moved)
- **Create orders for pickup customers** who come to restaurant (not dining in)
- Track preparation times for analytics
- Process payments at table (waiter-assisted for all payment methods)
- **Request notification system**: All requests (payment, assistance) stored in request-notification table with types
- **Age verification**: Staff responsibility to verify age before serving alcohol (human verification task)
- Manage karaoke song queue (first-in-first-out, cannot be reordered)
- View customer order history (staff-only, customers cannot see past orders)
- View analytics and reports including lost items cost tracking
- **Stock Item Management**: Create and manage stock items with units (gallon, bottle, unit, liter, kg, etc.)
  - **ALL items are stock items**: Raw ingredients (flour, tomatoes), finished products (bottled beer, canned soda), everything tracked in inventory
- **Supplier Management**: Track suppliers and their contact information
- **Outcome Invoice Management**: Create outcome invoices from suppliers, add invoice line items with stock item details
- **Inventory Tracking (Stock Items)**: Track stock item inventory levels, costs, and expiration dates
  - Each existence represents a purchase batch from an invoice
  - Tracks units purchased and units available (current stock)
  - Stores cost per unit for automatic menu item cost calculation
  - Stock decreases as stock items are used in menu items
  - Examples: Existence for "Bottled Beer" stock item tracks bottles in stock and their cost
- **Menu Item Cost Calculation**: 
  - **ALL menu items**: Cost automatically calculated from linked stock items using most recent existence cost_per_unit
  - Examples: Food items use multiple stock items; bottled drinks use single stock item
  - Income (profit) = selling price - item cost

**Key Features:**
- **Multi-order support**: Multiple people can order independently at the same table, each order paid separately
- **Loyalty program opt-in flow**: App asks FIRST if customer wants loyalty program ‚Üí if YES, customer provides ID, Name (first + last), Phone (required), Email (optional) and record created; if NO, customer enters simple name only and no record created
- **Customer info caching**: When customer opts into loyalty program, their info is cached with no expiration for instant lookup on return visits
- **Customer data persistence**: Customer info stored in database for loyalty tracking and notifications across visits
- **Item-level status tracking**: Each item has its own status (Requested ‚Üí Preparing ‚Üí Ready ‚Üí Delivered ‚Üí Lost) with time tracking
- **Lost items management**: Items can be marked as "Lost" with required reason, fault determination, and replacement handling
- **Order modification rules**: Can add items only before payment; can delete only if status is "Requested"
- **Order splitting**: Staff-only feature to split orders (prevents unauthorized payment assignment, only "Requested" items can be moved)
- **Order confirmation**: Customers review and confirm order before submission to kitchen/bar
- **"For Here" or "To Go"**: Food items can be marked as "For Here" or "To Go" (brought to table when ready)
- **Time-based menus**: 3 separate menus (Breakfast, Lunch, Dinner) that automatically switch based on time
- **Menu item availability**: Kitchen staff can toggle "Is Available" boolean field for real-time stock management
- **Favorites**: Customers can save favorite menu items (persists via customer_favorites table, requires customer ID/phone)
- **Promotions & Loyalty**: Optional customer information enables participation in promotions and loyalty programs
- **Customer privacy**: Customers can only view their info and points, cannot view past orders (staff-only access)
- **Karaoke integration**: Separate QR code system for song requests (name only, no persistence)
- **Assistance requests**: Simple FIFO queue (no priority levels)
- **Table session management**: Staff must clear table session after all orders are paid to mark table as available
- **Request notification system**: Backend table stores all requests (payment, assistance) with types for UI retrieval
- **Costa Rica compliance**: Electronic invoicing (Factura Electr√≥nica) support (requires research)
- **Real-time updates**: Live status updates for orders and karaoke queue
- **Print capabilities**: Print invoices and order tickets

### Technical Architecture

Built as a **microservices application** using Go, following the architecture pattern from the reference project. Services include:
- Storage service (database)
- Gateway service (authentication and routing)
- Order service
- Menu service
- Payment service
- Invoice service
- Karaoke service
- UI service (customer and admin interfaces)

All services communicate through the gateway, ensuring secure authentication and centralized routing.

---

**Last Updated:** 2024-12-19
**Status:** Planning Phase - Requirements Clarified
